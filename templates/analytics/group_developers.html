{% extends 'base/base.html' %}

{% block title %}Developer Grouping - {{ application.name }}{% endblock %}

{% block content %}
<div class="min-h-screen bg-white">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <div class="flex justify-between items-center mb-8">
            <div>
                <h1 class="text-4xl font-bold gradient-text mb-2">{{ application.name }}</h1>
                <p class="text-medium-gray text-lg">Developer Grouping</p>
            </div>
            <div class="flex space-x-4">
                <a href="{% url 'applications:detail' application.id %}" 
                   class="btn btn-outline btn-primary rounded-xl">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19l-7-7m0 0l7-7m-7 7h18"></path>
                    </svg>
                    Back to Application
                </a>
                <button onclick="groupDevelopers()" class="btn btn-primary rounded-xl">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                    </svg>
                    Re-group Developers
                </button>
            </div>
        </div>

        <!-- Grouping Results Summary -->
        <div class="card-modern p-6 mb-8">
            <h3 class="text-xl font-semibold text-dark-gray mb-4">ðŸ“Š Grouping Results</h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="text-center">
                    <p class="text-3xl font-bold text-primary-green">{{ grouping_results.total_developers }}</p>
                    <p class="text-medium-gray">Total Developers Found</p>
                </div>
                <div class="text-center">
                    <p class="text-3xl font-bold text-primary-blue">{{ grouping_results.groups_created }}</p>
                    <p class="text-medium-gray">Developer Groups Created</p>
                </div>
                <div class="text-center">
                    <p class="text-3xl font-bold text-orange-500">
                        {% if grouping_results.total_developers > 0 %}
                            {{ grouping_results.groups_created|floatformat:0 }}%
                        {% else %}
                            0%
                        {% endif %}
                    </p>
                    <p class="text-medium-gray">Grouping Efficiency</p>
                </div>
            </div>
        </div>

        <!-- Manual Grouping Section -->
        <div class="card-modern p-6 mb-8">
            <h3 class="text-xl font-semibold text-dark-gray mb-6">ðŸ”§ Manual Grouping</h3>
            <p class="text-medium-gray mb-6">If auto-detection didn't work, you can manually group developers by selecting their identities below.</p>
            
            <div class="mb-6">
                <button onclick="showManualGrouping()" class="btn bg-gradient-to-r from-purple-500 to-purple-600 text-white border-0 rounded-xl px-4 py-3 font-semibold shadow-soft hover:shadow-glow transition-all duration-300">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                    </svg>
                    Create Manual Group
                </button>
            </div>
            
            <!-- Manual Grouping Modal -->
            <div id="manual-grouping-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
                <div class="flex items-center justify-center min-h-screen p-4">
                    <div class="bg-white rounded-2xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
                        <div class="p-6 border-b border-gray-200">
                            <div class="flex items-center justify-between">
                                <h3 class="text-xl font-bold text-dark-gray">Create Manual Developer Group</h3>
                                <button onclick="hideManualGrouping()" class="btn btn-ghost btn-sm rounded-xl">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                    </svg>
                                </button>
                            </div>
                        </div>
                        
                        <div class="p-6">
                            <form id="manual-grouping-form" method="post">
                                {% csrf_token %}
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                                    <div>
                                        <label class="label">
                                            <span class="label-text font-semibold text-dark-gray">Primary Name</span>
                                        </label>
                                        <input type="text" id="primary-name" name="primary_name" 
                                               class="input input-bordered w-full rounded-xl" 
                                               placeholder="e.g., John Doe" required>
                                    </div>
                                    <div>
                                        <label class="label">
                                            <span class="label-text font-semibold text-dark-gray">Primary Email</span>
                                        </label>
                                        <input type="email" id="primary-email" name="primary_email" 
                                               class="input input-bordered w-full rounded-xl" 
                                               placeholder="e.g., john.doe@company.com" required>
                                    </div>
                                </div>
                                
                                <div class="mb-6">
                                    <label class="label">
                                        <span class="label-text font-semibold text-dark-gray">Select Developer Identities to Group</span>
                                    </label>
                                    <div class="space-y-3 max-h-96 overflow-y-auto border border-gray-200 rounded-xl p-4">
                                        {% for dev in individual_developers %}
                                        <div class="flex items-center space-x-3 p-3 bg-light-gray rounded-lg">
                                            {% if dev.is_grouped %}
                                            <input type="checkbox" name="developer_ids" value="{{ dev.name }}|{{ dev.email }}" 
                                                   class="checkbox checkbox-primary" id="dev-{{ forloop.counter }}" disabled>
                                            <label for="dev-{{ forloop.counter }}" class="flex-1 cursor-not-allowed opacity-60">
                                                <div class="flex items-center justify-between">
                                                    <div>
                                                        <p class="font-medium text-dark-gray">{{ dev.name }}</p>
                                                        <p class="text-sm text-medium-gray">{{ dev.email }}</p>
                                                    </div>
                                                    <div class="text-right">
                                                        <p class="text-sm font-medium text-primary-green">{{ dev.total_commits|default:0 }} commits</p>
                                                        <p class="text-xs text-medium-gray">
                                                            {{ dev.first_seen|date:"M Y" }} - {{ dev.last_seen|date:"M Y" }}
                                                        </p>
                                                        <span class="ml-2 px-2 py-1 bg-blue-100 text-blue-800 rounded text-xs font-semibold">Already grouped</span>
                                                    </div>
                                                </div>
                                            </label>
                                            {% else %}
                                            <input type="checkbox" name="developer_ids" value="{{ dev.name }}|{{ dev.email }}" 
                                                   class="checkbox checkbox-primary" id="dev-{{ forloop.counter }}">
                                            <label for="dev-{{ forloop.counter }}" class="flex-1 cursor-pointer">
                                                <div class="flex items-center justify-between">
                                                    <div>
                                                        <p class="font-medium text-dark-gray">{{ dev.name }}</p>
                                                        <p class="text-sm text-medium-gray">{{ dev.email }}</p>
                                                    </div>
                                                    <div class="text-right">
                                                        <p class="text-sm font-medium text-primary-green">{{ dev.total_commits|default:0 }} commits</p>
                                                        <p class="text-xs text-medium-gray">
                                                            {{ dev.first_seen|date:"M Y" }} - {{ dev.last_seen|date:"M Y" }}
                                                        </p>
                                                    </div>
                                                </div>
                                            </label>
                                            {% endif %}
                                        </div>
                                        {% endfor %}
                                    </div>
                                </div>
                                
                                <div class="flex justify-end space-x-4">
                                    <button type="button" onclick="hideManualGrouping()" 
                                            class="btn btn-outline border-gray-300 text-dark-gray hover:bg-gray-50 rounded-xl">
                                        Cancel
                                    </button>
                                    <button type="submit" 
                                            class="btn bg-gradient-to-r from-purple-500 to-purple-600 text-white border-0 rounded-xl px-6 py-3 font-semibold shadow-soft hover:shadow-glow transition-all duration-300">
                                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                                        </svg>
                                        Create Group
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Grouped Developers -->
        <div class="card-modern p-6">
            <h3 class="text-xl font-semibold text-dark-gray mb-6">ðŸ‘¥ Grouped Developers</h3>
            {% if grouped_developers %}
            <div class="space-y-6">
                {% for group in grouped_developers %}
                <div class="border border-light-gray rounded-xl p-6 group-block" data-group-id="{{ group.group_id }}">
                    <div class="flex items-center justify-between mb-4">
                        <div>
                            <div class="flex items-center space-x-2">
                                <h4 class="text-lg font-semibold text-dark-gray group-name">{{ group.primary_name }}</h4>
                                <input type="text" class="input input-bordered input-sm rounded-xl hidden group-name-input" value="{{ group.primary_name }}" style="width: 180px;">
                                <span class="text-medium-gray group-email">{{ group.primary_email }}</span>
                                <input type="email" class="input input-bordered input-sm rounded-xl hidden group-email-input" value="{{ group.primary_email }}" style="width: 220px;">
                            </div>
                        </div>
                        <div class="flex items-center space-x-2">
                            <button class="btn btn-xs btn-outline border-primary-blue text-primary-blue edit-group-btn" title="Edit group">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                            </button>
                            <button class="btn btn-xs btn-outline border-red-300 text-red-500 delete-group-btn" title="Delete group">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                            </button>
                            <button class="btn btn-xs btn-primary save-group-btn hidden" title="Save changes">Save</button>
                            <button class="btn btn-xs btn-ghost cancel-group-btn hidden" title="Cancel">Cancel</button>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <h5 class="font-medium text-dark-gray mb-2">ðŸ‘¤ All Identities ({{ group.aliases|length }})</h5>
                            <div class="space-y-2">
                                {% for alias in group.aliases %}
                                <div class="flex items-center justify-between p-3 bg-light-gray rounded-lg">
                                    <div>
                                        <p class="font-medium text-dark-gray">{{ alias.name }}</p>
                                        <p class="text-sm text-medium-gray">{{ alias.email }}</p>
                                    </div>
                                    <div class="text-right">
                                        <p class="text-sm font-medium text-primary-green">{{ alias.total_commits|default:0 }} commits</p>
                                        <p class="text-xs text-medium-gray">
                                            {{ alias.first_seen|date:"M Y" }} - {{ alias.last_seen|date:"M Y" }}
                                        </p>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        
                        <div>
                            <h5 class="font-medium text-dark-gray mb-2">ðŸ“ˆ Activity Timeline</h5>
                            <div class="space-y-2">
                                {% for alias in group.aliases|slice:":5" %}
                                <div class="flex items-center space-x-3">
                                    <div class="w-3 h-3 bg-primary-green rounded-full"></div>
                                    <div class="flex-1">
                                        <p class="text-sm font-medium">{{ alias.name }}</p>
                                        <p class="text-xs text-medium-gray">
                                            {{ alias.first_seen|date:"M Y" }} - {{ alias.last_seen|date:"M Y" }}
                                        </p>
                                    </div>
                                </div>
                                {% endfor %}
                                {% if group.aliases|length > 5 %}
                                <p class="text-xs text-medium-gray">... and {{ group.aliases|length|add:"-5" }} more identities</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="text-center py-8">
                <p class="text-medium-gray">No grouped developers found. Try running the grouping process.</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
function groupDevelopers() {
    const button = event.target;
    const originalText = button.innerHTML;
    
    // Show loading state
    button.innerHTML = `
        <svg class="animate-spin w-5 h-5 mr-2" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        Grouping...
    `;
    button.disabled = true;
    
    // Make API call
    fetch(`{% url 'analytics:api_group_developers' application.id %}`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'Content-Type': 'application/json',
        },
    })
    .then(response => response.json())
    .then(data => {
        // Reload page to show updated results
        window.location.reload();
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error grouping developers. Please try again.');
        
        // Restore button
        button.innerHTML = originalText;
        button.disabled = false;
    });
}

function showManualGrouping() {
    document.getElementById('manual-grouping-modal').classList.remove('hidden');
}

function hideManualGrouping() {
    document.getElementById('manual-grouping-modal').classList.add('hidden');
}

// Enhanced error handling for manual grouping form
function isJsonResponse(response) {
    const contentType = response.headers.get('content-type');
    return contentType && contentType.indexOf('application/json') !== -1;
}

// Handle manual grouping form submission
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('manual-grouping-form');
    if (form) {
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(form);
            const selectedDevelopers = formData.getAll('developer_ids');
            
            if (selectedDevelopers.length < 2) {
                alert('Please select at least 2 developer identities to group.');
                return;
            }
            
            const groupData = {
                primary_name: formData.get('primary_name'),
                primary_email: formData.get('primary_email'),
                developer_ids: selectedDevelopers
            };
            
            // Show loading state
            const submitBtn = form.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = `
                <svg class="animate-spin w-5 h-5 mr-2" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                Creating Group...
            `;
            submitBtn.disabled = true;
            
            // Make API call
            fetch(`{% url 'analytics:api_manual_group_developers' application.id %}`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(groupData)
            })
            .then(async response => {
                if (!response.ok) {
                    let errorText = 'Unknown error';
                    if (isJsonResponse(response)) {
                        const data = await response.json();
                        errorText = data.error || errorText;
                    } else {
                        errorText = await response.text();
                    }
                    alert('Error creating group: ' + errorText);
                    submitBtn.innerHTML = originalText;
                    submitBtn.disabled = false;
                    return;
                }
                const data = await response.json();
                if (data.success) {
                    window.location.reload();
                } else {
                    alert('Error creating group: ' + (data.error || 'Unknown error'));
                    submitBtn.innerHTML = originalText;
                    submitBtn.disabled = false;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error creating group. Please try again.');
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            });
        });
    }
    
    // Close modal on backdrop click
    const modal = document.getElementById('manual-grouping-modal');
    if (modal) {
        modal.addEventListener('click', function(e) {
            if (e.target === modal) {
                hideManualGrouping();
            }
        });
    }

    // Inline edit/delete for groups
    document.querySelectorAll('.edit-group-btn').forEach(function(btn) {
        btn.addEventListener('click', function(e) {
            const block = btn.closest('.group-block');
            block.querySelector('.group-name').classList.add('hidden');
            block.querySelector('.group-email').classList.add('hidden');
            block.querySelector('.group-name-input').classList.remove('hidden');
            block.querySelector('.group-email-input').classList.remove('hidden');
            block.querySelector('.save-group-btn').classList.remove('hidden');
            block.querySelector('.cancel-group-btn').classList.remove('hidden');
            btn.classList.add('hidden');
            block.querySelector('.delete-group-btn').classList.add('hidden');
        });
    });
    document.querySelectorAll('.cancel-group-btn').forEach(function(btn) {
        btn.addEventListener('click', function(e) {
            const block = btn.closest('.group-block');
            block.querySelector('.group-name').classList.remove('hidden');
            block.querySelector('.group-email').classList.remove('hidden');
            block.querySelector('.group-name-input').classList.add('hidden');
            block.querySelector('.group-email-input').classList.add('hidden');
            block.querySelector('.save-group-btn').classList.add('hidden');
            btn.classList.add('hidden');
            block.querySelector('.edit-group-btn').classList.remove('hidden');
            block.querySelector('.delete-group-btn').classList.remove('hidden');
        });
    });
    document.querySelectorAll('.save-group-btn').forEach(function(btn) {
        btn.addEventListener('click', function(e) {
            const block = btn.closest('.group-block');
            const groupId = block.getAttribute('data-group-id');
            const nameInput = block.querySelector('.group-name-input');
            const emailInput = block.querySelector('.group-email-input');
            const newName = nameInput.value.trim();
            const newEmail = emailInput.value.trim();
            btn.disabled = true;
            fetch(`/analytics/application/{{ application.id }}/group/${groupId}/rename/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest',
                },
                body: JSON.stringify({ primary_name: newName, primary_email: newEmail })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    block.querySelector('.group-name').textContent = data.primary_name;
                    block.querySelector('.group-email').textContent = data.primary_email;
                    block.querySelector('.group-name').classList.remove('hidden');
                    block.querySelector('.group-email').classList.remove('hidden');
                    block.querySelector('.group-name-input').classList.add('hidden');
                    block.querySelector('.group-email-input').classList.add('hidden');
                    block.querySelector('.save-group-btn').classList.add('hidden');
                    block.querySelector('.cancel-group-btn').classList.add('hidden');
                    block.querySelector('.edit-group-btn').classList.remove('hidden');
                    block.querySelector('.delete-group-btn').classList.remove('hidden');
                } else {
                    alert('Error renaming group: ' + (data.error || 'Unknown error'));
                }
                btn.disabled = false;
            })
            .catch(error => {
                alert('Error renaming group.');
                btn.disabled = false;
            });
        });
    });
    document.querySelectorAll('.delete-group-btn').forEach(function(btn) {
        btn.addEventListener('click', function(e) {
            if (!confirm('Are you sure you want to delete this group? This cannot be undone.')) return;
            const block = btn.closest('.group-block');
            const groupId = block.getAttribute('data-group-id');
            btn.disabled = true;
            fetch(`/analytics/application/{{ application.id }}/group/${groupId}/delete/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    'X-Requested-With': 'XMLHttpRequest',
                },
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    block.remove();
                } else {
                    alert('Error deleting group: ' + (data.error || 'Unknown error'));
                }
                btn.disabled = false;
            })
            .catch(error => {
                alert('Error deleting group.');
                btn.disabled = false;
            });
        });
    });
});
</script>
{% endblock %} 