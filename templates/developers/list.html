{% extends "base/base.html" %}
{% load static %}

{% block title %}Developers - GitPulse{% endblock title %}

{% block content %}
{% csrf_token %}
<div class="container mx-auto px-4 py-8">
    <!-- Header -->
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900 mb-2">Developers</h1>
        <p class="text-gray-600">Manage and view all developers in the system</p>
    </div>

    <!-- Tabs -->
    <div class="mb-6">
        <div class="tabs tabs-boxed">
            <a 
                href="?tab=developers{% if search_query %}&search={{ search_query }}{% endif %}" 
                class="tab {% if active_tab == 'developers' %}tab-active{% endif %}"
            >
                Developers
            </a>
            <a 
                href="?tab=aliases{% if search_query %}&search={{ search_query }}{% endif %}" 
                class="tab {% if active_tab == 'aliases' %}tab-active{% endif %}"
            >
                Aliases
            </a>
        </div>
    </div>

    <!-- Merge Actions (only for developers tab) -->
    {% if active_tab == 'developers' %}
    <div id="mergeActions" class="hidden fixed bottom-4 left-1/2 transform -translate-x-1/2 z-50">
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 shadow-lg">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <span class="text-blue-800 font-medium">
                        <span id="selectedCount">0</span> developer(s) selected
                    </span>
                    <button 
                        id="mergeButton"
                        class="btn btn-primary btn-sm"
                        onclick="showMergeModal()"
                    >
                        Merge Selected Developers
                    </button>
                </div>
                <button 
                    onclick="clearSelection()"
                    class="text-blue-600 hover:text-blue-800 text-sm"
                >
                    Clear Selection
                </button>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Create Developer Actions (only for aliases tab) -->
    {% if active_tab == 'aliases' %}
    <div id="createDeveloperActions" class="hidden fixed bottom-4 left-1/2 transform -translate-x-1/2 z-50">
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 shadow-lg">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <span class="text-blue-800 font-medium">
                        <span id="selectedAliasCount">0</span> alias(es) selected
                    </span>
                    <button 
                        id="createDeveloperButton"
                        class="btn btn-primary btn-sm"
                        onclick="showCreateDeveloperModal()"
                    >
                        Create or Add Developer
                    </button>
                </div>
                <button 
                    onclick="clearAliasSelection()"
                    class="text-blue-600 hover:text-blue-800 text-sm"
                >
                    Clear Selection
                </button>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Inline Search Bar -->
    <div class="mb-6">
        <div class="relative">
            <input 
                type="text" 
                id="searchInput"
                placeholder="{% if active_tab == 'developers' %}Search developers by name or email...{% else %}Search aliases by name or email...{% endif %}"
                value="{{ search_query }}"
                class="w-full px-4 py-3 pl-12 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200"
            >
            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                </svg>
            </div>
            <div id="searchSpinner" class="absolute inset-y-0 right-0 pr-3 flex items-center hidden">
                <svg class="animate-spin h-5 w-5 text-blue-500" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
            </div>
        </div>
    </div>

    <!-- Results Info -->
    <div class="mb-6">
        <p id="resultsInfo" class="text-gray-600">
            {% if active_tab == 'developers' %}
                Showing <span id="totalCount">{{ total_count }}</span> developer<span id="pluralSuffix">{{ total_count|pluralize }}</span> in total
            {% else %}
                Showing <span id="totalCount">{{ total_count }}</span> alias<span id="pluralSuffix">{{ total_count|pluralize }}</span> in total
            {% endif %}
        </p>
    </div>

    <!-- Content based on active tab -->
    {% if active_tab == 'developers' %}
        <!-- Developers List -->
        <div class="bg-white rounded-lg shadow">
            <div id="developersTable" class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                <input 
                                    type="checkbox" 
                                    id="selectAll"
                                    class="rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                                    onchange="toggleSelectAll(this)"
                                >
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Name
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Email
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Aliases
                            </th>
                        </tr>
                    </thead>
                    <tbody id="developersTableBody" class="bg-white divide-y divide-gray-200">
                        {% for developer in developers %}
                            <tr class="hover:bg-gray-50">
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <input 
                                        type="checkbox" 
                                        class="developer-checkbox rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                                        value="{{ developer.id }}"
                                        onchange="updateSelection()"
                                    >
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <a 
                                        href="{% url 'developers:detail' developer.id %}" 
                                        class="text-blue-600 hover:text-blue-800 font-medium"
                                    >
                                        {{ developer.primary_name|default:"Unknown" }}
                                    </a>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                    {{ developer.primary_email|default:"No email" }}
                                </td>
                                <td class="px-6 py-4 text-sm text-gray-900">
                                    {% if developer.aliases_list %}
                                        {{ developer.aliases_list|join:", " }}
                                    {% else %}
                                        <span class="text-gray-400">No aliases</span>
                                    {% endif %}
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
            <!-- Empty State -->
            <div id="emptyState" class="text-center py-12 hidden">
                <div class="text-gray-400 mb-4">
                    <svg class="mx-auto h-12 w-12" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z" />
                    </svg>
                </div>
                <h3 class="text-lg font-medium text-gray-900 mb-2">
                    No developers found
                </h3>
                <p class="text-gray-500">
                    Try adjusting your search terms
                </p>
            </div>
        </div>
    {% else %}
        <!-- Aliases List -->
        <div class="bg-white rounded-lg shadow">
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                <input 
                                    type="checkbox" 
                                    id="selectAllAliases"
                                    class="rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                                    onchange="toggleSelectAllAliases(this)"
                                >
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Name
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Email
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Source
                            </th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        {% for alias in aliases %}
                            <tr class="hover:bg-gray-50">
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <input 
                                        type="checkbox" 
                                        class="alias-checkbox rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                                        value="{{ forloop.counter0 }}"
                                        data-name="{{ alias.name }}"
                                        data-email="{{ alias.email }}"
                                        data-source="{{ alias.source }}"
                                        onchange="updateAliasSelection()"
                                    >
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="flex items-center space-x-2">
                                        <span class="text-gray-900 font-medium">
                                            {{ alias.name }}
                                        </span>
                                        <button 
                                            onclick="debugIdentity('{{ alias.name }}', '{{ alias.email }}')"
                                            class="text-xs text-blue-600 hover:text-blue-800"
                                            title="Debug this identity"
                                        >
                                            üîç
                                        </button>
                                    </div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                    {{ alias.email }}
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium
                                        {% if alias.source == 'Commit' %}bg-green-100 text-green-800
                                        {% elif alias.source == 'Release' %}bg-blue-100 text-blue-800
                                        {% elif alias.source == 'Deployment' %}bg-purple-100 text-purple-800
                                        {% else %}bg-orange-100 text-orange-800{% endif %}">
                                        {{ alias.source }}
                                    </span>
                                </td>
                            </tr>
                        {% empty %}
                            <tr>
                                <td colspan="3" class="px-6 py-12 text-center">
                                    <div class="text-gray-400 mb-4">
                                        <svg class="mx-auto h-12 w-12" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z" />
                                        </svg>
                                    </div>
                                    <h3 class="text-lg font-medium text-gray-900 mb-2">
                                        No aliases found
                                    </h3>
                                    <p class="text-gray-500">
                                        Try adjusting your search terms
                                    </p>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    {% endif %}
</div>

<!-- Merge Modal (only for developers tab) -->
{% if active_tab == 'developers' %}
<dialog id="mergeModal" class="modal">
    <div class="modal-box">
        <h3 class="font-bold text-lg mb-4">Merge Developers</h3>
        <p class="text-gray-600 mb-4">
            Select the primary developer that will remain. The other selected developers will be converted to aliases and linked to the primary developer.
        </p>
        
        <div id="mergeOptions" class="space-y-3 mb-6">
            <!-- Options will be populated by JavaScript -->
        </div>
        
        <div class="modal-action">
            <button class="btn btn-outline" onclick="closeMergeModal()">Cancel</button>
            <button class="btn btn-primary" onclick="performMerge()">Merge Developers</button>
        </div>
    </div>
    <form method="dialog" class="modal-backdrop">
        <button onclick="closeMergeModal()">close</button>
    </form>
</dialog>
{% endif %}

<!-- Create Developer Modal (only for aliases tab) -->
{% if active_tab == 'aliases' %}
<dialog id="createDeveloperModal" class="modal">
    <div class="modal-box">
        <h3 class="font-bold text-lg mb-4">Create or Add Developer</h3>
        <p class="text-gray-600 mb-4">
            Search for an existing developer or create a new one. The selected aliases will be added as aliases to this developer.
        </p>
        
                <div class="mb-6">
            <label class="label">
                <span class="label-text">Developer Name</span>
            </label>
            <div class="relative">
                <input 
                    type="text" 
                    id="developerSearchInput"
                    placeholder="Search existing developers or enter a new name..."
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                >
                <div id="developerSearchResults" class="absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg hidden max-h-60 overflow-y-auto">
                    <!-- Search results will be populated here -->
                </div>
            </div>
        </div>
        
        <div class="mb-6">
            <label class="label">
                <span class="label-text">Primary Email (select one)</span>
            </label>
            <div id="primaryEmailOptions" class="space-y-2 max-h-40 overflow-y-auto">
                <!-- Primary email options will be populated here -->
            </div>
        </div>
        
        <div class="mb-6">
            <label class="label">
                <span class="label-text">Selected Aliases</span>
            </label>
            <div id="selectedAliasesList" class="space-y-2 max-h-40 overflow-y-auto">
                <!-- Selected aliases will be shown here -->
            </div>
        </div>
        
                    <div class="modal-action">
                <button class="btn btn-outline" onclick="closeCreateDeveloperModal()">Cancel</button>
                <button class="btn btn-primary" onclick="performCreateDeveloper()">Create Developer</button>
            </div>
    </div>
    <form method="dialog" class="modal-backdrop">
        <button onclick="closeCreateDeveloperModal()">close</button>
    </form>
</dialog>
{% endif %}

<script>
let selectedDevelopers = [];

document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('searchInput');
    const searchSpinner = document.getElementById('searchSpinner');
    const developersTable = document.getElementById('developersTable');
    const developersTableBody = document.getElementById('developersTableBody');
    const emptyState = document.getElementById('emptyState');
    const resultsInfo = document.getElementById('resultsInfo');
    const totalCount = document.getElementById('totalCount');
    const pluralSuffix = document.getElementById('pluralSuffix');
    
    // Only initialize search functionality for developers tab
    {% if active_tab == 'developers' %}
    let searchTimeout;
    
    searchInput.addEventListener('input', function() {
        const query = this.value.trim();
        
        // Clear previous timeout
        clearTimeout(searchTimeout);
        
        // Show spinner
        searchSpinner.classList.remove('hidden');
        
        // Set timeout to avoid too many requests
        searchTimeout = setTimeout(() => {
            performSearch(query);
        }, 300);
    });
    
    function performSearch(query) {
        const url = new URL('{% url "developers:search_ajax" %}', window.location.origin);
        if (query) {
            url.searchParams.set('q', query);
        }
        
        fetch(url)
            .then(response => {
                if (!response.ok) {
                    if (response.status === 401) {
                        // Redirect to login if not authenticated
                        window.location.href = '/users/login/?next=' + encodeURIComponent(window.location.pathname);
                        return;
                    }
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data && !data.error) {
                    updateResults(data);
                } else {
                    console.error('Search error:', data.error);
                }
            })
            .catch(error => {
                console.error('Search error:', error);
                // Show error state or fallback to original content
                searchSpinner.classList.add('hidden');
            })
            .finally(() => {
                searchSpinner.classList.add('hidden');
            });
    }
    
    function updateResults(data) {
        const developers = data.developers;
        const totalCount = data.total_count;
        const searchQuery = data.search_query;
        
        // Update results info
        document.getElementById('totalCount').textContent = totalCount;
        document.getElementById('pluralSuffix').textContent = totalCount === 1 ? '' : 's';
        
        if (searchQuery) {
            resultsInfo.innerHTML = `Found <span id="totalCount">${totalCount}</span> developer<span id="pluralSuffix">${totalCount === 1 ? '' : 's'}</span> matching "${searchQuery}"`;
        } else {
            resultsInfo.innerHTML = `Showing <span id="totalCount">${totalCount}</span> developer<span id="pluralSuffix">${totalCount === 1 ? '' : 's'}</span> in total`;
        }
        
        // Update table or show empty state
        if (developers.length > 0) {
            developersTable.classList.remove('hidden');
            emptyState.classList.add('hidden');
            
            // Clear existing rows
            developersTableBody.innerHTML = '';
            
            // Add new rows
            developers.forEach(developer => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">
                        <input 
                            type="checkbox" 
                            class="developer-checkbox rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                            value="${developer.id}"
                            onchange="updateSelection()"
                        >
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <a href="${developer.detail_url}" class="text-blue-600 hover:text-blue-800 font-medium">
                            ${developer.name}
                        </a>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        ${developer.email}
                    </td>
                    <td class="px-6 py-4 text-sm text-gray-900">
                        ${developer.aliases}
                    </td>
                `;
                
                developersTableBody.appendChild(row);
            });
        } else {
            developersTable.classList.add('hidden');
            emptyState.classList.remove('hidden');
        }
    }
    {% else %}
    // For aliases tab, handle search by form submission
    searchInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            const query = this.value.trim();
            const currentUrl = new URL(window.location);
            if (query) {
                currentUrl.searchParams.set('search', query);
            } else {
                currentUrl.searchParams.delete('search');
            }
            currentUrl.searchParams.set('tab', 'aliases');
            window.location.href = currentUrl.toString();
        }
    });
    {% endif %}
});

// Global variables for aliases functionality
let selectedAliases = [];
let aliasesData = [
    {% for alias in aliases %}
    {
        index: {{ forloop.counter0 }},
        name: "{{ alias.name }}",
        email: "{{ alias.email }}",
        source: "{{ alias.source }}"
    },
    {% endfor %}
];

{% if active_tab == 'aliases' %}
function updateAliasSelection() {
    const checkboxes = document.querySelectorAll('.alias-checkbox:checked');
    selectedAliases = Array.from(checkboxes).map(cb => cb.value);
    
    const createDeveloperActions = document.getElementById('createDeveloperActions');
    const selectedAliasCount = document.getElementById('selectedAliasCount');
    
    if (selectedAliases.length > 0) {
        createDeveloperActions.classList.remove('hidden');
        selectedAliasCount.textContent = selectedAliases.length;
    } else {
        createDeveloperActions.classList.add('hidden');
    }
}

function toggleSelectAllAliases(checkbox) {
    const aliasCheckboxes = document.querySelectorAll('.alias-checkbox');
    aliasCheckboxes.forEach(cb => {
        cb.checked = checkbox.checked;
    });
    updateAliasSelection();
}

function clearAliasSelection() {
    const checkboxes = document.querySelectorAll('.alias-checkbox');
    checkboxes.forEach(cb => {
        cb.checked = false;
    });
    document.getElementById('selectAllAliases').checked = false;
    updateAliasSelection();
}

function showCreateDeveloperModal() {
    if (selectedAliases.length === 0) {
        alert('Please select at least one alias to create a developer.');
        return;
    }
    
    // Populate selected aliases list
    const selectedAliasesList = document.getElementById('selectedAliasesList');
    selectedAliasesList.innerHTML = '';
    
    selectedAliases.forEach(index => {
        const alias = aliasesData[index];
        const div = document.createElement('div');
        div.className = 'flex items-center justify-between p-2 bg-gray-50 rounded';
        div.innerHTML = `
            <div>
                <div class="font-medium">${alias.name}</div>
                <div class="text-sm text-gray-500">${alias.email}</div>
            </div>
            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium
                ${alias.source === 'Commit' ? 'bg-green-100 text-green-800' :
                  alias.source === 'Release' ? 'bg-blue-100 text-blue-800' :
                  alias.source === 'Deployment' ? 'bg-purple-100 text-purple-800' :
                  'bg-orange-100 text-orange-800'}">
                ${alias.source}
            </span>
        `;
        selectedAliasesList.appendChild(div);
    });
    
    // Setup developer search functionality
    const developerSearchInput = document.getElementById('developerSearchInput');
    const developerSearchResults = document.getElementById('developerSearchResults');
    let searchTimeout;
    
    developerSearchInput.addEventListener('input', function() {
        const query = this.value.trim();
        
        // Clear previous timeout
        clearTimeout(searchTimeout);
        
        // Hide results if query is empty
        if (!query) {
            developerSearchResults.classList.add('hidden');
            return;
        }
        
        // Set timeout to avoid too many requests
        searchTimeout = setTimeout(() => {
            searchExistingDevelopers(query);
        }, 300);
    });
    
    // Hide results when clicking outside
    document.addEventListener('click', function(e) {
        if (!developerSearchInput.contains(e.target) && !developerSearchResults.contains(e.target)) {
            developerSearchResults.classList.add('hidden');
        }
    });
    
    // Populate primary email options
    const primaryEmailOptions = document.getElementById('primaryEmailOptions');
    primaryEmailOptions.innerHTML = '';
    
    // Get unique emails from selected aliases
    const uniqueEmails = new Set();
    selectedAliases.forEach(index => {
        const alias = aliasesData[index];
        if (alias.email && !alias.email.startsWith('No email')) {
            uniqueEmails.add(alias.email);
        }
    });
    
    // Add email options
    uniqueEmails.forEach(email => {
        const div = document.createElement('div');
        div.className = 'flex items-center space-x-3 p-3 border rounded-lg';
        div.innerHTML = `
            <input 
                type="radio" 
                name="primaryEmail" 
                value="${email}"
                id="email_${email.replace(/[^a-zA-Z0-9]/g, '_')}"
                class="radio radio-primary"
                ${Array.from(uniqueEmails)[0] === email ? 'checked' : ''}
            >
            <label for="email_${email.replace(/[^a-zA-Z0-9]/g, '_')}" class="flex-1 cursor-pointer">
                <div class="font-medium">${email}</div>
            </label>
        `;
        primaryEmailOptions.appendChild(div);
    });
    
    // If no real emails, add a placeholder option
    if (uniqueEmails.size === 0) {
        const div = document.createElement('div');
        div.className = 'flex items-center space-x-3 p-3 border rounded-lg';
        div.innerHTML = `
            <input 
                type="radio" 
                name="primaryEmail" 
                value=""
                id="email_none"
                class="radio radio-primary"
                checked
            >
            <label for="email_none" class="flex-1 cursor-pointer">
                <div class="font-medium text-gray-500">No email available</div>
            </label>
        `;
        primaryEmailOptions.appendChild(div);
    }
    
    // Show modal
    const modal = document.getElementById('createDeveloperModal');
    modal.showModal();
}

function searchExistingDevelopers(query) {
    const developerSearchResults = document.getElementById('developerSearchResults');
    
    // Use the existing search endpoint
    const url = new URL('{% url "developers:search_ajax" %}', window.location.origin);
    url.searchParams.set('q', query);
    
    fetch(url)
        .then(response => {
            if (!response.ok) {
                if (response.status === 401) {
                    window.location.href = '/users/login/?next=' + encodeURIComponent(window.location.pathname);
                    return;
                }
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data && !data.error) {
                displayDeveloperSearchResults(data.developers, query);
            } else {
                console.error('Search error:', data.error);
            }
        })
        .catch(error => {
            console.error('Search error:', error);
        });
}

function displayDeveloperSearchResults(developers, query) {
    const developerSearchResults = document.getElementById('developerSearchResults');
    const developerSearchInput = document.getElementById('developerSearchInput');
    
    if (developers.length === 0) {
        developerSearchResults.classList.add('hidden');
        return;
    }
    
    // Clear previous results
    developerSearchResults.innerHTML = '';
    
    // Add results
    developers.forEach(developer => {
        const div = document.createElement('div');
        div.className = 'p-3 hover:bg-gray-50 cursor-pointer border-b border-gray-100 last:border-b-0';
        div.innerHTML = `
            <div class="font-medium text-blue-600">${developer.name}</div>
            <div class="text-sm text-gray-500">${developer.email}</div>
            <div class="text-xs text-gray-400">${developer.aliases}</div>
        `;
        
        div.addEventListener('click', function() {
            developerSearchInput.value = developer.name;
            developerSearchResults.classList.add('hidden');
            
            // Show warning that this developer already exists
            const warningDiv = document.createElement('div');
            warningDiv.className = 'mt-2 p-2 bg-yellow-50 border border-yellow-200 rounded text-yellow-800 text-sm';
            warningDiv.innerHTML = `
                <strong>Warning:</strong> Developer "${developer.name}" already exists. 
                The selected aliases will be added to this existing developer.
            `;
            
            // Remove any existing warning
            const existingWarning = document.querySelector('.developer-warning');
            if (existingWarning) {
                existingWarning.remove();
            }
            
            warningDiv.classList.add('developer-warning');
            developerSearchInput.parentNode.appendChild(warningDiv);
        });
        
        developerSearchResults.appendChild(div);
    });
    
    developerSearchResults.classList.remove('hidden');
}

function debugIdentity(name, email) {
    const url = new URL('{% url "developers:debug_identity" %}', window.location.origin);
    url.searchParams.set('name', name);
    url.searchParams.set('email', email);
    
    fetch(url)
        .then(response => response.json())
        .then(data => {
            console.log('Debug info for identity:', data);
            
            let message = `Debug info for "${name}":\n\n`;
            message += `Found in collections:\n`;
            message += `- Commits: ${data.found_in_collections.commits}\n`;
            message += `- Releases: ${data.found_in_collections.releases}\n`;
            message += `- Deployments: ${data.found_in_collections.deployments}\n`;
            message += `- Pull Requests: ${data.found_in_collections.pull_requests}\n\n`;
            
            if (data.existing_developer.exists) {
                message += `‚ö†Ô∏è Developer already exists:\n`;
                message += `- Name: ${data.existing_developer.name}\n`;
                message += `- Email: ${data.existing_developer.email}\n\n`;
            }
            
            if (data.existing_alias.exists) {
                message += `‚ö†Ô∏è Alias already exists:\n`;
                message += `- Name: ${data.existing_alias.name}\n`;
                message += `- Email: ${data.existing_alias.email}\n`;
                message += `- Developer ID: ${data.existing_alias.developer}\n\n`;
            }
            
            if (data.email_matches.length > 0) {
                message += `‚ö†Ô∏è Email matches:\n`;
                data.email_matches.forEach(match => {
                    message += `- ${match.name} (${match.email}) -> Developer ${match.developer}\n`;
                });
            }
            
            alert(message);
        })
        .catch(error => {
            console.error('Debug error:', error);
            alert('Error getting debug info');
        });
}

function closeCreateDeveloperModal() {
    const modal = document.getElementById('createDeveloperModal');
    modal.close();
}

function performCreateDeveloper() {
    const developerName = document.getElementById('developerSearchInput').value.trim();
    const primaryEmail = document.querySelector('input[name="primaryEmail"]:checked').value;
    
    if (!developerName) {
        alert('Please enter a developer name.');
        return;
    }
    
    // Check if this is an existing developer
    const existingWarning = document.querySelector('.developer-warning');
    const isExistingDeveloper = existingWarning !== null;
    
    // Get CSRF token
    let csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
    if (!csrfToken) {
        const cookies = document.cookie.split(';');
        for (let cookie of cookies) {
            const [name, value] = cookie.trim().split('=');
            if (name === 'csrftoken') {
                csrfToken = { value: value };
                break;
            }
        }
    }
    
    if (!csrfToken) {
        console.error('CSRF token not found');
        alert('Security token not found. Please refresh the page and try again.');
        return;
    }
    
    // Prepare data
    const selectedAliasesData = selectedAliases.map(index => aliasesData[index]);
    
    console.log('Sending create developer request with:', {
        developer_name: developerName,
        primary_email: primaryEmail,
        aliases: selectedAliasesData,
        is_existing: isExistingDeveloper,
        csrf_token: csrfToken.value
    });
    
    // Send request
    fetch('{% url "developers:create_from_aliases" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken.value,
        },
        body: JSON.stringify({
            developer_name: developerName,
            primary_email: primaryEmail,
            aliases: selectedAliasesData,
            is_existing: isExistingDeveloper
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            closeCreateDeveloperModal();
            clearAliasSelection();
            // Reload page to show updated data
            window.location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Create developer error:', error);
        alert('An error occurred while creating the developer.');
    });
}
{% endif %}

{% if active_tab == 'developers' %}
function updateSelection() {
    const checkboxes = document.querySelectorAll('.developer-checkbox:checked');
    selectedDevelopers = Array.from(checkboxes).map(cb => cb.value);
    
    const mergeActions = document.getElementById('mergeActions');
    const selectedCount = document.getElementById('selectedCount');
    
    if (selectedDevelopers.length > 1) {
        mergeActions.classList.remove('hidden');
        selectedCount.textContent = selectedDevelopers.length;
    } else {
        mergeActions.classList.add('hidden');
    }
}

function toggleSelectAll(checkbox) {
    const developerCheckboxes = document.querySelectorAll('.developer-checkbox');
    developerCheckboxes.forEach(cb => {
        cb.checked = checkbox.checked;
    });
    updateSelection();
}

function clearSelection() {
    const checkboxes = document.querySelectorAll('.developer-checkbox');
    checkboxes.forEach(cb => {
        cb.checked = false;
    });
    document.getElementById('selectAll').checked = false;
    updateSelection();
}

function showMergeModal() {
    if (selectedDevelopers.length < 2) {
        alert('Please select at least 2 developers to merge.');
        return;
    }
    
    // Get developer data for selected developers
    const developerData = [];
    selectedDevelopers.forEach(id => {
        const row = document.querySelector(`input[value="${id}"]`).closest('tr');
        const name = row.querySelector('a').textContent.trim();
        const email = row.querySelector('td:nth-child(3)').textContent.trim();
        developerData.push({ id, name, email });
    });
    
    // Populate modal options
    const mergeOptions = document.getElementById('mergeOptions');
    mergeOptions.innerHTML = '';
    
    developerData.forEach(developer => {
        const option = document.createElement('div');
        option.className = 'flex items-center space-x-3 p-3 border rounded-lg';
        option.innerHTML = `
            <input 
                type="radio" 
                name="primaryDeveloper" 
                value="${developer.id}"
                id="primary_${developer.id}"
                class="radio radio-primary"
                ${developerData.indexOf(developer) === 0 ? 'checked' : ''}
            >
            <label for="primary_${developer.id}" class="flex-1 cursor-pointer">
                <div class="font-medium">${developer.name}</div>
                <div class="text-sm text-gray-500">${developer.email}</div>
            </label>
        `;
        mergeOptions.appendChild(option);
    });
    
    // Show modal using DaisyUI method
    const modal = document.getElementById('mergeModal');
    modal.showModal();
}

function closeMergeModal() {
    const modal = document.getElementById('mergeModal');
    modal.close();
}

function performMerge() {
    const primaryDeveloperId = document.querySelector('input[name="primaryDeveloper"]:checked').value;
    const otherDeveloperIds = selectedDevelopers.filter(id => id !== primaryDeveloperId);
    
    // Get CSRF token
    let csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
    if (!csrfToken) {
        // Fallback: try to get from cookies
        const cookies = document.cookie.split(';');
        for (let cookie of cookies) {
            const [name, value] = cookie.trim().split('=');
            if (name === 'csrftoken') {
                csrfToken = { value: value };
                break;
            }
        }
    }
    
    if (!csrfToken) {
        console.error('CSRF token not found');
        alert('Security token not found. Please refresh the page and try again.');
        return;
    }
    
    console.log('Sending merge request with:', {
        primary_developer_id: primaryDeveloperId,
        other_developer_ids: otherDeveloperIds,
        csrf_token: csrfToken.value
    });
    
    // Send merge request
    fetch('{% url "developers:merge" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken.value,
        },
        body: JSON.stringify({
            primary_developer_id: primaryDeveloperId,
            other_developer_ids: otherDeveloperIds
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            closeMergeModal();
            clearSelection();
            // Reload page to show updated data
            window.location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Merge error:', error);
        alert('An error occurred while merging developers.');
    });
}
{% endif %}
</script>
{% endblock content %} 