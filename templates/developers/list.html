{% extends 'base/base.html' %}

{% block title %}Developers - GitPulse{% endblock %}

{% block content %}
<!-- CSRF Token for AJAX requests -->
{% csrf_token %}

<div class="container mx-auto px-4 py-8">
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-2xl font-bold text-dark-gray">Developers</h1>
        <div class="flex space-x-2">
            <button onclick="openCreateGroupModal()" 
                    class="btn bg-gradient-to-r from-primary-green to-primary-blue text-white border-0 rounded-xl px-4 py-2 font-semibold shadow-soft hover:shadow-glow transition-all duration-300">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                </svg>
                Create Group
            </button>
            <button onclick="autoGroupDevelopers()" 
                    class="btn bg-gradient-to-r from-primary-green to-primary-blue text-white border-0 rounded-xl px-4 py-2 font-semibold shadow-soft hover:shadow-glow transition-all duration-300">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                </svg>
                Auto-Group Developers
            </button>
            <a href="{% url 'developers:sync' %}" class="btn bg-gradient-to-r from-primary-green to-primary-blue text-white border-0 rounded-xl px-4 py-2 font-semibold shadow-soft hover:shadow-glow transition-all duration-300">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                </svg>
                Sync Data
            </a>
        </div>
    </div>

    <!-- Stats Summary -->
    <div class="stats shadow mb-6">
        <div class="stat">
            <div class="stat-title">Total Developers</div>
            <div class="stat-value text-primary">{{ total_count }}</div>
        </div>
        <div class="stat">
            <div class="stat-title">Grouped</div>
            <div class="stat-value text-success">{{ grouped_count }}</div>
        </div>
        <div class="stat">
            <div class="stat-title">Individual</div>
            <div class="stat-value text-info">{{ ungrouped_count }}</div>
        </div>
        <div class="stat">
            <div class="stat-title">Search</div>
            <div class="stat-value">
                <input type="text" id="searchInput" value="{{ search_term }}" placeholder="Search developers..." 
                       class="input input-bordered input-sm w-full max-w-xs" />
            </div>
        </div>
    </div>

    <!-- Developer List -->
    <div class="card bg-base-100 shadow-xl">
        <div class="card-body">
            <h2 class="card-title">All Developers</h2>
            
            {% if page_obj %}
                <div class="overflow-x-auto">
                    <table class="table table-zebra">
                        <thead>
                            <tr>
                                <th>
                                    <a href="?sort=name&order={% if sort_by == 'name' and sort_order == 'asc' %}desc{% else %}asc{% endif %}" 
                                       class="flex items-center space-x-1 hover:text-primary">
                                        <span>Name</span>
                                        {% if sort_by == 'name' %}
                                            {% if sort_order == 'asc' %}
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"></path>
                                                </svg>
                                            {% else %}
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                                </svg>
                                            {% endif %}
                                        {% endif %}
                                    </a>
                                </th>
                                <th>
                                    <a href="?sort=email&order={% if sort_by == 'email' and sort_order == 'asc' %}desc{% else %}asc{% endif %}" 
                                       class="flex items-center space-x-1 hover:text-primary">
                                        <span>Email</span>
                                        {% if sort_by == 'email' %}
                                            {% if sort_order == 'asc' %}
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"></path>
                                                </svg>
                                            {% else %}
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                                </svg>
                                            {% endif %}
                                        {% endif %}
                                    </a>
                                </th>
                                <th>
                                    <a href="?sort=first_seen&order={% if sort_by == 'first_seen' and sort_order == 'asc' %}desc{% else %}asc{% endif %}" 
                                       class="flex items-center space-x-1 hover:text-primary">
                                        <span>First Seen</span>
                                        {% if sort_by == 'first_seen' %}
                                            {% if sort_order == 'asc' %}
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"></path>
                                                </svg>
                                            {% else %}
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                                </svg>
                                            {% endif %}
                                        {% endif %}
                                    </a>
                                </th>
                                <th>
                                    <a href="?sort=last_seen&order={% if sort_by == 'last_seen' and sort_order == 'asc' %}desc{% else %}asc{% endif %}" 
                                       class="flex items-center space-x-1 hover:text-primary">
                                        <span>Last Seen</span>
                                        {% if sort_by == 'last_seen' %}
                                            {% if sort_order == 'asc' %}
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"></path>
                                                </svg>
                                            {% else %}
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                                </svg>
                                            {% endif %}
                                        {% endif %}
                                    </a>
                                </th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for developer in page_obj %}
                                <tr class="hover">
                                    <td>
                                        <div class="flex items-center space-x-2">
                                            {% if developer.group_id %}
                                                <a href="{% url 'developers:detail' developer.group_id %}" 
                                                   class="font-medium text-primary-blue hover:text-primary-green transition-colors duration-300">
                                                    {{ developer.name }}
                                                </a>
                                            {% else %}
                                                <span class="font-medium text-gray-500">{{ developer.name }}</span>
                                            {% endif %}
                                            {% if developer.is_grouped %}
                                                <span class="badge badge-success">Grouped</span>
                                            {% endif %}
                                        </div>
                                    </td>
                                    <td>{{ developer.email }}</td>
                                    <td>{{ developer.first_seen|date:"M d, Y" }}</td>
                                    <td>{{ developer.last_seen|date:"M d, Y" }}</td>
                                    <td>
                                        <div class="flex space-x-2">
                                            {% if developer.group_id %}
                                                {% if developer.is_grouped %}
                                                    <button class="btn bg-gradient-to-r from-primary-green to-primary-blue text-white border-0 rounded-lg px-3 py-1 text-xs font-semibold shadow-soft hover:shadow-glow transition-all duration-300"
                                                            onclick="openMergeGroupsModalForGroup('{{ developer.name|escapejs }}', '{{ developer.email|escapejs }}', '{{ developer.group_id|escapejs }}')">
                                                        Merge Group
                                                    </button>
                                                {% else %}
                                                    <button class="btn bg-gradient-to-r from-primary-green to-primary-blue text-white border-0 rounded-lg px-3 py-1 text-xs font-semibold shadow-soft hover:shadow-glow transition-all duration-300"
                                                            onclick="openAddToGroupModal('{{ developer.name|escapejs }}', '{{ developer.email|escapejs }}')">
                                                        Add to Group
                                                    </button>
                                                {% endif %}
                                            {% else %}
                                                <span class="text-xs text-gray-500">No ID</span>
                                            {% endif %}
                                        </div>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <!-- Pagination -->
                {% if page_obj.has_other_pages %}
                    <div class="flex justify-center mt-6">
                        <div class="join">
                            {% if page_obj.has_previous %}
                                <a href="?page={{ page_obj.previous_page_number }}{% if sort_by %}&sort={{ sort_by }}{% endif %}{% if sort_order %}&order={{ sort_order }}{% endif %}{% if search_term %}&search={{ search_term }}{% endif %}" class="join-item btn">«</a>
                            {% endif %}
                            
                            <span class="join-item btn btn-disabled">
                                Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
                            </span>
                            
                            {% if page_obj.has_next %}
                                <a href="?page={{ page_obj.next_page_number }}{% if sort_by %}&sort={{ sort_by }}{% endif %}{% if sort_order %}&order={{ sort_order }}{% endif %}{% if search_term %}&search={{ search_term }}{% endif %}" class="join-item btn">»</a>
                            {% endif %}
                        </div>
                    </div>
                {% endif %}
            {% else %}
                <div class="text-center py-8">
                    <p class="text-gray-500">No developers found.</p>
                    <a href="{% url 'developers:sync' %}" class="btn btn-primary mt-4">
                        Extract from Commits
                    </a>
                </div>
            {% endif %}
        </div>
    </div>
</div>


<!-- Nouvelle modale DaisyUI pour ajout à un groupe existant -->
<input type="checkbox" id="addToGroupModal" class="modal-toggle" />
<div class="modal" id="addToGroupModalContainer">
  <div class="modal-box w-11/12 max-w-4xl" style="height: 600px;">
    <h3 class="font-bold text-lg mb-2">Add to Existing Group</h3>
    <form id="addToGroupForm" class="space-y-4">
      <div>
        <span class="font-semibold">Name:</span>
        <span id="modalDevName"></span>
      </div>
      <div>
        <span class="font-semibold">Email:</span>
        <span id="modalDevEmail"></span>
      </div>
      <div>
        <label class="label" for="groupSelect">Existing Group</label>
        <div class="relative">
          <input type="text" id="groupSelect" placeholder="Start typing to search..." 
                 class="input input-bordered w-full" required autocomplete="off" />
          <div id="groupDropdown" class="absolute z-50 w-full bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-y-auto hidden">
            <!-- Options will be populated here -->
          </div>
        </div>
      </div>
      <div class="modal-action">
        <button type="submit" class="btn btn-primary">Add</button>
        <label for="addToGroupModal" class="btn">Cancel</label>
      </div>
    </form>
  </div>
</div>

<!-- Modale pour fusionner des groupes -->
<input type="checkbox" id="mergeGroupsModal" class="modal-toggle" />
<div class="modal" id="mergeGroupsModalContainer">
  <div class="modal-box w-11/12 max-w-4xl" style="height: 600px;">
    <h3 class="font-bold text-lg mb-2">Merge Group</h3>
    <form id="mergeGroupsForm" class="space-y-4">
      <div>
        <label class="label">Source Group (will be deleted)</label>
        <div class="input input-bordered w-full bg-gray-100" id="sourceGroupDisplay">
          Loading...
        </div>
        <input type="hidden" id="sourceGroupId" name="source_group_id">
      </div>
      <div>
        <label class="label" for="targetGroupSelect">Destination Group (will receive identities)</label>
        <div class="relative">
          <input type="text" id="targetGroupSelect" placeholder="Start typing to search..." 
                 class="input input-bordered w-full" required autocomplete="off" />
          <div id="targetGroupDropdown" class="absolute z-50 w-full bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-y-auto hidden">
            <!-- Options will be populated here -->
          </div>
        </div>
      </div>
      <div class="modal-action">
        <button type="submit" class="btn btn-warning">Merge</button>
        <label for="mergeGroupsModal" class="btn">Cancel</label>
      </div>
    </form>
  </div>
</div>

<!-- Modale pour créer un nouveau groupe -->
<input type="checkbox" id="createGroupModal" class="modal-toggle" />
<div class="modal" id="createGroupModalModalContainer">
  <div class="modal-box w-11/12 max-w-4xl" style="height: 600px;">
    <h3 class="font-bold text-lg mb-2">Create New Group</h3>
    <form id="createGroupForm" class="space-y-4">
      <div>
        <label class="label" for="newGroupName">Group Name</label>
        <input type="text" id="newGroupName" class="input input-bordered w-full" required>
      </div>
      <div>
        <label class="label" for="newGroupEmail">Group Email</label>
        <input type="email" id="newGroupEmail" class="input input-bordered w-full" required>
      </div>
      <div class="modal-action">
        <button type="submit" class="btn btn-primary">Create Group</button>
        <label for="createGroupModal" class="btn">Cancel</label>
      </div>
    </form>
  </div>
</div>


<script>
function openAddToGroupModal(name, email) {
  document.getElementById('modalDevName').textContent = name;
  document.getElementById('modalDevEmail').textContent = email;
  document.getElementById('addToGroupModal').checked = true;
  
  // Reset search input
  const groupInput = document.getElementById('groupSelect');
  const groupDropdown = document.getElementById('groupDropdown');
  groupInput.value = '';
  groupInput.selectedGroupId = '';
  
  // Afficher un message de chargement
  groupInput.placeholder = 'Chargement...';
  
  fetch('/developers/list_groups/')
    .then(res => {
      if (!res.ok) {
        throw new Error(`HTTP error! status: ${res.status}`);
      }
      return res.text().then(text => {
        try {
          return JSON.parse(text);
        } catch (parseError) {
          console.error('JSON parse error:', parseError);
          console.error('Response text:', text);
          throw new Error('Invalid JSON response');
        }
      });
    })
    .then(data => {
      if (data.error) {
        groupInput.placeholder = 'Error: ' + data.error;
        return;
      }
      
      if (!data.groups || data.groups.length === 0) {
        groupInput.placeholder = 'No groups available';
        return;
      }
      
      // Trier les groupes par nom (ordre alphabétique, insensible à la casse)
      const sortedGroups = data.groups.slice().sort((a, b) => {
        const nameA = (a.name || '').toLowerCase();
        const nameB = (b.name || '').toLowerCase();
        return nameA.localeCompare(nameB);
      });
      
      // Store all groups for filtering
      groupInput.allGroups = sortedGroups;
      groupInput.placeholder = 'Start typing to search...';
    })
    .catch(error => {
      console.error('Error loading groups:', error);
      groupInput.placeholder = 'Loading error';
    });
}

document.getElementById('addToGroupForm').addEventListener('submit', function(e) {
  e.preventDefault();
  const groupInput = document.getElementById('groupSelect');
  const groupId = groupInput.selectedGroupId;
  const name = document.getElementById('modalDevName').textContent;
  const email = document.getElementById('modalDevEmail').textContent;
  
  if (!groupId) {
    alert('Veuillez sélectionner un groupe');
    return;
  }
  
  fetch('/developers/add_identity_to_group/', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
    },
    body: JSON.stringify({ group_id: groupId, name: name, email: email })
  })
  .then(res => res.json())
  .then(resp => {
    if (resp.success) {
      document.getElementById('addToGroupModal').checked = false;
      window.location.reload();
    } else {
      alert('Error: ' + (resp.error || 'Unknown'));
    }
  })
  .catch(() => alert('Network error'));
});

function autoGroupDevelopers() {
    const button = event.target;
    const originalText = button.innerHTML;
    
    // Show loading state
    button.innerHTML = `
        <svg class="animate-spin w-4 h-4 mr-2" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        Auto-Grouping...
    `;
    button.disabled = true;
    
    // Make API call to auto-group developers
    fetch('/analytics/api/applications/0/auto-group-developers/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'Content-Type': 'application/json',
        },
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Show success message
            alert(`Auto-grouping completed! Created ${data.groups_created} groups.`);
            // Reload page to show updated results
            window.location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error auto-grouping developers. Please try again.');
    })
    .finally(() => {
        // Restore button
        button.innerHTML = originalText;
        button.disabled = false;
    });
}

function mergeExistingGroups() {
    const button = event.target;
    const originalText = button.innerHTML;
    
    // Show loading state
    button.innerHTML = `
        <svg class="animate-spin w-4 h-4 mr-2" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        Merging Groups...
    `;
    button.disabled = true;
    
    // Make API call to merge existing groups
    fetch('/analytics/api/applications/0/merge-existing-groups/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'Content-Type': 'application/json',
        },
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Show success message
            alert(`Group merging completed! Merged ${data.groups_merged} groups.`);
            // Reload page to show updated results
            window.location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error merging groups. Please try again.');
    })
    .finally(() => {
        // Restore button
        button.innerHTML = originalText;
        button.disabled = false;
    });
}

function openMergeGroupsModal() {
  // Fermer la modale actuelle
  document.getElementById('addToGroupModal').checked = false;
  
  // Ouvrir la modale de fusion
  document.getElementById('mergeGroupsModal').checked = true;
  
  // Charger les groupes dans les deux select
  loadGroupsForMerge();
}

function openMergeGroupsModalForGroup(name, email, groupId) {
  // Ouvrir la modale de fusion
  document.getElementById('mergeGroupsModal').checked = true;
  
  // Reset search input
  const targetGroupInput = document.getElementById('targetGroupSelect');
  if (targetGroupInput) {
    targetGroupInput.value = '';
    targetGroupInput.selectedGroupId = '';
  }
  
  // Afficher le groupe source
  document.getElementById('sourceGroupDisplay').textContent = `${name} (${email})`;
  document.getElementById('sourceGroupId').value = groupId; // Set the hidden input
  
  // Charger les groupes de destination (en excluant le groupe source)
  loadTargetGroupsForMerge();
}

function openCreateGroupModal() {
  // Reset form fields
  document.getElementById('newGroupName').value = '';
  document.getElementById('newGroupEmail').value = '';
  
  // Open the modal
  document.getElementById('createGroupModal').checked = true;
}

// Search functionality with debounce and AJAX
let searchTimeout;
document.addEventListener('DOMContentLoaded', function() {
  const searchInput = document.getElementById('searchInput');
  const tableBody = document.querySelector('tbody');
  const statsContainer = document.querySelector('.stats');
  
  searchInput.addEventListener('input', function() {
    clearTimeout(searchTimeout);
    
    searchTimeout = setTimeout(() => {
      const searchTerm = this.value.trim();
      
      // Show loading state
      if (tableBody) {
        tableBody.innerHTML = '<tr><td colspan="5" class="text-center py-4"><div class="loading loading-spinner loading-md"></div></td></tr>';
      }
      
      // Build AJAX URL
      const params = new URLSearchParams();
      if (searchTerm) {
        params.set('q', searchTerm);
      }
      params.set('sort', '{{ sort_by }}');
      params.set('order', '{{ sort_order }}');
      
      // Fetch results via AJAX
      fetch(`/developers/search/?${params.toString()}`)
        .then(response => response.json())
        .then(data => {
          // Update table body
          if (tableBody) {
            let tableHTML = '';
            if (data.developers.length === 0) {
              tableHTML = '<tr><td colspan="5" class="text-center py-4 text-gray-500">No developers found.</td></tr>';
            } else {
              data.developers.forEach(dev => {
                const nameCell = dev.is_grouped 
                  ? `<a href="/developers/${dev.group_id}/" class="font-medium text-primary-blue hover:text-primary-green transition-colors duration-300">${dev.name}</a>`
                  : `<span class="font-medium text-gray-500">${dev.name}</span>`;
                
                const badge = dev.is_grouped ? '<span class="badge badge-success">Grouped</span>' : '';
                
                const actionsCell = dev.group_id 
                  ? `<button class="btn bg-gradient-to-r from-primary-green to-primary-blue text-white border-0 rounded-lg px-3 py-1 text-xs font-semibold shadow-soft hover:shadow-glow transition-all duration-300" onclick="openAddToGroupModal('${dev.name.replace(/'/g, "\\'")}', '${dev.email.replace(/'/g, "\\'")}')">Add to Group</button>`
                  : '<span class="text-xs text-gray-500">No ID</span>';
                
                tableHTML += `
                  <tr class="hover">
                    <td>
                      <div class="flex items-center space-x-2">
                        ${nameCell}
                        ${badge}
                      </div>
                    </td>
                    <td>${dev.email}</td>
                    <td>${dev.first_seen}</td>
                    <td>${dev.last_seen}</td>
                    <td>
                      <div class="flex space-x-2">
                        ${actionsCell}
                      </div>
                    </td>
                  </tr>
                `;
              });
            }
            tableBody.innerHTML = tableHTML;
          }
          
          // Update stats
          if (statsContainer) {
            const totalStat = statsContainer.querySelector('.stat:nth-child(1) .stat-value');
            const groupedStat = statsContainer.querySelector('.stat:nth-child(2) .stat-value');
            const individualStat = statsContainer.querySelector('.stat:nth-child(3) .stat-value');
            
            if (totalStat) totalStat.textContent = data.total_count;
            if (groupedStat) groupedStat.textContent = data.grouped_count;
            if (individualStat) individualStat.textContent = data.ungrouped_count;
          }
        })
        .catch(error => {
          console.error('Search error:', error);
          if (tableBody) {
            tableBody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-error">Error loading results</td></tr>';
          }
        });
    }, 500); // 500ms delay
  });
});

// Search functionality for group selectboxes with dropdown
document.addEventListener('DOMContentLoaded', function() {
  // Add to group modal search
  const groupInput = document.getElementById('groupSelect');
  const groupDropdown = document.getElementById('groupDropdown');
  
  if (groupInput) {
    groupInput.addEventListener('input', function() {
      const searchTerm = this.value.toLowerCase().trim();
      
      if (!this.allGroups) return;
      
      const filteredGroups = this.allGroups.filter(group => {
        const name = (group.name || '').toLowerCase();
        const email = (group.email || '').toLowerCase();
        return name.includes(searchTerm) || email.includes(searchTerm);
      });
      
      // Show/hide dropdown
      if (searchTerm && filteredGroups.length > 0) {
        groupDropdown.innerHTML = '';
        filteredGroups.forEach(group => {
          const option = document.createElement('div');
          option.className = 'px-4 py-2 hover:bg-gray-100 cursor-pointer';
          option.textContent = `${group.name} (${group.email})`;
          option.dataset.value = group.id;
          option.dataset.name = group.name;
          option.dataset.email = group.email;
          
          option.addEventListener('click', function() {
            groupInput.value = `${group.name} (${group.email})`;
            groupInput.selectedGroupId = group.id;
            groupDropdown.classList.add('hidden');
          });
          
          groupDropdown.appendChild(option);
        });
        groupDropdown.classList.remove('hidden');
      } else {
        groupDropdown.classList.add('hidden');
      }
    });
    
    // Hide dropdown when clicking outside
    document.addEventListener('click', function(e) {
      if (!groupInput.contains(e.target) && !groupDropdown.contains(e.target)) {
        groupDropdown.classList.add('hidden');
      }
    });
  }
  
  // Merge groups modal search
  const targetGroupInput = document.getElementById('targetGroupSelect');
  const targetGroupDropdown = document.getElementById('targetGroupDropdown');
  
  if (targetGroupInput) {
    targetGroupInput.addEventListener('input', function() {
      const searchTerm = this.value.toLowerCase().trim();
      
      if (!this.allGroups) return;
      
      const filteredGroups = this.allGroups.filter(group => {
        const name = (group.name || '').toLowerCase();
        const email = (group.email || '').toLowerCase();
        return name.includes(searchTerm) || email.includes(searchTerm);
      });
      
      // Show/hide dropdown
      if (searchTerm && filteredGroups.length > 0) {
        targetGroupDropdown.innerHTML = '';
        filteredGroups.forEach(group => {
          const option = document.createElement('div');
          option.className = 'px-4 py-2 hover:bg-gray-100 cursor-pointer';
          option.textContent = `${group.name} (${group.email})`;
          option.dataset.value = group.id;
          option.dataset.name = group.name;
          option.dataset.email = group.email;
          
          option.addEventListener('click', function() {
            targetGroupInput.value = `${group.name} (${group.email})`;
            targetGroupInput.selectedGroupId = group.id;
            targetGroupDropdown.classList.add('hidden');
          });
          
          targetGroupDropdown.appendChild(option);
        });
        targetGroupDropdown.classList.remove('hidden');
      } else {
        targetGroupDropdown.classList.add('hidden');
      }
    });
    
    // Hide dropdown when clicking outside
    document.addEventListener('click', function(e) {
      if (!targetGroupInput.contains(e.target) && !targetGroupDropdown.contains(e.target)) {
        targetGroupDropdown.classList.add('hidden');
      }
    });
  }
});

function loadTargetGroupsForMerge() {
  const targetInput = document.getElementById('targetGroupSelect');
  const sourceGroupId = document.getElementById('sourceGroupId').value;
  
  targetInput.value = '';
  targetInput.selectedGroupId = '';
  targetInput.placeholder = 'Chargement...';
  
  fetch('/developers/list_groups/')
    .then(res => {
      if (!res.ok) {
        throw new Error(`HTTP error! status: ${res.status}`);
      }
      return res.text().then(text => {
        try {
          return JSON.parse(text);
        } catch (parseError) {
          console.error('JSON parse error:', parseError);
          console.error('Response text:', text);
          throw new Error('Invalid JSON response');
        }
      });
    })
    .then(data => {
      if (data.error) {
        targetInput.placeholder = 'Error: ' + data.error;
        return;
      }
      
      if (!data.groups || data.groups.length === 0) {
        targetInput.placeholder = 'No groups available';
        return;
      }
      
      // Trier les groupes par nom (ordre alphabétique, insensible à la casse)
      const sortedGroups = data.groups.slice().sort((a, b) => {
        const nameA = (a.name || '').toLowerCase();
        const nameB = (b.name || '').toLowerCase();
        return nameA.localeCompare(nameB);
      });
      
      // Store all groups for filtering (excluding source group)
      targetInput.allGroups = sortedGroups.filter(group => group.id !== sourceGroupId);
      targetInput.placeholder = 'Start typing to search...';
    })
    .catch(error => {
      console.error('Error loading groups:', error);
      targetInput.placeholder = 'Loading error';
    });
}

// Gestionnaire pour le formulaire de fusion
document.getElementById('mergeGroupsForm').addEventListener('submit', function(e) {
  e.preventDefault();
  
  const sourceGroupId = document.getElementById('sourceGroupId').value;
  const targetGroupInput = document.getElementById('targetGroupSelect');
  const targetGroupId = targetGroupInput.selectedGroupId;
  
  if (!sourceGroupId || !targetGroupId) {
    alert('Please select a destination group');
    return;
  }
  
  if (sourceGroupId === targetGroupId) {
    alert('The destination group must be different from the source group');
    return;
  }
  
  // Confirmation before merge
  if (!confirm('Are you sure you want to merge this group? It will be deleted after the merge.')) {
    return;
  }
  
  // Afficher l'état de chargement
  const submitBtn = e.target.querySelector('button[type="submit"]');
  const originalText = submitBtn.innerHTML;
  submitBtn.innerHTML = 'Fusion en cours...';
  submitBtn.disabled = true;
  
  fetch('/developers/merge_group/', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
    },
    body: JSON.stringify({
      source_group_id: sourceGroupId,
      target_group_id: targetGroupId
    })
  })
  .then(res => res.json())
  .then(data => {
    if (data.success) {
      document.getElementById('mergeGroupsModal').checked = false;
      window.location.reload();
    } else {
      alert('Error: ' + (data.error || 'Unknown'));
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('Network error during merge');
  })
  .finally(() => {
    submitBtn.innerHTML = originalText;
    submitBtn.disabled = false;
  });
});

// Gestionnaire pour le formulaire de création de groupe
document.getElementById('createGroupForm').addEventListener('submit', function(e) {
  e.preventDefault();
  
  const name = document.getElementById('newGroupName').value.trim();
  const email = document.getElementById('newGroupEmail').value.trim();
  
  if (!name || !email) {
    alert('Please fill in both name and email fields');
    return;
  }
  
  // Show loading state
  const submitBtn = e.target.querySelector('button[type="submit"]');
  const originalText = submitBtn.innerHTML;
  submitBtn.innerHTML = 'Creating...';
  submitBtn.disabled = true;
  
  fetch('/developers/create-group/', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
    },
    body: JSON.stringify({
      name: name,
      email: email
    })
  })
  .then(res => res.json())
  .then(data => {
    if (data.success) {
      document.getElementById('createGroupModal').checked = false;
      window.location.reload();
    } else {
      alert('Error: ' + (data.error || 'Unknown error'));
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('Network error while creating group');
  })
  .finally(() => {
    submitBtn.innerHTML = originalText;
    submitBtn.disabled = false;
  });
});
</script>
{% endblock %} 