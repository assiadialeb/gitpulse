{% extends 'base/base.html' %}
{% load static %}

{% block title %}Developers - GitPulse{% endblock %}

{% block content %}
{% csrf_token %}
<div class="container mx-auto px-4 py-8">
    <!-- Header -->
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900 mb-2">Developers</h1>
        <p class="text-gray-600">Manage and view all developers in the system</p>
    </div>

    <!-- Merge Actions -->
    <div id="mergeActions" class="mb-6 hidden">
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <span class="text-blue-800 font-medium">
                        <span id="selectedCount">0</span> developer(s) selected
                    </span>
                    <button 
                        id="mergeButton"
                        class="btn btn-primary btn-sm"
                        onclick="showMergeModal()"
                    >
                        Merge Selected Developers
                    </button>
                </div>
                <button 
                    onclick="clearSelection()"
                    class="text-blue-600 hover:text-blue-800 text-sm"
                >
                    Clear Selection
                </button>
            </div>
        </div>
    </div>

    <!-- Inline Search Bar -->
    <div class="mb-6">
        <div class="relative">
            <input 
                type="text" 
                id="searchInput"
                placeholder="Search developers by name or email..."
                class="w-full px-4 py-3 pl-12 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200"
            >
            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                </svg>
            </div>
            <div id="searchSpinner" class="absolute inset-y-0 right-0 pr-3 flex items-center hidden">
                <svg class="animate-spin h-5 w-5 text-blue-500" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
            </div>
        </div>
    </div>

    <!-- Results Info -->
    <div class="mb-6">
        <p id="resultsInfo" class="text-gray-600">
            Showing <span id="totalCount">{{ total_count }}</span> developer<span id="pluralSuffix">{{ total_count|pluralize }}</span> in total
        </p>
    </div>

    <!-- Developers List -->
    <div class="bg-white rounded-lg shadow">
        <div id="developersTable" class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            <input 
                                type="checkbox" 
                                id="selectAll"
                                class="rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                                onchange="toggleSelectAll(this)"
                            >
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Name
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Email
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            GitHub ID
                        </th>
                    </tr>
                </thead>
                <tbody id="developersTableBody" class="bg-white divide-y divide-gray-200">
                    {% for developer in developers %}
                        <tr class="hover:bg-gray-50">
                            <td class="px-6 py-4 whitespace-nowrap">
                                <input 
                                    type="checkbox" 
                                    class="developer-checkbox rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                                    value="{{ developer.id }}"
                                    onchange="updateSelection()"
                                >
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <a 
                                    href="{% url 'developers:detail' developer.id %}" 
                                    class="text-blue-600 hover:text-blue-800 font-medium"
                                >
                                    {{ developer.primary_name|default:"Unknown" }}
                                </a>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                {{ developer.primary_email|default:"No email" }}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                {{ developer.github_id|default:"â€”" }}
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <!-- Empty State -->
        <div id="emptyState" class="text-center py-12 hidden">
            <div class="text-gray-400 mb-4">
                <svg class="mx-auto h-12 w-12" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z" />
                </svg>
            </div>
            <h3 class="text-lg font-medium text-gray-900 mb-2">
                No developers found
            </h3>
            <p class="text-gray-500">
                Try adjusting your search terms
            </p>
        </div>
    </div>
</div>

<!-- Merge Modal -->
<dialog id="mergeModal" class="modal">
    <div class="modal-box">
        <h3 class="font-bold text-lg mb-4">Merge Developers</h3>
        <p class="text-gray-600 mb-4">
            Select the primary developer that will remain. The other selected developers will be converted to aliases and linked to the primary developer.
        </p>
        
        <div id="mergeOptions" class="space-y-3 mb-6">
            <!-- Options will be populated by JavaScript -->
        </div>
        
        <div class="modal-action">
            <button class="btn btn-outline" onclick="closeMergeModal()">Cancel</button>
            <button class="btn btn-primary" onclick="performMerge()">Merge Developers</button>
        </div>
    </div>
    <form method="dialog" class="modal-backdrop">
        <button onclick="closeMergeModal()">close</button>
    </form>
</dialog>

<script>
let selectedDevelopers = [];

document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('searchInput');
    const searchSpinner = document.getElementById('searchSpinner');
    const developersTable = document.getElementById('developersTable');
    const developersTableBody = document.getElementById('developersTableBody');
    const emptyState = document.getElementById('emptyState');
    const resultsInfo = document.getElementById('resultsInfo');
    const totalCount = document.getElementById('totalCount');
    const pluralSuffix = document.getElementById('pluralSuffix');
    
    let searchTimeout;
    
    searchInput.addEventListener('input', function() {
        const query = this.value.trim();
        
        // Clear previous timeout
        clearTimeout(searchTimeout);
        
        // Show spinner
        searchSpinner.classList.remove('hidden');
        
        // Set timeout to avoid too many requests
        searchTimeout = setTimeout(() => {
            performSearch(query);
        }, 300);
    });
    
    function performSearch(query) {
        const url = new URL('{% url "developers:search_ajax" %}', window.location.origin);
        if (query) {
            url.searchParams.set('q', query);
        }
        
        fetch(url)
            .then(response => {
                if (!response.ok) {
                    if (response.status === 401) {
                        // Redirect to login if not authenticated
                        window.location.href = '/users/login/?next=' + encodeURIComponent(window.location.pathname);
                        return;
                    }
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data && !data.error) {
                    updateResults(data);
                } else {
                    console.error('Search error:', data.error);
                }
            })
            .catch(error => {
                console.error('Search error:', error);
                // Show error state or fallback to original content
                searchSpinner.classList.add('hidden');
            })
            .finally(() => {
                searchSpinner.classList.add('hidden');
            });
    }
    
    function updateResults(data) {
        const developers = data.developers;
        const totalCount = data.total_count;
        const searchQuery = data.search_query;
        
        // Update results info
        document.getElementById('totalCount').textContent = totalCount;
        document.getElementById('pluralSuffix').textContent = totalCount === 1 ? '' : 's';
        
        if (searchQuery) {
            resultsInfo.innerHTML = `Found <span id="totalCount">${totalCount}</span> developer<span id="pluralSuffix">${totalCount === 1 ? '' : 's'}</span> matching "${searchQuery}"`;
        } else {
            resultsInfo.innerHTML = `Showing <span id="totalCount">${totalCount}</span> developer<span id="pluralSuffix">${totalCount === 1 ? '' : 's'}</span> in total`;
        }
        
        // Update table or show empty state
        if (developers.length > 0) {
            developersTable.classList.remove('hidden');
            emptyState.classList.add('hidden');
            
            // Clear existing rows
            developersTableBody.innerHTML = '';
            
            // Add new rows
            developers.forEach(developer => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">
                        <input 
                            type="checkbox" 
                            class="developer-checkbox rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                            value="${developer.id}"
                            onchange="updateSelection()"
                        >
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <a href="${developer.detail_url}" class="text-blue-600 hover:text-blue-800 font-medium">
                            ${developer.name}
                        </a>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        ${developer.email}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        ${developer.github_id}
                    </td>
                `;
                
                developersTableBody.appendChild(row);
            });
        } else {
            developersTable.classList.add('hidden');
            emptyState.classList.remove('hidden');
        }
    }
});

function updateSelection() {
    const checkboxes = document.querySelectorAll('.developer-checkbox:checked');
    selectedDevelopers = Array.from(checkboxes).map(cb => cb.value);
    
    const mergeActions = document.getElementById('mergeActions');
    const selectedCount = document.getElementById('selectedCount');
    
    if (selectedDevelopers.length > 1) {
        mergeActions.classList.remove('hidden');
        selectedCount.textContent = selectedDevelopers.length;
    } else {
        mergeActions.classList.add('hidden');
    }
}

function toggleSelectAll(checkbox) {
    const developerCheckboxes = document.querySelectorAll('.developer-checkbox');
    developerCheckboxes.forEach(cb => {
        cb.checked = checkbox.checked;
    });
    updateSelection();
}

function clearSelection() {
    const checkboxes = document.querySelectorAll('.developer-checkbox');
    checkboxes.forEach(cb => {
        cb.checked = false;
    });
    document.getElementById('selectAll').checked = false;
    updateSelection();
}

function showMergeModal() {
    if (selectedDevelopers.length < 2) {
        alert('Please select at least 2 developers to merge.');
        return;
    }
    
    // Get developer data for selected developers
    const developerData = [];
    selectedDevelopers.forEach(id => {
        const row = document.querySelector(`input[value="${id}"]`).closest('tr');
        const name = row.querySelector('a').textContent.trim();
        const email = row.querySelector('td:nth-child(3)').textContent.trim();
        developerData.push({ id, name, email });
    });
    
    // Populate modal options
    const mergeOptions = document.getElementById('mergeOptions');
    mergeOptions.innerHTML = '';
    
    developerData.forEach(developer => {
        const option = document.createElement('div');
        option.className = 'flex items-center space-x-3 p-3 border rounded-lg';
        option.innerHTML = `
            <input 
                type="radio" 
                name="primaryDeveloper" 
                value="${developer.id}"
                id="primary_${developer.id}"
                class="radio radio-primary"
                ${developerData.indexOf(developer) === 0 ? 'checked' : ''}
            >
            <label for="primary_${developer.id}" class="flex-1 cursor-pointer">
                <div class="font-medium">${developer.name}</div>
                <div class="text-sm text-gray-500">${developer.email}</div>
            </label>
        `;
        mergeOptions.appendChild(option);
    });
    
    // Show modal using DaisyUI method
    const modal = document.getElementById('mergeModal');
    modal.showModal();
}

function closeMergeModal() {
    const modal = document.getElementById('mergeModal');
    modal.close();
}

function performMerge() {
    const primaryDeveloperId = document.querySelector('input[name="primaryDeveloper"]:checked').value;
    const otherDeveloperIds = selectedDevelopers.filter(id => id !== primaryDeveloperId);
    
    // Get CSRF token
    let csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
    if (!csrfToken) {
        // Fallback: try to get from cookies
        const cookies = document.cookie.split(';');
        for (let cookie of cookies) {
            const [name, value] = cookie.trim().split('=');
            if (name === 'csrftoken') {
                csrfToken = { value: value };
                break;
            }
        }
    }
    
    if (!csrfToken) {
        console.error('CSRF token not found');
        alert('Security token not found. Please refresh the page and try again.');
        return;
    }
    
    console.log('Sending merge request with:', {
        primary_developer_id: primaryDeveloperId,
        other_developer_ids: otherDeveloperIds,
        csrf_token: csrfToken.value
    });
    
    // Send merge request
    fetch('{% url "developers:merge" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken.value,
        },
        body: JSON.stringify({
            primary_developer_id: primaryDeveloperId,
            other_developer_ids: otherDeveloperIds
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            closeMergeModal();
            clearSelection();
            // Reload page to show updated data
            window.location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Merge error:', error);
        alert('An error occurred while merging developers.');
    });
}
</script>
{% endblock %} 