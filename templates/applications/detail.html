{% extends 'base/base.html' %}

{% block title %}{{ application.name }} - GitPulse{% endblock %}

{% csrf_token %}

{% block content %}
<!-- Custom full-height layout that bypasses main container -->
<div class="fixed inset-0 pt-16 bg-light-gray overflow-hidden">
    <div class="flex h-full">
        <!-- Main Content Area - Analytics Dashboard -->
        <div class="flex-1 flex flex-col min-w-0">
            <!-- Header -->
            <div class="bg-white border-b border-gray-200 px-6 py-4 flex-shrink-0">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-4">
                        <div class="w-12 h-12 bg-gradient-to-r from-primary-green to-primary-blue rounded-xl flex items-center justify-center shadow-glow">
                            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                            </svg>
                        </div>
                        <div>
                            <h1 class="text-2xl font-bold text-dark-gray">{{ application.name }}</h1>
                            <p class="text-medium-gray">Analytics Dashboard</p>
                        </div>
                    </div>
                    
                    <!-- Toggle Button for Slide-over -->
                    <button id="slideover-toggle" class="btn btn-outline border-gray-300 text-dark-gray hover:bg-gray-50 rounded-xl">
                        <svg id="chevron-icon" class="w-5 h-5 transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                        </svg>
                        <span class="ml-2">Settings</span>
                    </button>
                </div>
            </div>

            <!-- Main Content - Analytics Dashboard -->
            <div class="flex-1 overflow-y-auto p-6">
                <div class="max-w-6xl mx-auto">
                    <!-- Overall Stats Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                        <div class="bg-white p-6 rounded-xl shadow-lg">
                            <div class="flex items-center">
                                <div class="p-3 bg-primary-green bg-opacity-10 rounded-xl mr-4">
                                    <svg class="w-8 h-8 text-primary-green" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                    </svg>
                                </div>
                                <div>
                                    <p class="text-medium-gray text-sm">Total Commits</p>
                                    <p class="text-2xl font-bold text-dark-gray">{{ overall_stats.total_commits|default:"0" }}</p>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white p-6 rounded-xl shadow-lg">
                            <div class="flex items-center">
                                <div class="p-3 bg-blue-500 bg-opacity-10 rounded-xl mr-4">
                                    <svg class="w-8 h-8 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                                    </svg>
                                </div>
                                <div>
                                    <p class="text-medium-gray text-sm">Commit Frequency</p>
                                    <p class="text-2xl font-bold {% if commit_frequency and commit_frequency.avg_commits_per_day >= 1 %}text-green-600{% elif commit_frequency and commit_frequency.avg_commits_per_day >= 0.3 %}text-blue-600{% else %}text-gray-500{% endif %}">
                                        {% if commit_frequency and commit_frequency.avg_commits_per_day is not None %}
                                            {{ commit_frequency.avg_commits_per_day }}/day
                                        {% else %}
                                            N/A
                                        {% endif %}
                                    </p>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white p-6 rounded-xl shadow-lg">
                            <div class="flex items-center">
                                <div class="p-3 bg-primary-blue bg-opacity-10 rounded-xl mr-4">
                                    <svg class="w-8 h-8 text-primary-blue" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                    </svg>
                                </div>
                                <div>
                                    <p class="text-medium-gray text-sm">Active Developers</p>
                                    <p class="text-2xl font-bold text-dark-gray">{{ overall_stats.total_authors|default:"0" }}</p>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white p-6 rounded-xl shadow-lg">
                            <div class="flex items-center">
                                <div class="p-3 bg-green-500 bg-opacity-10 rounded-xl mr-4">
                                    <svg class="w-8 h-8 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                                    </svg>
                                </div>
                                <div>
                                    <p class="text-medium-gray text-sm">Lines Added</p>
                                    <p class="text-2xl font-bold text-dark-gray">{{ overall_stats.total_additions|default:"0" }}</p>
                                </div>
                            </div>
                        </div>
                    </div>



                    <!-- Developer Activity and Commit Analytics -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                        <!-- Left Column: Developer Activity (spans full height) -->
                        <div class="bg-white p-6 h-full rounded-xl shadow-lg">
                            <h3 class="text-xl font-semibold text-dark-gray mb-4">üßë‚Äçüíª Developer Activity (Last 30 Days)</h3>
                            {% if developer_activity.developers %}
                            <div class="space-y-4">
                                {% for dev in developer_activity.developers|slice:":5" %}
                                <div class="flex items-center justify-between p-4 bg-light-gray rounded-xl shadow-sm">
                                    <div class="flex-1">
                                        <p class="font-medium text-dark-gray">{{ dev.name }}</p>
                                        <p class="text-sm text-medium-gray">{{ dev.email }}</p>
                                    </div>
                                    <div class="text-right">
                                        <p class="text-lg font-bold text-primary-green">{{ dev.commits }} commits</p>
                                        <p class="text-sm text-medium-gray">
                                            +{{ dev.additions }} / -{{ dev.deletions }} lines
                                        </p>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            {% else %}
                            <div class="text-center py-8">
                                <p class="text-medium-gray">No developer activity in the last 30 days</p>
                            </div>
                            {% endif %}
                        </div>
                        
                        <!-- Right Column: Commit Quality and Type Distribution -->
                        <div class="flex flex-col space-y-6">
                            <!-- Commit Quality -->
                            <div class="bg-white p-6 rounded-xl shadow-lg">
                                <h3 class="text-xl font-semibold text-dark-gray mb-4">üìù Commit Quality</h3>
                                {% if commit_quality.total_commits > 0 %}
                                <div class="space-y-4">
                                    <div class="flex items-center justify-between">
                                        <span class="text-medium-gray">Explicit Messages</span>
                                        <span class="font-bold text-primary-green">{{ commit_quality.explicit_ratio }}%</span>
                                    </div>
                                    <div class="w-full bg-gray-200 rounded-full h-2">
                                        <div class="bg-primary-green h-2 rounded-full" style="width: {{ commit_quality.explicit_ratio }}%"></div>
                                    </div>
                                    
                                    <div class="flex items-center justify-between">
                                        <span class="text-medium-gray">Generic Messages</span>
                                        <span class="font-bold text-red-500">{{ commit_quality.generic_ratio }}%</span>
                                    </div>
                                    <div class="w-full bg-gray-200 rounded-full h-2">
                                        <div class="bg-red-500 h-2 rounded-full" style="width: {{ commit_quality.generic_ratio }}%"></div>
                                    </div>
                                    
                                    <div class="mt-4 p-4 bg-light-gray rounded-xl">
                                        <p class="text-sm text-medium-gray">Total commits analyzed: {{ commit_quality.total_commits }}</p>
                                    </div>
                                </div>
                                {% else %}
                                <div class="text-center py-8">
                                    <p class="text-medium-gray">No commit quality data available</p>
                                </div>
                                {% endif %}
                            </div>
                            
                            <!-- Commit Type Distribution Doughnut Chart -->
                            <div class="bg-white p-6 rounded-xl shadow-lg">
                                <h3 class="text-xl font-semibold text-dark-gray mb-4">üç© Commit Type Distribution</h3>
                                {% if commit_types.total > 0 %}
                                <div class="flex items-start space-x-6">
                                    <div class="relative" style="width: 280px; height: 280px;">
                                        <canvas id="commitTypeDoughnut"></canvas>
                                    </div>
                                    <div class="flex flex-col space-y-3">
                                        {% for item in commit_type_legend %}
                                            <div class="flex items-center space-x-2">
                                                <span class="inline-block w-4 h-4 rounded-full" style="background-color: {{ item.color }};"></span>
                                                <span class="text-sm text-dark-gray font-medium">{{ item.label|title }} ({{ item.count }})</span>
                                            </div>
                                        {% endfor %}
                                    </div>
                                </div>
                                <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
                                <script>
                                    const commitTypeData = {
                                        labels: {{ commit_type_labels|safe }},
                                        datasets: [{
                                            data: {{ commit_type_values|safe }},
                                            backgroundColor: [
                                                '#4caf50', // fix
                                                '#2196f3', // feature
                                                '#ffeb3b', // docs
                                                '#ff9800', // refactor
                                                '#9c27b0', // test
                                                '#00bcd4', // style
                                                '#607d8b', // chore
                                                '#bdbdbd', // other
                                            ],
                                            borderWidth: 1
                                        }]
                                    };
                                    const ctx = document.getElementById('commitTypeDoughnut').getContext('2d');
                                    new Chart(ctx, {
                                        type: 'doughnut',
                                        data: commitTypeData,
                                        options: {
                                            plugins: {
                                                legend: { display: false }
                                            }
                                        }
                                    });
                                </script>
                                {% else %}
                                <div class="text-center py-8">
                                    <p class="text-medium-gray">No commit type data available</p>
                                </div>
                                {% endif %}
                            </div>
                            

                        </div>
                    </div>

                    <!-- Application Quality Metrics -->
                    <div class="bg-white p-6 mb-8 rounded-xl shadow-lg">
                        <h3 class="text-xl font-semibold text-dark-gray mb-6">üìä Application Quality Metrics</h3>
                        {% if application_quality_metrics.total_commits > 0 %}
                        <div class="overflow-x-auto">
                            <table class="table table-zebra w-full">
                                <thead>
                                    <tr>
                                        <th>Metric</th>
                                        <th>Value</th>
                                        <th>Percentage</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>Total Commits Analyzed</td>
                                        <td>{{ application_quality_metrics.total_commits }}</td>
                                        <td>-</td>
                                    </tr>
                                    <tr>
                                        <td>Real Code Commits</td>
                                        <td>{{ application_quality_metrics.real_code_commits }}</td>
                                        <td>{{ application_quality_metrics.real_code_ratio }}%</td>
                                    </tr>
                                    <tr>
                                        <td>Suspicious Commits</td>
                                        <td>{{ application_quality_metrics.suspicious_commits }}</td>
                                        <td>{{ application_quality_metrics.suspicious_ratio }}%</td>
                                    </tr>
                                    <tr>
                                        <td>Documentation Only</td>
                                        <td>{{ application_quality_metrics.doc_only_commits }}</td>
                                        <td>{{ application_quality_metrics.doc_only_ratio }}%</td>
                                    </tr>
                                    <tr>
                                        <td>Configuration Only</td>
                                        <td>{{ application_quality_metrics.config_only_commits }}</td>
                                        <td>{{ application_quality_metrics.config_only_ratio }}%</td>
                                    </tr>
                                    <tr>
                                        <td>Micro Commits (‚â§2 changes)</td>
                                        <td>{{ application_quality_metrics.micro_commits }}</td>
                                        <td>{{ application_quality_metrics.micro_commits_ratio }}%</td>
                                    </tr>
                                    <tr>
                                        <td>No Ticket Reference</td>
                                        <td>{{ application_quality_metrics.no_ticket_commits }}</td>
                                        <td>{{ application_quality_metrics.no_ticket_ratio }}%</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Quality Scores -->
                        <div class="mt-6 grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="stat bg-base-200 rounded-lg">
                                <div class="stat-title">Code Quality Score</div>
                                <div class="stat-value text-lg {% if application_quality_metrics.avg_code_quality >= 70 %}text-success{% elif application_quality_metrics.avg_code_quality >= 50 %}text-warning{% else %}text-error{% endif %}">
                                    {{ application_quality_metrics.avg_code_quality }}/100
                                </div>
                            </div>
                            <div class="stat bg-base-200 rounded-lg">
                                <div class="stat-title">Impact Score</div>
                                <div class="stat-value text-lg {% if application_quality_metrics.avg_impact >= 70 %}text-success{% elif application_quality_metrics.avg_impact >= 50 %}text-warning{% else %}text-error{% endif %}">
                                    {{ application_quality_metrics.avg_impact }}/100
                                </div>
                            </div>
                            <div class="stat bg-base-200 rounded-lg">
                                <div class="stat-title">Complexity Score</div>
                                <div class="stat-value text-lg {% if application_quality_metrics.avg_complexity >= 70 %}text-success{% elif application_quality_metrics.avg_complexity >= 50 %}text-warning{% else %}text-error{% endif %}">
                                    {{ application_quality_metrics.avg_complexity }}/100
                                </div>
                            </div>
                        </div>
                        {% else %}
                        <div class="text-center py-8">
                            <p class="text-gray-500">No quality metrics available. Run the quality analysis first.</p>
                        </div>
                        {% endif %}
                    </div>

                    <!-- Code Distribution -->
                    <div class="bg-white p-6 mb-8 rounded-xl shadow-lg">
                        <h3 class="text-xl font-semibold text-dark-gray mb-6">üìä Top 10 Contributors by Net Lines</h3>
                        {% if code_distribution.distribution %}
                        <div class="overflow-x-auto">
                            <table class="table w-full" id="code-distribution-table">
                                <thead>
                                    <tr>
                                        <th class="text-left cursor-pointer hover:bg-gray-100" onclick="sortTable(0)">
                                            <div class="flex items-center">
                                                Developer
                                                <svg class="w-4 h-4 ml-1 sort-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"></path>
                                                </svg>
                                            </div>
                                        </th>
                                        <th class="text-center cursor-pointer hover:bg-gray-100" onclick="sortTable(1)">
                                            <div class="flex items-center justify-center">
                                                Commits
                                                <svg class="w-4 h-4 ml-1 sort-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"></path>
                                                </svg>
                                            </div>
                                        </th>
                                        <th class="text-center cursor-pointer hover:bg-gray-100" onclick="sortTable(2)">
                                            <div class="flex items-center justify-center">
                                                Lines Added
                                                <svg class="w-4 h-4 ml-1 sort-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"></path>
                                                </svg>
                                            </div>
                                        </th>
                                        <th class="text-center cursor-pointer hover:bg-gray-100" onclick="sortTable(3)">
                                            <div class="flex items-center justify-center">
                                                Lines Deleted
                                                <svg class="w-4 h-4 ml-1 sort-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"></path>
                                                </svg>
                                            </div>
                                        </th>
                                        <th class="text-center cursor-pointer hover:bg-gray-100" onclick="sortTable(4)">
                                            <div class="flex items-center justify-center">
                                                % of Additions
                                                <svg class="w-4 h-4 ml-1 sort-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"></path>
                                                </svg>
                                            </div>
                                        </th>
                                        <th class="text-center cursor-pointer hover:bg-gray-100" onclick="sortTable(5)">
                                            <div class="flex items-center justify-center">
                                                Net Lines
                                                <svg class="w-4 h-4 ml-1 sort-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"></path>
                                                </svg>
                                            </div>
                                        </th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for dev in code_distribution.distribution %}
                                    <tr class="hover:bg-light-gray">
                                        <td class="font-medium">{{ dev.author }}</td>
                                        <td class="text-center" data-sort="{{ dev.commits }}">{{ dev.commits }}</td>
                                        <td class="text-center text-green-600" data-sort="{{ dev.additions }}">+{{ dev.additions }}</td>
                                        <td class="text-center text-red-600" data-sort="{{ dev.deletions }}">-{{ dev.deletions }}</td>
                                        <td class="text-center" data-sort="{{ dev.additions_percentage }}">{{ dev.additions_percentage }}%</td>
                                        <td class="text-center font-bold {% if dev.net_lines > 0 %}text-green-600{% else %}text-red-600{% endif %}" data-sort="{{ dev.net_lines }}">
                                            {% if dev.net_lines > 0 %}+{% endif %}{{ dev.net_lines }}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <div class="text-center py-8">
                            <p class="text-medium-gray">No code distribution data available</p>
                        </div>
                        {% endif %}
                    </div>



                        <!-- Commit Activity Bubble Chart -->
    <div class="bg-white p-6 rounded-xl shadow-lg">
                        <h3 class="text-xl font-semibold text-dark-gray mb-6">üïê Commit Activity by Hour (Last 30 Days)</h3>
                        {% if bubble_chart.datasets %}
                        <!-- Repository Legend -->
                        <div class="mb-4 p-4 bg-light-gray rounded-xl">
                            <h4 class="text-sm font-semibold text-dark-gray mb-3">Repositories:</h4>
                            <div class="flex flex-wrap gap-3" id="repository-legend">
                                {% for dataset in bubble_chart.datasets %}
                                <div class="flex items-center space-x-2">
                                    <div class="w-4 h-4 rounded-full" style="background-color: {{ dataset.backgroundColor }}; border: 2px solid {{ dataset.borderColor }};"></div>
                                    <span class="text-sm text-dark-gray font-medium">{{ dataset.label }}</span>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        
                        <div class="relative" style="height: 500px;">
                            <canvas id="bubbleChart" width="400" height="500"></canvas>
                        </div>
                        <p class="text-sm text-medium-gray text-center mt-4">
                            X-axis: Days ago, Y-axis: Hour of day (0-23), Bubble size: Number of commits
                        </p>
                        {% else %}
                        <div class="text-center py-8">
                            <p class="text-medium-gray">No commit activity data available</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Slide-over Panel - Application Settings -->
        <div id="slideover-panel" class="fixed inset-y-0 right-0 w-96 bg-white shadow-2xl transform translate-x-full transition-transform duration-300 ease-in-out z-50">
            <div class="h-full flex flex-col">
                <!-- Slide-over Header -->
                <div class="flex items-center justify-between p-6 border-b border-gray-200 flex-shrink-0">
                    <h2 class="text-xl font-bold text-dark-gray">Application Settings</h2>
                    <button id="slideover-close" class="btn btn-ghost btn-sm rounded-xl">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>

                <!-- Slide-over Content -->
                <div class="flex-1 overflow-y-auto p-6">
                    <!-- Application Info -->
                    <div class="mb-8">
                        <div class="flex items-start space-x-4 mb-6">
                            <div class="w-16 h-16 bg-gradient-to-r from-primary-green to-primary-blue rounded-2xl flex items-center justify-center shadow-glow">
                                <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
                                </svg>
                            </div>
                            <div class="flex-1">
                                <h1 class="text-2xl font-bold text-dark-gray mb-2">{{ application.name }}</h1>
                                <p class="text-medium-gray text-sm mb-4">{{ application.description }}</p>
                                <div class="flex items-center space-x-4 text-sm text-medium-gray">
                                    <div class="flex items-center">
                                        <svg class="w-4 h-4 text-primary-green mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
                                        </svg>
                                        {{ application.repository_count }} repositories
                                    </div>
                                    <div class="flex items-center">
                                        <svg class="w-4 h-4 text-primary-blue mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                        </svg>
                                        Created {{ application.created_at|date:"M d, Y" }}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="space-y-3 mb-8">
                        <button onclick="startIndexing({{ application.pk }})" class="btn bg-gradient-to-r from-blue-500 to-blue-600 text-white border-0 rounded-xl px-4 py-3 font-semibold shadow-soft hover:shadow-glow transition-all duration-300 w-full">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                            </svg>
                            Start Indexing
                        </button>
                        
                        <div class="flex space-x-3">
                            <a href="{% url 'applications:edit' application.pk %}" class="btn btn-outline border-gray-300 text-dark-gray hover:bg-gray-50 rounded-xl flex-1">
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                </svg>
                                Edit
                            </a>
                            <a href="{% url 'applications:delete' application.pk %}" class="btn btn-outline border-red-300 text-red-500 hover:bg-red-50 rounded-xl flex-1">
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                </svg>
                                Delete
                            </a>
                        </div>
                    </div>

                    <!-- Repositories Section -->
                    <div>
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center">
                                <div class="w-8 h-8 bg-primary-green rounded-lg flex items-center justify-center mr-3">
                                    <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
                                    </svg>
                                </div>
                                <h3 class="text-lg font-bold text-dark-gray">Repositories</h3>
                            </div>
                            <a href="{% url 'applications:add_repositories' application.pk %}" class="btn bg-gradient-to-r from-primary-green to-primary-blue text-white border-0 rounded-xl px-3 py-2 text-sm font-semibold shadow-soft hover:shadow-glow transition-all duration-300">
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                </svg>
                                Add
                            </a>
                        </div>

                        {% if repositories %}
                        <div class="space-y-3">
                            {% for repo in repositories %}
                            <div class="bg-light-gray rounded-lg p-4 border border-gray-100">
                                <div class="flex items-start justify-between">
                                    <div class="flex-1 min-w-0">
                                        <div class="flex items-center mb-2">
                                            <h4 class="text-sm font-semibold text-dark-gray truncate">{{ repo.github_repo_name }}</h4>
                                            {% if repo.is_private %}
                                            <span class="badge badge-xs bg-yellow-100 text-yellow-800 border-0 ml-2">Private</span>
                                            {% else %}
                                            <span class="badge badge-xs bg-green-100 text-green-800 border-0 ml-2">Public</span>
                                            {% endif %}
                                        </div>
                                        
                                        {% if repo.description %}
                                        <p class="text-xs text-medium-gray mb-2 line-clamp-2">{{ repo.description }}</p>
                                        {% endif %}
                                        
                                        <div class="flex items-center space-x-4 text-xs text-medium-gray">
                                            {% if repo.language %}
                                            <div class="flex items-center">
                                                <span class="w-2 h-2 bg-primary-blue rounded-full mr-1"></span>
                                                {{ repo.language }}
                                            </div>
                                            {% endif %}
                                            <div class="flex items-center">
                                                <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"></path>
                                                </svg>
                                                {{ repo.stars_count }}
                                            </div>
                                            <div class="flex items-center">
                                                <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.367 2.684 3 3 0 00-5.367-2.684z"></path>
                                                </svg>
                                                {{ repo.forks_count }}
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="flex items-center space-x-1 ml-2">
                                        <a href="https://github.com/{{ repo.github_repo_name }}" target="_blank" class="btn btn-xs btn-outline border-primary-blue text-primary-blue hover:bg-primary-blue hover:text-white rounded-lg">
                                            <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 24 24">
                                                <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
                                            </svg>
                                        </a>
                                        <form method="post" action="{% url 'applications:remove_repository' application.pk repo.pk %}" class="inline">
                                            {% csrf_token %}
                                            <button type="submit" class="btn btn-xs btn-ghost text-red-500 hover:bg-red-50 rounded-lg" onclick="return confirm('Are you sure you want to remove this repository?')">
                                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                                </svg>
                                            </button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <!-- Empty State -->
                        <div class="text-center py-6">
                            <div class="w-12 h-12 bg-gradient-to-r from-primary-green/20 to-primary-blue/20 rounded-xl flex items-center justify-center mx-auto mb-3">
                                <svg class="w-6 h-6 text-primary-green" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
                                </svg>
                            </div>
                            <h4 class="text-sm font-semibold text-dark-gray mb-2">No Repositories Yet</h4>
                            <p class="text-xs text-medium-gray mb-3">
                                Start by adding GitHub repositories to your application.
                            </p>
                            <a href="{% url 'applications:add_repositories' application.pk %}" class="btn btn-xs bg-gradient-to-r from-primary-green to-primary-blue text-white border-0 rounded-lg">
                                Add Repositories
                            </a>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Backdrop -->
        <div id="slideover-backdrop" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden"></div>
    </div>
</div>

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- JavaScript for Slide-over -->
<script>
// Table sorting functionality
let currentSortColumn = -1;
let currentSortDirection = 'asc';

function sortTable(columnIndex) {
    const table = document.getElementById('code-distribution-table');
    const tbody = table.querySelector('tbody');
    const rows = Array.from(tbody.querySelectorAll('tr'));
    
    // Determine sort direction
    let sortDirection = 'asc';
    if (currentSortColumn === columnIndex) {
        sortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
    }
    
    // Update sort state
    currentSortColumn = columnIndex;
    currentSortDirection = sortDirection;
    
    // Update sort icons
    updateSortIcons(columnIndex, sortDirection);
    
    // Sort the rows
    rows.sort((a, b) => {
        let aValue, bValue;
        
        if (columnIndex === 0) {
            // Sort by developer name (text)
            aValue = a.cells[columnIndex].textContent.trim().toLowerCase();
            bValue = b.cells[columnIndex].textContent.trim().toLowerCase();
        } else {
            // Sort by numeric values
            aValue = parseFloat(a.cells[columnIndex].getAttribute('data-sort') || '0');
            bValue = parseFloat(b.cells[columnIndex].getAttribute('data-sort') || '0');
        }
        
        if (sortDirection === 'asc') {
            return aValue > bValue ? 1 : -1;
        } else {
            return aValue < bValue ? 1 : -1;
        }
    });
    
    // Reorder the rows in the table
    rows.forEach(row => tbody.appendChild(row));
}

function updateSortIcons(activeColumn, direction) {
    const headers = document.querySelectorAll('#code-distribution-table th');
    
    headers.forEach((header, index) => {
        const icon = header.querySelector('.sort-icon');
        if (icon) {
            if (index === activeColumn) {
                // Show active sort direction
                if (direction === 'asc') {
                    icon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"></path>';
                } else {
                    icon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>';
                }
                icon.classList.add('text-primary-green');
            } else {
                // Reset to default icon
                icon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"></path>';
                icon.classList.remove('text-primary-green');
            }
        }
    });
}

document.addEventListener('DOMContentLoaded', function() {
    const toggle = document.getElementById('slideover-toggle');
    const panel = document.getElementById('slideover-panel');
    const backdrop = document.getElementById('slideover-backdrop');
    const closeBtn = document.getElementById('slideover-close');
    const chevronIcon = document.getElementById('chevron-icon');
    
    function openSlideover() {
        panel.classList.remove('translate-x-full');
        backdrop.classList.remove('hidden');
        chevronIcon.style.transform = 'rotate(180deg)';
    }
    
    function closeSlideover() {
        panel.classList.add('translate-x-full');
        backdrop.classList.add('hidden');
        chevronIcon.style.transform = 'rotate(0deg)';
    }
    
    toggle.addEventListener('click', openSlideover);
    closeBtn.addEventListener('click', closeSlideover);
    backdrop.addEventListener('click', closeSlideover);
    
    // Close on escape key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            closeSlideover();
        }
    });
});

function startIndexing(applicationId) {
    const button = event.target;
    
    // Prevent multiple clicks
    if (button.disabled) {
        return;
    }
    
    if (confirm('Are you sure you want to start indexing? This will fetch and sync all commits from the repositories in the background.')) {
        // Show loading state with progress bar
        const originalText = button.innerHTML;
        button.innerHTML = `
            <div class="w-full">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-sm font-medium">Starting...</span>
                    <span class="text-sm font-bold">0%</span>
                </div>
                <div class="w-full bg-white bg-opacity-30 rounded-full h-2">
                    <div class="bg-white h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                </div>
            </div>
        `;
        button.disabled = true;
        
        // Make API call to start background indexing
        fetch(`/analytics/application/${applicationId}/start-indexing/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Content-Type': 'application/json',
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Start polling for progress with task ID
                pollProgress(applicationId, data.task_id, button, originalText);
            } else {
                alert('Error starting indexing: ' + (data.error || 'Unknown error'));
                button.innerHTML = originalText;
                button.disabled = false;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error starting indexing. Please try again.');
            button.innerHTML = originalText;
            button.disabled = false;
        });
    }
}

function pollProgress(applicationId, taskId, button, originalText) {
    let pollCount = 0;
    const maxPolls = 600; // 30 minutes with 3-second intervals
    
    const progressInterval = setInterval(() => {
        pollCount++;
        
        fetch(`/analytics/application/${applicationId}/indexing-progress/?task_id=${taskId}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const progress = data.progress;
                    const percentage = progress.percentage;
                    
                    // Log debug information
                    if (progress.debug) {
                        console.log('Progress Debug Info:', progress.debug);
                    }
                    
                    // Update progress bar
                    const progressBar = button.querySelector('.bg-white.h-2');
                    const percentageText = button.querySelector('.text-sm.font-bold');
                    const statusText = button.querySelector('.text-sm.font-medium');
                    
                    if (progressBar && percentageText && statusText) {
                        progressBar.style.width = percentage + '%';
                        percentageText.textContent = Math.round(percentage) + '%';
                        
                        if (progress.is_complete) {
                            statusText.textContent = 'Complete!';
                            clearInterval(progressInterval);
                            setTimeout(() => {
                                button.innerHTML = originalText;
                                button.disabled = false;
                            }, 1000);
                        } else if (progress.is_running) {
                            statusText.textContent = progress.status || `Indexing... (${progress.completed_repos}/${progress.total_repos})`;
                        } else {
                            statusText.textContent = 'Starting...';
                        }
                    }
                } else {
                    console.error('Error fetching progress:', data.error);
                    if (data.error && (data.error.includes('Task failed') || data.error.includes('not found'))) {
                        clearInterval(progressInterval);
                        button.innerHTML = originalText;
                        button.disabled = false;
                        alert('Indexing failed: ' + data.error);
                    }
                }
            })
            .catch(error => {
                console.error('Error polling progress:', error);
                // Don't stop polling on network errors, just log them
            });
    }, 3000); // Poll every 3 seconds for background tasks
    
    // Stop polling after max time
    setTimeout(() => {
        clearInterval(progressInterval);
        button.innerHTML = originalText;
        button.disabled = false;
        alert('Progress monitoring stopped. Check the application later for completion status.');
    }, 1800000); // 30 minutes
}

// Show rate limit status on page load
document.addEventListener('DOMContentLoaded', function() {
    // Initialize bubble chart if data is available
    {% if bubble_chart.datasets %}
    initializeBubbleChart();
    {% endif %}
});

// Bubble chart initialization
function initializeBubbleChart() {
    const ctx = document.getElementById('bubbleChart');
    if (!ctx) return;
    
    const chartData = {{ bubble_chart.datasets|safe }};
    
    new Chart(ctx, {
        type: 'bubble',
        data: {
            datasets: chartData
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false  // We have a custom legend above the chart
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const repo = context.dataset.label;
                            const commits = context.raw.commits;
                            return `${repo}: ${commits} commits`;
                        }
                    }
                }
            },
            scales: {
                x: {
                    type: 'linear',
                    position: 'bottom',
                    title: {
                        display: true,
                        text: 'Days Ago'
                    },
                    reverse: true,
                    min: 0,
                    max: 30
                },
                y: {
                    type: 'linear',
                    position: 'left',
                    title: {
                        display: true,
                        text: 'Hour of Day'
                    },
                    min: 0,
                    max: 23,
                    ticks: {
                        stepSize: 6
                    }
                }
            }
        }
    });
}
</script>
{% endblock %} 