{% extends 'base/base.html' %}
{% load static %}

{% block title %}{{ repository.name }} - GitPulse{% endblock %}

{% block content %}
{% csrf_token %}

<div class="container mx-auto px-4 py-8">
    <!-- Header -->
    <div class="mb-8">
        <div class="flex items-center justify-between mb-4">
            <div>
                <nav class="text-sm breadcrumbs mb-2">
                    <ul>
                        <li><a href="{% url 'repositories:list' %}">Repositories</a></li>
                        <li>{{ repository.name }}</li>
                    </ul>
                </nav>
                <h1 class="text-3xl font-bold text-gray-900">{{ repository.name }}</h1>
                <p class="text-gray-600">
                    <a href="{{ repository.html_url }}" target="_blank" class="hover:text-blue-600 transition-colors duration-200">
                        {{ repository.full_name }}
                        <svg class="w-4 h-4 inline ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                        </svg>
                    </a>
                </p>
                {% if repository.description %}
                    <p class="text-gray-500 mt-2">{{ repository.description }}</p>
                {% endif %}
            </div>
            <div class="flex items-center space-x-3">
                <!-- Date Range Picker (Simple HTML5) -->
                <div class="relative mr-4">
                  <div class="flex items-center space-x-2">
                    <div class="flex flex-col">
                      <label for="start-date" class="text-xs text-gray-500 mb-1">Start Date</label>
                      <input type="date" id="start-date" class="input input-sm input-bordered" 
                             value="{{ start_date|default:'' }}" 
                             onchange="updateDateRange()">
                    </div>
                    <div class="flex flex-col">
                      <label for="end-date" class="text-xs text-gray-500 mb-1">End Date</label>
                      <input type="date" id="end-date" class="input input-sm input-bordered" 
                             value="{{ end_date|default:'' }}" 
                             onchange="updateDateRange()">
                    </div>
                    <div class="flex flex-col">
                      <label class="text-xs text-gray-500 mb-1">Quick Select</label>
                      <div class="flex space-x-1">
                        <button type="button" class="btn btn-xs btn-outline" onclick="setDateRange(30)">30d</button>
                        <button type="button" class="btn btn-xs btn-outline" onclick="setDateRange(60)">60d</button>
                        <button type="button" class="btn btn-xs btn-outline" onclick="setDateRange(90)">90d</button>
                        <button type="button" class="btn btn-xs btn-outline" onclick="setDateRange(365)">1y</button>
                        <button type="button" class="btn btn-xs btn-outline" onclick="setDateRange('all')">All Time</button>
                      </div>
                    </div>
                  </div>
                </div>
                {% if not repository.is_indexed %}
                    <button class="btn btn-primary" onclick="startIndexing({{ repository.id }})" id="index-btn">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                        </svg>
                        Index Repository
                    </button>
                {% endif %}

                <button onclick="deleteRepository({{ repository.id }})" class="btn btn-error">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                    </svg>
                    Delete
                </button>
            </div>
        </div>
        
        <!-- Repository Info -->
        <div class="bg-white rounded-lg shadow p-6 border border-gray-200">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6">
                <div>
                    <h3 class="text-sm font-medium text-gray-500">Language</h3>
                    <p class="text-xl font-semibold text-gray-900">{{ repository.language|default:"N/A" }}</p>
                </div>
                <div>
                    <h3 class="text-sm font-medium text-gray-500">KLOC</h3>
                    <p class="text-xl font-semibold text-gray-900">
                        {% if repository.kloc > 0 %}
                            {{ repository.kloc|floatformat:1 }}
                        {% else %}
                            -
                        {% endif %}
                    </p>
                </div>

                <div>
                    <h3 class="text-sm font-medium text-gray-500">Visibility</h3>
                    <p class="text-xl font-semibold text-gray-900">
                        {% if repository.is_private %}
                            <span class="text-red-600">Private</span>
                        {% else %}
                            <span class="text-green-600">Public</span>
                        {% endif %}
                    </p>
                </div>
                <div>
                    <h3 class="text-sm font-medium text-gray-500">Indexed</h3>
                    <p class="text-xl font-semibold text-gray-900">
                        {% if repository.is_indexed %}
                            <span class="text-green-600">Yes</span>
                        {% else %}
                            <span class="text-red-600">No</span>
                        {% endif %}
                    </p>
                </div>
            </div>
        </div>
    </div>

    {% if repository.is_indexed %}
    <!-- Analytics Dashboard -->
    <div class="space-y-8">
        <!-- Overall Stats Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <!-- Total Commits -->
            <div class="bg-white p-6 rounded-xl shadow-lg cursor-pointer hover:shadow-xl transition-shadow duration-200" onclick="openCommitsList()">
                <div class="flex items-center">
                    <div class="p-3 bg-blue-500 bg-opacity-10 rounded-xl mr-4">
                        <svg class="w-8 h-8 text-blue-500" fill="currentColor" viewBox="0 0 512 512">
                            <path d="M448,224H380a128,128,0,0,0-247.9,0H64a32,32,0,0,0,0,64h68.05A128,128,0,0,0,380,288H448a32,32,0,0,0,0-64ZM256,320a64,64,0,1,1,64-64A64.07,64.07,0,0,1,256,320Z"/>
                        </svg>
                    </div>
                    <div>
                        <p class="text-medium-gray text-sm">Total Commits</p>
                        <p class="text-2xl font-bold text-blue-500">{{ overall_stats.total_commits|default:"0" }}</p>
                    </div>
                </div>
            </div>
            <!-- Lines Added -->
            <div class="bg-white p-6 rounded-xl shadow-lg">
                <div class="flex items-center">
                    <div class="p-3 bg-green-500 bg-opacity-10 rounded-xl mr-4">
                        <svg class="w-8 h-8 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                        </svg>
                    </div>
                    <div>
                        <p class="text-medium-gray text-sm">Lines Added</p>
                        <p class="text-2xl font-bold text-dark-gray">{{ overall_stats.total_additions|default:"0" }}</p>
                    </div>
                </div>
            </div>
            <!-- Total Releases -->
            <div class="bg-white p-6 rounded-xl shadow-lg cursor-pointer hover:shadow-xl transition-shadow duration-200" onclick="openReleasesList()">
                <div class="flex items-center">
                    <div class="p-3 bg-yellow-500 bg-opacity-10 rounded-xl mr-4">
                        <svg class="w-8 h-8 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                        </svg>
                    </div>
                    <div>
                        <p class="text-medium-gray text-sm">Total Releases</p>
                        <p class="text-2xl font-bold text-dark-gray">{{ total_releases|default:"0" }}</p>
                    </div>
                </div>
            </div>
            <!-- Total Developers -->
            <div class="bg-white p-6 rounded-xl shadow-lg">
                <div class="flex items-center">
                    <div class="p-3 bg-purple-500 bg-opacity-10 rounded-xl mr-4">
                        <svg class="w-8 h-8 text-purple-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                        </svg>
                    </div>
                    <div>
                        <p class="text-medium-gray text-sm">Total Developers</p>
                        <p class="text-2xl font-bold text-purple-500">{{ overall_stats.total_authors|default:"0" }}</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Second Row: Commit Frequency, Release Frequency, PR Cycle Time -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <!-- Commit Frequency -->
            <div class="bg-white p-6 rounded-xl shadow-lg">
                <div class="flex items-start">
                    <div class="p-3 bg-blue-500 bg-opacity-10 rounded-xl mr-4">
                        <svg class="w-8 h-8 text-blue-500" fill="currentColor" viewBox="0 0 512 512">
                            <path d="M448,224H380a128,128,0,0,0-247.9,0H64a32,32,0,0,0,0,64h68.05A128,128,0,0,0,380,288H448a32,32,0,0,0,0-64ZM256,320a64,64,0,1,1,64-64A64.07,64.07,0,0,1,256,320Z"/>
                        </svg>
                    </div>
                    <div>
                        <p class="text-medium-gray text-sm">Commit Frequency</p>
                        <p class="text-2xl font-bold text-blue-500">
                            {% if commit_frequency and commit_frequency.avg_commits_per_day is not None %}
                                {{ commit_frequency.avg_commits_per_day }}/day
                            {% else %}
                                N/A
                            {% endif %}
                        </p>
                    </div>
                </div>
            </div>
            <!-- Commit Change Stats (nouveau bloc) -->
            <div class="bg-white p-6 rounded-xl shadow-lg">
                <div class="flex items-start">
                    <div class="p-3 bg-blue-500 bg-opacity-10 rounded-xl mr-4">
                        <svg class="w-8 h-8 text-blue-500" fill="currentColor" viewBox="0 0 512 512">
                            <path d="M448,224H380a128,128,0,0,0-247.9,0H64a32,32,0,0,0,0,64h68.05A128,128,0,0,0,380,288H448a32,32,0,0,0,0-64ZM256,320a64,64,0,1,1,64-64A64.07,64.07,0,0,1,256,320Z"/>
                        </svg>
                    </div>
                    <div>
                        <p class="text-medium-gray text-sm mb-1">Commit Change Stats</p>
                        <div class="text-medium-gray text-xs mb-1">Avg. Lines Changed: <span class="text-dark-gray font-semibold text-sm">{{ commit_change_stats.avg_total_changes }}</span></div>
                        <div class="text-medium-gray text-xs">Avg. Files Changed: <span class="text-dark-gray font-semibold text-sm">{{ commit_change_stats.avg_files_changed }}</span></div>
                    </div>
                </div>
            </div>
            <!-- Release Frequency -->
            <div class="bg-white p-6 rounded-xl shadow-lg">
                <div class="flex items-start">
                    <div class="p-3 bg-yellow-500 bg-opacity-10 rounded-xl mr-4">
                        <svg class="w-8 h-8 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                        </svg>
                    </div>
                    <div>
                        <p class="text-medium-gray text-sm">Release Frequency</p>
                        <p class="text-2xl font-bold text-yellow-500">
                            {% if release_frequency and release_frequency.releases_per_month is not None %}
                                {{ release_frequency.releases_per_month }}/month
                            {% else %}
                                N/A
                            {% endif %}
                        </p>
                    </div>
                </div>
            </div>
            <!-- PR Cycle Time Block -->
            <div class="bg-white p-6 rounded-xl shadow-lg">
                <div class="flex items-start">
                    <div class="p-3 bg-purple-500 bg-opacity-10 rounded-xl mr-4">
                        <svg class="w-8 h-8" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M5.06152 12C5.55362 8.05369 8.92001 5 12.9996 5C17.4179 5 20.9996 8.58172 20.9996 13C20.9996 17.4183 17.4179 21 12.9996 21H8M13 13V9M11 3H15M3 15H8M5 18H10" stroke="#8b5cf6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </div>
                    <div>
                        <p class="text-medium-gray text-sm">PR Cycle Time (h)</p>
                        {% if pr_cycle_time_count > 0 %}
                            <p class="text-2xl font-bold text-dark-gray">{{ pr_cycle_time_median|floatformat:1 }}</p>
                            <p class="text-xs text-medium-gray">min: {{ pr_cycle_time_min|floatformat:1 }}h / max: {{ pr_cycle_time_max|floatformat:1 }}h</p>
                            <p class="text-xs text-medium-gray">{{ pr_cycle_time_count }} PRs</p>
                        {% else %}
                            <p class="text-2xl font-bold text-gray-400">N/A</p>
                        {% endif %}
                    </div>
                </div>
            </div>
            <!-- Deployment Frequency -->
            <div class="bg-white p-6 rounded-xl shadow-lg cursor-pointer hover:shadow-xl transition-shadow duration-200" onclick="openDeploymentsList()">
                <div class="flex items-start">
                    <div class="p-3 bg-pink-500 bg-opacity-10 rounded-xl mr-4">
                        <svg class="w-8 h-8 text-pink-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3"></path>
                            <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" fill="none"/>
                        </svg>
                    </div>
                    <div>
                        <p class="text-medium-gray text-sm">Deployments</p>
                        <p class="text-2xl font-bold text-pink-500">{{ total_deployments }}</p>
                        <p class="text-xs text-medium-gray">
                            {% if deployment_frequency and deployment_frequency.deployments_per_week is not None %}
                                {{ deployment_frequency.deployments_per_week }}/week
                            {% else %}
                                N/A
                            {% endif %}
                        </p>
                    </div>
                </div>
            </div>
            
            <!-- Licensing -->
            <div class="bg-white p-6 rounded-xl shadow-lg cursor-pointer hover:shadow-xl transition-shadow duration-200" 
                 onclick="openLicensingAnalysis()">
                <div class="flex items-start">
                    <div class="p-3 bg-green-500 bg-opacity-10 rounded-xl mr-4">
                        <svg class="w-8 h-8 text-green-500" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path opacity="0.1" d="M12 17H7C5.89543 17 5 16.1046 5 15V5C5 3.89543 5.89543 3 7 3H16C17.1046 3 18 3.89543 18 5V19C18 20.1046 17.1046 21 16 21C14.8954 21 14 20.1046 14 19C14 17.8954 13.1046 17 12 17Z" fill="currentColor"/>
                            <path d="M19 3H9V3C7.11438 3 6.17157 3 5.58579 3.58579C5 4.17157 5 5.11438 5 7V10.5V17" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M14 17V19C14 20.1046 14.8954 21 16 21V21C17.1046 21 18 20.1046 18 19V9V4.5C18 3.67157 18.6716 3 19.5 3V3C20.3284 3 21 3.67157 21 4.5V4.5C21 5.32843 20.3284 6 19.5 6H18.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M16 21H5C3.89543 21 3 20.1046 3 19V19C3 17.8954 3.89543 17 5 17H14" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M9 7H14" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M9 11H14" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </div>
                    <div>
                        <p class="text-medium-gray text-sm">Licensing</p>
                        <p class="text-2xl font-bold text-green-500" id="licensing-status">Analyzing...</p>
                        <p class="text-xs text-medium-gray">Commercial compatibility</p>
                    </div>
                </div>
            </div>
            

            
            <!-- Code Quality Metrics (SonarCloud) -->
            <div class="bg-white p-6 rounded-xl shadow-lg cursor-pointer hover:shadow-xl transition-shadow duration-200" 
                 onclick="openSonarCloudAnalysis()">
                <div class="flex items-start">
                    <div class="p-3 bg-orange-500 bg-opacity-10 rounded-xl mr-4">
                        <svg class="w-8 h-8 text-orange-500" fill="currentColor" viewBox="0 0 24 24" role="img" xmlns="http://www.w3.org/2000/svg">
                            <title>SonarCloud icon</title>
                            <path d="M22.406 10.9a7.088 7.088 0 00-3.377-2.358v-.085c0-4.035-3.156-7.324-7.047-7.324-3.893 0-7.05 3.282-7.05 7.325v.1C2.081 9.492 0 12.268 0 15.542c0 4.035 3.159 7.325 7.05 7.325a6.907 6.907 0 004.952-2.108 6.885 6.885 0 004.947 2.108c3.884 0 7.051-3.282 7.051-7.325a7.572 7.572 0 00-1.594-4.643zM16.95 21.014c-2.903 0-5.267-2.456-5.267-5.474a.91.91 0 00-.89-.924.906.906 0 00-.892.925c0 1.368.367 2.651.994 3.748a5.156 5.156 0 01-3.845 1.733c-2.904 0-5.27-2.457-5.27-5.474 0-3.016 2.366-5.473 5.27-5.473.63 0 1.241.117 1.827.335.007 0 .013.007.02.007.203.071.489.21.578.287a.858.858 0 001.249-.1.942.942 0 00-.097-1.3c-.39-.342-.995-.575-1.144-.63a6.814 6.814 0 00-2.425-.443c-.113 0-.225 0-.338.007.12-2.916 2.433-5.247 5.27-5.247 2.903 0 5.267 2.456 5.267 5.474a5.569 5.569 0 01-2.215 4.463.948.948 0 00-.21 1.283c.171.25.45.39.727.39a.86.86 0 00.516-.172 7.381 7.381 0 002.709-4.02c2.035.785 3.449 2.829 3.449 5.139-.007 3.01-2.371 5.466-5.283 5.466z"/>
                        </svg>
                    </div>
                    <div class="flex-1">
                        <p class="text-medium-gray text-sm">Code Quality Metrics</p>
                        
                        {% if sonarcloud_metrics %}
                        <div class="mt-3 space-y-2 text-xs">
                            <div class="flex justify-between items-center">
                                <span class="text-medium-gray">Maintainability</span>
                                <span class="font-medium {% if sonarcloud_metrics.maintainability_rating == 'A' %}text-green-500{% elif sonarcloud_metrics.maintainability_rating == 'B' %}text-blue-500{% elif sonarcloud_metrics.maintainability_rating == 'C' %}text-yellow-500{% elif sonarcloud_metrics.maintainability_rating == 'D' %}text-orange-500{% elif sonarcloud_metrics.maintainability_rating == 'E' %}text-red-500{% else %}text-gray-400{% endif %}">
                                    {{ sonarcloud_metrics.maintainability_rating|default:"N/A" }}
                                </span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-medium-gray">Reliability</span>
                                <span class="font-medium {% if sonarcloud_metrics.reliability_rating == 'A' %}text-green-500{% elif sonarcloud_metrics.reliability_rating == 'B' %}text-blue-500{% elif sonarcloud_metrics.reliability_rating == 'C' %}text-yellow-500{% elif sonarcloud_metrics.reliability_rating == 'D' %}text-orange-500{% elif sonarcloud_metrics.reliability_rating == 'E' %}text-red-500{% else %}text-gray-400{% endif %}">
                                    {{ sonarcloud_metrics.reliability_rating|default:"N/A" }}
                                </span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-medium-gray">Security</span>
                                <span class="font-medium {% if sonarcloud_metrics.security_rating == 'A' %}text-green-500{% elif sonarcloud_metrics.security_rating == 'B' %}text-blue-500{% elif sonarcloud_metrics.security_rating == 'C' %}text-yellow-500{% elif sonarcloud_metrics.security_rating == 'D' %}text-orange-500{% elif sonarcloud_metrics.security_rating == 'E' %}text-red-500{% else %}text-gray-400{% endif %}">
                                    {{ sonarcloud_metrics.security_rating|default:"N/A" }}
                                </span>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Security Analysis (CodeQL) -->
            <div class="bg-white p-6 rounded-xl shadow-lg cursor-pointer hover:shadow-xl transition-shadow duration-200" 
                 onclick="openCodeQLAnalysis()">
                <div class="flex items-start">
                                   <div class="p-3 bg-red-500 bg-opacity-10 rounded-xl mr-4">
                   <svg class="w-8 h-8 text-red-500" fill="currentColor" viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg">
                       <path d="M435.209,96.685l-19.627-1.077c-53.229-2.957-99.37-23.39-126.611-56.099L255.999,0l-32.98,39.509
		c-27.24,32.709-73.391,53.142-126.611,56.099l-40.497,2.24v187.094c0,26.61,8.059,51.698,20.878,74.642
		c44.26,79.84,144.978,134.496,159.311,142.02L255.999,512l19.891-10.396c18.454-9.678,180.198-97.664,180.198-216.662V97.848
		L435.209,96.685z M98.737,261.106c0-46.326,0-122.674,0-122.674c64.333-3.579,121.509-28.578,157.263-71.5v194.174h157.247v23.836
		c0,96.501-157.247,178.668-157.247,178.668V261.106H98.737z"/>
                   </svg>
               </div>
                    <div class="flex-1">
                        <h3 class="text-lg font-semibold text-dark-gray">Security Health Score</h3>
                        <p class="text-sm text-medium-gray mt-1">CodeQL vulnerability analysis</p>
                        
                        {% if codeql_metrics %}
                            {% if codeql_metrics.status == 'not_available' %}
                                <div class="mt-3 text-xs">
                                    <div class="flex items-center text-gray-500">
                                        <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                            <path d="M10 12a2 2 0 100-4 2 2 0 000 4z"/>
                                            <path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd"/>
                                        </svg>
                                        <span>Not available</span>
                                    </div>
                                    <p class="text-xs text-gray-400 mt-1">CodeQL analysis not enabled for this repository</p>
                                </div>
                            {% else %}
                                <div class="mt-3 space-y-2 text-xs">
                                    <div class="flex justify-between items-center">
                                        <span class="text-medium-gray">Security Health Score</span>
                                        <span class="font-medium {% if codeql_metrics.shs_score >= 70 %}text-green-500{% elif codeql_metrics.shs_score >= 50 %}text-orange-500{% else %}text-red-500{% endif %}">
                                            {{ codeql_metrics.shs_display }}
                                        </span>
                                    </div>
                                    <div class="flex justify-between items-center">
                                        <span class="text-medium-gray">Open Vulnerabilities</span>
                                        <span class="font-medium {% if codeql_metrics.total_vulnerabilities == 0 %}text-green-500{% elif codeql_metrics.total_vulnerabilities < 5 %}text-yellow-500{% else %}text-red-500{% endif %}">
                                            {{ codeql_metrics.total_vulnerabilities }}
                                        </span>
                                    </div>
                                </div>
                            {% endif %}
                        {% else %}
                            <div class="mt-3 text-xs">
                                <div class="flex items-center text-gray-500">
                                    <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                        <path d="M10 12a2 2 0 100-4 2 2 0 000 4z"/>
                                        <path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd"/>
                                    </svg>
                                    <span>Loading...</span>
                                </div>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Frequency Metrics -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <div class="bg-white p-6 rounded-xl shadow-lg">
                <h3 class="text-xl font-semibold text-dark-gray mb-6">⚡ Commit Frequency</h3>
                <div class="space-y-4">
                    <div class="flex justify-between">
                        <span class="text-medium-gray">Recent Activity Score</span>
                        <span class="font-medium">{{ commit_frequency.recent_activity_score }}/100</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-medium-gray">Consistency Score</span>
                        <span class="font-medium">{{ commit_frequency.consistency_score }}/100</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-medium-gray">Overall Frequency Score</span>
                        <span class="font-medium">{{ commit_frequency.overall_frequency_score }}/100</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-medium-gray">Commits Last 30 Days</span>
                        <span class="font-medium">{{ commit_frequency.commits_last_30_days }}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-medium-gray">Active Days</span>
                        <span class="font-medium">{{ commit_frequency.active_days }}/{{ commit_frequency.total_days }}</span>
                    </div>
                </div>
                <div class="mt-4">
                    <details class="bg-blue-50 rounded-lg p-4 border border-blue-200 cursor-pointer">
                        <summary class="font-semibold text-blue-800 text-base">What do these metrics mean?</summary>
                        <div class="mt-3 space-y-2 text-blue-900 text-sm">
                            <div>
                                <span class="font-bold">Recent Activity Score</span>:<br>
                                <span>Percentage of recent activity. Calculated as <code>Commits Last 30 Days / Commits Last 90 Days × 100</code> (max 100).</span>
                            </div>
                            <div>
                                <span class="font-bold">Consistency Score</span>:<br>
                                <span>How regularly commits are made. Calculated as <code>Active Days / Total Days × 100</code> (max 100).</span>
                            </div>
                            <div>
                                <span class="font-bold">Overall Frequency Score</span>:<br>
                                <span>Weighted global score: <code>0.3 × Normalized Avg + 0.4 × Recent Activity Score + 0.3 × Consistency Score</code>.<br>Normalized Avg = <code>min(Average Commits per Day × 20, 100)</code>.</span>
                            </div>
                            <div>
                                <span class="font-bold">Commits Last 30 Days</span>:<br>
                                <span>Number of commits made in the last 30 days.</span>
                            </div>
                            <div>
                                <span class="font-bold">Active Days</span>:<br>
                                <span>Number of distinct days with at least one commit, over the repository's period. Displayed as <code>Active Days / Total Days</code>.</span>
                            </div>
                        </div>
                    </details>
                </div>
            </div>

            <div class="bg-white p-6 rounded-xl shadow-lg">
                <h3 class="text-xl font-semibold text-dark-gray mb-6">🚀 Release Frequency</h3>
                <div class="space-y-4">
                    <div class="flex justify-between">
                        <span class="text-medium-gray">Releases per Month</span>
                        <span class="font-medium">{{ release_frequency.releases_per_month }}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-medium-gray">Releases per Week</span>
                        <span class="font-medium">{{ release_frequency.releases_per_week }}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-medium-gray">PR Cycle Time (median)</span>
                        <span class="font-medium">{{ pr_cycle_time_median }}h</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-medium-gray">PR Cycle Time (avg)</span>
                        <span class="font-medium">{{ pr_cycle_time_avg }}h</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-medium-gray">Total PRs Analyzed</span>
                        <span class="font-medium">{{ pr_cycle_time_count }}</span>
                    </div>
                </div>
                <div class="mt-4">
                    <details class="bg-blue-50 rounded-lg p-4 border border-blue-200 cursor-pointer">
                        <summary class="font-semibold text-blue-800 text-base">What do these metrics mean?</summary>
                        <div class="mt-3 space-y-2 text-blue-900 text-sm">
                            <div>
                                <span class="font-bold">Releases per Month</span>:<br>
                                <span>Average number of releases per month over the selected period (usually 90 days).</span>
                            </div>
                            <div>
                                <span class="font-bold">Releases per Week</span>:<br>
                                <span>Average number of releases per week over the selected period.</span>
                            </div>
                            <div>
                                <span class="font-bold">Total Releases</span>:<br>
                                <span>Total number of releases published during the selected period.</span>
                            </div>
                            <div>
                                <span class="font-bold">Period (days)</span>:<br>
                                <span>The time window (in days) over which the release frequency is calculated (default: 90 days).</span>
                            </div>
                            <div>
                                <span class="font-bold">PR Cycle Time (median)</span>:<br>
                                <span>The median time (in hours) between the opening and merging/closing of pull requests during the selected period. Half of the PRs were merged/closed in less time, and half took longer.</span>
                            </div>
                            <div>
                                <span class="font-bold">PR Cycle Time (avg)</span>:<br>
                                <span>The average time (in hours) between the opening and merging/closing of pull requests during the selected period. This is the mean value for all PRs analyzed.</span>
                            </div>
                        </div>
                    </details>
                </div>
            </div>
        </div>

        <!-- Commit Type Distribution - Full Width -->
        <div class="bg-white p-6 rounded-xl shadow-lg relative">
            <h3 class="text-xl font-semibold text-dark-gray mb-4">🍩 Commit Type Distribution</h3>
            {% if commit_types.counts %}
            <div class="flex items-start gap-8">
                <!-- Left side: Chart and Legend (50%) -->
                <div class="w-1/2 flex items-start space-x-6">
                    <div class="relative flex-1" style="min-height: 250px;">
                        <canvas id="commitTypeDoughnut" class="w-full h-full"></canvas>
                    </div>
                    <div class="flex flex-col space-y-3 flex-shrink-0">
                        {% for item in commit_type_legend %}
                            <div class="flex items-center space-x-2">
                                <span class="inline-block w-4 h-4 rounded-full" style="background-color: {{ item.color }};"></span>
                                <span class="text-sm text-dark-gray font-medium">{{ item.label|title }} ({{ item.count }})</span>
                            </div>
                        {% endfor %}
                    </div>
                </div>
                
                <!-- Right side: Indicators (50%) -->
                <div class="w-1/2 flex flex-col space-y-4">
                
                <!-- Feature-to-Fix Ratio Block -->
                <div class="p-4 rounded-xl shadow-sm bg-light-gray">
                    <div class="flex items-center mb-2">
                        <span class="text-lg font-semibold text-dark-gray mr-2">Feature-to-Fix Ratio</span>
                        <span class="text-sm text-medium-gray">(Feature / Fix &gt; 1)</span>
                    </div>
                    <div class="flex items-center mb-1">
                        <span class="text-2xl font-bold mr-3 {% if commit_types.feature_fix_status == 'good' %}text-green-600{% else %}text-red-600{% endif %}">
                            {{ commit_types.feature_fix_ratio }}
                        </span>
                        <span class="ml-2 text-lg font-semibold {% if commit_types.feature_fix_status == 'good' %}text-green-600{% else %}text-red-600{% endif %}">
                            {% if commit_types.feature_fix_status == 'good' %}🟢 Good Ratio{% else %}🔴 Poor Ratio{% endif %}
                        </span>
                    </div>
                    <div class="text-sm text-dark-gray mt-1">{{ commit_types.feature_fix_message }}</div>
                </div>
                
                <!-- Test Coverage Ratio Block -->
                <div class="p-4 rounded-xl shadow-sm bg-light-gray">
                    <div class="flex items-center mb-2">
                        <span class="text-lg font-semibold text-dark-gray mr-2">Test Coverage Ratio</span>
                        <span class="text-sm text-medium-gray">(Test / Feature ≥ 0.3)</span>
                    </div>
                    <div class="flex items-center mb-1">
                        <span class="text-2xl font-bold mr-3 {% if commit_types.test_feature_status == 'good' %}text-green-600{% else %}text-red-600{% endif %}">
                            {{ commit_types.test_feature_ratio }}
                        </span>
                        <span class="ml-2 text-lg font-semibold {% if commit_types.test_feature_status == 'good' %}text-green-600{% else %}text-red-600{% endif %}">
                            {% if commit_types.test_feature_status == 'good' %}🟢 Good Ratio{% else %}🔴 Poor Ratio{% endif %}
                        </span>
                    </div>
                    <div class="text-sm text-dark-gray mt-1">{{ commit_types.test_feature_message }}</div>
                </div>
                
                <!-- Focus Ratio Block -->
                <div class="p-4 rounded-xl shadow-sm bg-light-gray">
                    <div class="flex items-center mb-2">
                        <span class="text-lg font-semibold text-dark-gray mr-2">Focus Ratio</span>
                        <span class="text-sm text-medium-gray">(Chore + Docs &lt; 30%)</span>
                    </div>
                    <div class="flex items-center mb-1">
                        <span class="text-2xl font-bold mr-3 {% if commit_types.chore_docs_status == 'good' %}text-green-600{% else %}text-red-600{% endif %}">
                            {{ commit_types.chore_docs_ratio|floatformat:2 }}
                        </span>
                        <span class="ml-2 text-lg font-semibold {% if commit_types.chore_docs_status == 'good' %}text-green-600{% else %}text-red-600{% endif %}">
                            {% if commit_types.chore_docs_status == 'good' %}🟢 Good Ratio{% else %}🔴 Poor Ratio{% endif %}
                        </span>
                    </div>
                    <div class="text-sm text-dark-gray mt-1">{{ commit_types.chore_docs_message }}</div>
                </div>
                {% else %}
                <p class="text-center text-medium-gray py-8">No commit types to display</p>
                {% endif %}
                </div>
            </div>
        </div>

        <!-- PR Health Metrics -->
        <div class="bg-white p-6 rounded-xl shadow-lg">
            <h3 class="text-xl font-semibold text-dark-gray mb-6">🔍 Pull Request Health</h3>
            {% if pr_health_metrics.total_prs > 0 %}
            <!-- Summary Cards -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                <div class="text-center p-4 bg-light-gray rounded-xl">
                    <p class="text-2xl font-bold text-primary-green">{{ pr_health_metrics.total_prs }}</p>
                    <p class="text-sm text-medium-gray">Total PRs</p>
                </div>
                <div class="text-center p-4 bg-light-gray rounded-xl">
                    <p class="text-2xl font-bold text-blue-500">{{ pr_health_metrics.merged_prs }}</p>
                    <p class="text-sm text-medium-gray">Merged ({{ pr_health_metrics.merged_prs_percentage }}%)</p>
                </div>
                <div class="text-center p-4 bg-light-gray rounded-xl">
                    <p class="text-2xl font-bold text-yellow-500">{{ pr_health_metrics.self_merged_prs }}</p>
                    <p class="text-sm text-medium-gray">Self-merged ({{ pr_health_metrics.self_merged_rate }}%)</p>
                </div>
                <div class="text-center p-4 bg-light-gray rounded-xl">
                    <p class="text-2xl font-bold text-purple-500">{{ pr_health_metrics.avg_merge_time_hours }}h</p>
                    <p class="text-sm text-medium-gray">Avg Merge Time</p>
                </div>
            </div>

            <!-- Detailed Metrics -->
            <div class="overflow-x-auto">
                <table class="w-full text-sm">
                    <thead>
                        <tr class="border-b border-gray-200">
                            <th class="text-left py-2 font-medium text-dark-gray">Metric</th>
                            <th class="text-right py-2 font-medium text-dark-gray">Value</th>
                            <th class="text-right py-2 font-medium text-dark-gray">Percentage</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr class="border-b border-gray-100">
                            <td class="py-2 text-medium-gray">Open PRs</td>
                            <td class="text-right font-medium">{{ pr_health_metrics.open_prs }}</td>
                            <td class="text-right text-medium-gray">{{ pr_health_metrics.open_prs_percentage }}%</td>
                        </tr>
                        <tr class="border-b border-gray-100">
                            <td class="py-2 text-medium-gray">PRs Without Review*</td>
                            <td class="text-right font-medium">{{ pr_health_metrics.prs_without_review }}</td>
                            <td class="text-right text-medium-gray">{{ pr_health_metrics.prs_without_review_rate }}%</td>
                        </tr>
                        <tr class="border-b border-gray-100">
                            <td class="py-2 text-medium-gray">PRs Open > 7 Days</td>
                            <td class="text-right font-medium">{{ pr_health_metrics.old_open_prs }}</td>
                            <td class="text-right text-medium-gray">{{ pr_health_metrics.old_open_prs_rate }}%</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <p class="text-xs text-gray-500 mt-4">* Estimated based on self-merged PRs and PRs with minimal comments</p>
            {% else %}
            <p class="text-center text-medium-gray py-8">No pull requests to analyze</p>
            {% endif %}
        </div>

        <!-- Top Contributors -->
        <div class="bg-white p-6 rounded-xl shadow-lg">
            <h3 class="text-xl font-semibold text-dark-gray mb-6">🏆 Top 10 Contributors by Net Lines</h3>
            {% if top_contributors %}
            <div class="overflow-x-auto">
                <table class="table table-zebra w-full" id="top-contributors-table">
                    <thead>
                        <tr>
                            <th class="text-center cursor-pointer hover:bg-gray-100" onclick="sortTable(0)">
                                <div class="flex items-center justify-center">
                                    Rank
                                    <svg class="w-4 h-4 ml-1 sort-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"></path>
                                    </svg>
                                </div>
                            </th>
                            <th class="text-left cursor-pointer hover:bg-gray-100" onclick="sortTable(1)">
                                <div class="flex items-center">
                                    Developer
                                    <svg class="w-4 h-4 ml-1 sort-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"></path>
                                    </svg>
                                </div>
                            </th>
                            <th class="text-center cursor-pointer hover:bg-gray-100" onclick="sortTable(2)">
                                <div class="flex items-center justify-center">
                                    Commits
                                    <svg class="w-4 h-4 ml-1 sort-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"></path>
                                    </svg>
                                </div>
                            </th>
                            <th class="text-center cursor-pointer hover:bg-gray-100" onclick="sortTable(3)">
                                <div class="flex items-center justify-center">
                                    Additions
                                    <svg class="w-4 h-4 ml-1 sort-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"></path>
                                    </svg>
                                </div>
                            </th>
                            <th class="text-center cursor-pointer hover:bg-gray-100" onclick="sortTable(4)">
                                <div class="flex items-center justify-center">
                                    Deletions
                                    <svg class="w-4 h-4 ml-1 sort-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"></path>
                                    </svg>
                                </div>
                            </th>
                            <th class="text-center cursor-pointer hover:bg-gray-100" onclick="sortTable(5)">
                                <div class="flex items-center justify-center">
                                    Net Lines
                                    <svg class="w-4 h-4 ml-1 sort-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"></path>
                                    </svg>
                                </div>
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for contributor in top_contributors %}
                        <tr class="hover:bg-light-gray">
                            <td class="text-center" data-sort="{{ forloop.counter }}">{{ forloop.counter }}</td>
                            <td class="font-medium" data-sort="{{ contributor.name }}">{{ contributor.name }}</td>
                            <td class="text-center" data-sort="{{ contributor.commits }}">{{ contributor.commits }}</td>
                            <td class="text-center text-green-600" data-sort="{{ contributor.additions }}">+{{ contributor.additions }}</td>
                            <td class="text-center text-red-600" data-sort="{{ contributor.deletions }}">-{{ contributor.deletions }}</td>
                            <td class="text-center font-bold {% if contributor.net_lines >= 0 %}text-green-600{% else %}text-red-600{% endif %}" data-sort="{{ contributor.net_lines }}">
                                {% if contributor.net_lines > 0 %}+{% endif %}{{ contributor.net_lines }}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <p class="text-center text-medium-gray py-8">No contributors to display</p>
            {% endif %}
        </div>

        <!-- Commit Activity Bubble Chart -->
        <div class="bg-white p-6 rounded-xl shadow-lg">
            <h3 class="text-xl font-semibold text-dark-gray mb-6">🕐 Commit Activity by Hour (Last 30 Days)</h3>
            {% if activity_heatmap.total_commits > 0 %}
            <div class="relative" style="height: 500px;">
                <canvas id="bubbleChart" width="400" height="500"></canvas>
            </div>
            <p class="text-sm text-medium-gray text-center mt-4">
                X-axis: Days ago, Y-axis: Hour of day (0-23), Bubble size: Number of commits
            </p>
            {% else %}
            <div class="text-center py-8">
                <p class="text-medium-gray">No commit activity data available</p>
            </div>
            {% endif %}
        </div>
    </div>
    {% else %}
    <!-- Repository not indexed -->
    <div class="bg-white p-8 rounded-xl shadow-lg text-center">
        <div class="mb-6">
            <svg class="w-16 h-16 mx-auto text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
            </svg>
            <h3 class="text-xl font-semibold text-gray-900 mb-2">Repository Not Indexed</h3>
            <p class="text-gray-600 mb-6">This repository hasn't been indexed yet. Start indexing to view analytics.</p>
        </div>
        <button class="btn btn-primary" onclick="startIndexing({{ repository.id }})" id="index-btn-main">
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
            </svg>
            Start Indexing
        </button>
    </div>
    {% endif %}
</div>

<!-- Modals and JavaScript -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
// Chart initialization
{% if repository.is_indexed %}
document.addEventListener('DOMContentLoaded', function() {
    // Note: licensing analysis is now lazy-loaded on slide-over open to avoid double scrolljump and initial cost
    
    // Commit Type Doughnut Chart
    {% if commit_types.counts %}
    const commitTypeData = {
        labels: {{ commit_type_labels|default:'[]'|safe }},
        datasets: [{
            data: {{ commit_type_values|default:'[]'|safe }},
            backgroundColor: [
                '#4caf50', // fix
                '#2196f3', // feature
                '#ffeb3b', // docs
                '#ff9800', // refactor
                '#9c27b0', // test
                '#00bcd4', // style
                '#607d8b', // chore
                '#bdbdbd', // other
            ],
            borderWidth: 1
        }]
    };
    const doughnutCtx = document.getElementById('commitTypeDoughnut');
    if (doughnutCtx) {
        new Chart(doughnutCtx, {
            type: 'doughnut',
            data: commitTypeData,
            options: {
                plugins: {
                    legend: { display: false }
                }
            }
        });
    }
    {% endif %}
    
    // Bubble Chart for Commit Activity
    {% if activity_heatmap.total_commits > 0 %}
    const bubbleCtx = document.getElementById('bubbleChart');
    if (bubbleCtx) {
        const chartData = {{ bubble_chart_data|default:'[]'|safe }};
        
        new Chart(bubbleCtx, {
            type: 'bubble',
            data: {
                datasets: chartData
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const commits = context.raw.r / 2;
                                return `${commits} commits`;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        type: 'linear',
                        position: 'bottom',
                        title: {
                            display: true,
                            text: 'Days Ago'
                        },
                        reverse: true,
                        min: 0,
                        max: 30
                    },
                    y: {
                        type: 'linear',
                        position: 'left',
                        title: {
                            display: true,
                            text: 'Hour of Day'
                        },
                        min: 0,
                        max: 23,
                        ticks: {
                            stepSize: 6
                        }
                    }
                }
            }
        });
    }
    {% endif %}
});
{% endif %}

// Simple date range picker functionality
function updateDateRange() {
    const startDate = document.getElementById('start-date').value;
    const endDate = document.getElementById('end-date').value;
    
    if (startDate && endDate) {
        const url = new URL(window.location.href);
        url.searchParams.set('start', startDate);
        url.searchParams.set('end', endDate);
        window.location.href = url.toString();
    }
}

function setDateRange(days) {
    const end = new Date();
    const start = new Date();
    
    if (days === 'all') {
        // Set start date to a very old date (1970-01-01) to include all commits
        start.setFullYear(1970);
        start.setMonth(0, 1); // January 1st
    } else {
        start.setDate(end.getDate() - days + 1);
    }
    
    // Helper to format date in local timezone as YYYY-MM-DD
    const formatDateLocal = (d) => {
        const y = d.getFullYear();
        const m = String(d.getMonth() + 1).padStart(2, '0');
        const day = String(d.getDate()).padStart(2, '0');
        return `${y}-${m}-${day}`;
    };
    
    // Update form fields first
    const startDateField = document.getElementById('start-date');
    const endDateField = document.getElementById('end-date');
    
    const startStr = formatDateLocal(start);
    const endStr = formatDateLocal(end);
    startDateField.value = startStr;
    endDateField.value = endStr;
    
    // Build URL with the new dates
    const url = new URL(window.location.href);
    url.searchParams.set('start', startStr);
    url.searchParams.set('end', endStr);
    
    // Navigate to the new URL immediately
    window.location.href = url.toString();
}

// Set default dates if not provided
window.addEventListener('DOMContentLoaded', () => {
    const startDate = document.getElementById('start-date');
    const endDate = document.getElementById('end-date');
    
    if (!startDate.value && !endDate.value) {
        const end = new Date();
        const start = new Date();
        start.setDate(end.getDate() - 29); // 30 days ago
        const formatDateLocal = (d) => {
            const y = d.getFullYear();
            const m = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${y}-${m}-${day}`;
        };
        startDate.value = formatDateLocal(start);
        endDate.value = formatDateLocal(end);
    }
});

// Repository management functions
function startIndexing(repoId) {
    const btn = document.getElementById('index-btn') || document.getElementById('index-btn-main');
    if (btn) {
        btn.disabled = true;
        btn.innerHTML = '<span class="loading loading-spinner loading-sm"></span> Indexing...';
    }
    
    fetch(`/repositories/${repoId}/start-indexing/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Indexing started successfully! The page will refresh when complete.');
            // Poll for completion and refresh page
            setTimeout(() => location.reload(), 30000);
        } else {
            alert('Error starting indexing: ' + data.error);
            if (btn) {
                btn.disabled = false;
                btn.innerHTML = '<svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>Start Indexing';
            }
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error starting indexing');
        if (btn) {
            btn.disabled = false;
            btn.innerHTML = '<svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>Start Indexing';
        }
    });
}

function deleteRepository(repoId) {
    if (confirm('Are you sure you want to delete this repository? This action cannot be undone and will remove all associated data.')) {
        fetch(`/repositories/${repoId}/delete/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Repository deleted successfully!');
                window.location.href = '/repositories/';
            } else {
                alert('Error deleting repository: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error deleting repository');
        });
    }
}

// Table sorting functionality
let currentSortColumn = -1;
let currentSortDirection = 'asc';

function sortTable(columnIndex) {
    const table = document.getElementById('top-contributors-table');
    const tbody = table.querySelector('tbody');
    const rows = Array.from(tbody.querySelectorAll('tr'));
    
    // Determine sort direction
    let sortDirection = 'asc';
    if (currentSortColumn === -1) {
        // First time sorting, use the forced direction
        sortDirection = currentSortDirection;
    } else if (currentSortColumn === columnIndex) {
        // Toggle direction only if we're clicking the same column again
        sortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
    } else {
        // For new column, use the forced direction if set, otherwise default to 'asc'
        sortDirection = currentSortDirection;
    }
    
    // Update sort state
    currentSortColumn = columnIndex;
    currentSortDirection = sortDirection;
    
    // Update sort icons
    updateSortIcons(columnIndex, sortDirection);
    
    // Sort the rows
    rows.sort((a, b) => {
        let aValue, bValue;
        
        if (columnIndex === 1) {
            // Sort by developer name (text)
            aValue = a.cells[columnIndex].textContent.trim().toLowerCase();
            bValue = b.cells[columnIndex].textContent.trim().toLowerCase();
        } else {
            // Sort by numeric values
            aValue = parseFloat(a.cells[columnIndex].getAttribute('data-sort') || '0');
            bValue = parseFloat(b.cells[columnIndex].getAttribute('data-sort') || '0');
        }
        
        if (sortDirection === 'asc') {
            return aValue > bValue ? 1 : -1;
        } else {
            return aValue < bValue ? 1 : -1;
        }
    });
    
    // Reorder the rows in the table
    rows.forEach(row => tbody.appendChild(row));
}

function updateSortIcons(activeColumn, direction) {
    const headers = document.querySelectorAll('#top-contributors-table th');
    
    headers.forEach((header, index) => {
        const icon = header.querySelector('.sort-icon');
        if (icon) {
            if (index === activeColumn) {
                // Show active sort direction
                if (direction === 'asc') {
                    icon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"></path>';
                } else {
                    icon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>';
                }
                icon.classList.add('text-primary-green');
            } else {
                // Reset to default icon
                icon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"></path>';
                icon.classList.remove('text-primary-green');
            }
        }
    });
}

// Licensing Analysis Slide-over
let licensingAnalysisLoaded = false;

function openLicensingAnalysis() {
    document.body.classList.add('overflow-hidden');
    const slideOver = document.getElementById('licensing-slide-over');
    const slidePanel = document.getElementById('licensing-slide-panel');
    const content = document.getElementById('licensing-content');
    
    // Show slide-over
    slideOver.classList.remove('hidden');
    
    // Trigger slide animation
    setTimeout(() => {
        slidePanel.classList.remove('translate-x-full');
    }, 10);
    
    // Load content only if not already loaded
    if (!licensingAnalysisLoaded) {
        loadLicensingAnalysis();
    }
}

function closeLicensingAnalysis() {
    const slideOver = document.getElementById('licensing-slide-over');
    const slidePanel = document.getElementById('licensing-slide-panel');
    const content = document.getElementById('licensing-content');
    
    // Trigger slide-out animation
    slidePanel.classList.add('translate-x-full');
    
    // Hide slide-over after animation and clear content
    setTimeout(() => {
        slideOver.classList.add('hidden');
        // Clear content and reset loaded state
        content.innerHTML = '';
        licensingAnalysisLoaded = false;
        document.body.classList.remove('overflow-hidden');
    }, 300);
}

function loadLicensingAnalysis() {
    const content = document.getElementById('licensing-content');
    const statusElement = document.getElementById('licensing-status');
    
    // Show loading state
    content.innerHTML = `
        <div class="flex items-center justify-center h-64">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-green-500"></div>
        </div>
    `;
    
    // Fetch licensing analysis
    fetch(`/repositories/api/{{ repository.id }}/licensing-analysis/`)
        .then(response => response.json())
        .then(data => {
            licensingAnalysisLoaded = true;
            
            if (data.success) {
                displayLicensingAnalysis(data.analysis);
                updateLicensingStatus(data.analysis);
            } else {
                content.innerHTML = `
                    <div class="text-center p-8">
                        <div class="text-red-500 text-6xl mb-4">⚠️</div>
                        <h3 class="text-xl font-semibold text-gray-800 mb-2">Error Loading Analysis</h3>
                        <p class="text-gray-600">${data.error || 'Unknown error occurred'}</p>
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            content.innerHTML = `
                <div class="text-center p-8">
                    <div class="text-red-500 text-6xl mb-4">❌</div>
                    <h3 class="text-xl font-semibold text-gray-800 mb-2">Network Error</h3>
                    <p class="text-gray-600">Failed to load licensing analysis</p>
                </div>
            `;
        });
}

function displayLicensingAnalysis(analysis) {
    const content = document.getElementById('licensing-content');
    
    if (!analysis.has_sbom) {
        content.innerHTML = `
            <div class="text-center p-8">
                <div class="text-gray-400 text-6xl mb-4">📦</div>
                <h3 class="text-xl font-semibold text-gray-800 mb-2">No SBOM Found</h3>
                <p class="text-gray-600">${analysis.message}</p>
            </div>
        `;
        return;
    }
    
    const componentRows = analysis.component_details.map(component => {
        const licenseBadges = component.licenses.map(license => {
            const isCommercial = ['MIT', 'APACHE-2.0', 'BSD', 'ISC', 'UNLICENSE'].includes(license.id);
            const isCopyleft = ['GPL', 'AGPL', 'LGPL'].some(gpl => license.id.includes(gpl));
            
            let badgeClass = 'bg-gray-100 text-gray-800';
            if (isCommercial) badgeClass = 'bg-green-100 text-green-800';
            else if (isCopyleft) badgeClass = 'bg-red-100 text-red-800';
            else badgeClass = 'bg-yellow-100 text-yellow-800';
            
            return `<span class="inline-block px-2 py-1 text-xs rounded-full ${badgeClass} mr-1">${license.id}</span>`;
        }).join('');
        
        const warningIcon = component.warnings.length > 0 ? '<span class="text-red-500 ml-2">⚠️</span>' : '';
        
        return `
            <tr class="border-b border-gray-200">
                <td class="py-3 px-4">
                    <div class="font-medium">${component.name}${warningIcon}</div>
                    <div class="text-sm text-gray-500">${component.version}</div>
                </td>
                <td class="py-3 px-4">
                    ${licenseBadges}
                </td>
            </tr>
        `;
    }).join('');
    
    content.innerHTML = `
        <div class="space-y-6">
            <!-- LLM Analysis -->
            <div class="bg-purple-50 rounded-lg p-4">
                <h3 class="text-lg font-semibold text-purple-800 mb-3">AI Analysis</h3>
                <div id="llm-analysis-content">
                    <div class="flex items-center justify-center py-4">
                        <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-purple-500"></div>
                        <span class="ml-2 text-purple-600">Analyzing licenses with AI...</span>
                    </div>
                </div>
            </div>
            
            <!-- Components Table -->
            <div>
                <h3 class="text-lg font-semibold text-gray-800 mb-3">Components & Licenses</h3>
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-white border border-gray-200 rounded-lg">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Component</th>
                                <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Licenses</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200">
                            ${componentRows}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    `;
    
    // Load LLM analysis asynchronously
    loadLLMAnalysis();
}



function updateLicensingStatus(analysis) {
    const statusElement = document.getElementById('licensing-status');
    
    console.log('updateLicensingStatus called with analysis:', analysis);
    
    if (!analysis.has_sbom) {
        statusElement.textContent = 'No SBOM';
        statusElement.className = 'text-2xl font-bold text-gray-400';
        return;
    }
    
    // Show loading state for LLM verdict
    statusElement.textContent = '🤖 Analyzing...';
    statusElement.className = 'text-2xl font-bold text-purple-500';
    
    console.log('Starting LLM verdict request...');
    
    // Add timeout to prevent infinite loading
    const timeout = setTimeout(() => {
        console.warn('LLM verdict request timed out');
        // Fallback to basic analysis
        if (analysis.compatible) {
            statusElement.textContent = '✅ Compatible';
            statusElement.className = 'text-2xl font-bold text-green-500';
        } else {
            statusElement.textContent = '⚠️ Review';
            statusElement.className = 'text-2xl font-bold text-yellow-500';
        }
    }, 30000); // 30 second timeout
    
    // Get LLM verdict directly
    fetch(`/repositories/api/{{ repository.id }}/llm-license-verdict/`)
        .then(response => {
            console.log('LLM verdict response received:', response.status);
            clearTimeout(timeout);
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('LLM verdict data:', data);
            if (data.success) {
                const verdict = data.verdict;
                console.log('LLM verdict:', verdict);
                // Display the LLM response directly
                statusElement.textContent = verdict;
                statusElement.className = 'text-2xl font-bold';
            } else {
                console.log('LLM verdict failed, using fallback');
                // Fallback to basic analysis
                if (analysis.compatible) {
                    statusElement.textContent = '✅ Compatible';
                    statusElement.className = 'text-2xl font-bold text-green-500';
                } else {
                    statusElement.textContent = '⚠️ Review';
                    statusElement.className = 'text-2xl font-bold text-yellow-500';
                }
            }
        })
        .catch(error => {
            clearTimeout(timeout);
            console.error('Error loading LLM verdict:', error);
            // Fallback to basic analysis
            if (analysis.compatible) {
                statusElement.textContent = '✅ Compatible';
                statusElement.className = 'text-2xl font-bold text-green-500';
            } else {
                statusElement.textContent = '⚠️ Review';
                statusElement.className = 'text-2xl font-bold text-yellow-500';
            }
        });
}

function loadLLMAnalysis() {
    const llmContent = document.getElementById('llm-analysis-content');
    if (!llmContent) return;
    
    // Show a subtle loading indicator
    llmContent.innerHTML = `
        <div class="flex items-center justify-center py-2">
            <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-purple-500"></div>
            <span class="ml-2 text-sm text-purple-600">Loading AI analysis...</span>
        </div>
    `;
    
    fetch(`/repositories/api/{{ repository.id }}/llm-license-analysis/`)
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                displayLLMAnalysis(data.llm_analysis, data.licenses);
            } else {
                llmContent.innerHTML = `
                    <div class="text-center p-4">
                        <div class="text-yellow-500 text-2xl mb-2">⚠️</div>
                        <p class="text-yellow-600">${data.error || 'Failed to analyze licenses'}</p>
                        <p class="text-sm text-gray-500 mt-1">Using basic analysis instead</p>
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('Error loading LLM analysis:', error);
            llmContent.innerHTML = `
                <div class="text-center p-4">
                    <div class="text-yellow-500 text-2xl mb-2">⚠️</div>
                    <p class="text-yellow-600">AI analysis unavailable</p>
                    <p class="text-sm text-gray-500 mt-1">Using basic analysis instead</p>
                </div>
            `;
        });
}

function displayLLMAnalysis(analysis, licenses) {
    const llmContent = document.getElementById('llm-analysis-content');
    if (!llmContent) return;
    
    // Handle parsing errors
    if (analysis.error) {
        llmContent.innerHTML = `
            <div class="text-center p-4">
                <div class="text-yellow-500 text-2xl mb-2">⚠️</div>
                <p class="text-yellow-600">AI response parsing error</p>
                <details class="mt-2 text-xs text-gray-500">
                    <summary>Raw response</summary>
                    <pre class="mt-2 p-2 bg-gray-100 rounded text-left">${analysis.raw_response || 'No response'}</pre>
                </details>
            </div>
        `;
        return;
    }
    
    // Display structured analysis
    let commercialStatus = analysis.commercial_compatibility || 'UNKNOWN';
    
    // Handle case where commercial_compatibility is an object
    if (typeof commercialStatus === 'object') {
        const values = Object.values(commercialStatus);
        const yesCount = values.filter(v => v === 'YES').length;
        const noCount = values.filter(v => v === 'NO').length;
        const cautionCount = values.filter(v => v === 'CAUTION').length;
        const total = values.length;
        
        // More nuanced logic based on proportions
        if (noCount > 0 && noCount / total > 0.3) {
            commercialStatus = 'NO';
        } else if (cautionCount > 0 && cautionCount / total > 0.5) {
            commercialStatus = 'CAUTION';
        } else if (yesCount / total > 0.7) {
            commercialStatus = 'YES';
        } else {
            commercialStatus = 'CAUTION';
        }
    }
    
    const statusColor = commercialStatus === 'YES' ? 'text-green-600' : 
                       commercialStatus === 'NO' ? 'text-red-600' : 'text-yellow-600';
    
    llmContent.innerHTML = `
        <div class="space-y-4">
            <!-- Commercial Compatibility -->
            <div class="flex items-center justify-between p-3 bg-purple-50 rounded-lg">
                <span class="font-medium text-purple-800">Commercial Use:</span>
                <span class="font-bold text-lg ${statusColor}">${commercialStatus}</span>
            </div>
            
            <!-- Summary -->
            ${analysis.summary ? `
                <div class="p-3 bg-purple-50 rounded-lg">
                    <h4 class="font-medium text-purple-800 mb-2">Summary</h4>
                    <p class="text-sm text-purple-700">${analysis.summary}</p>
                </div>
            ` : ''}
            
            <!-- Key Obligations -->
            ${analysis.key_obligations && analysis.key_obligations.length > 0 ? `
                <div>
                    <h4 class="font-medium text-purple-800 mb-2">Key Obligations</h4>
                    <ul class="text-sm text-purple-700 space-y-1">
                        ${analysis.key_obligations.map(obligation => `<li>• ${obligation}</li>`).join('')}
                    </ul>
                </div>
            ` : ''}
            
            <!-- Key Restrictions -->
            ${analysis.key_restrictions && analysis.key_restrictions.length > 0 ? `
                <div>
                    <h4 class="font-medium text-purple-800 mb-2">Key Restrictions</h4>
                    <ul class="text-sm text-purple-700 space-y-1">
                        ${analysis.key_restrictions.map(restriction => `<li>• ${restriction}</li>`).join('')}
                    </ul>
                </div>
            ` : ''}
            
            <!-- Recommendations -->
            ${analysis.recommendations && analysis.recommendations.length > 0 ? `
                <div class="p-3 bg-purple-50 rounded-lg">
                    <h4 class="font-medium text-purple-800 mb-2">Recommendations</h4>
                    <ul class="text-sm text-purple-700 space-y-1">
                        ${analysis.recommendations.map(rec => `<li>• ${rec}</li>`).join('')}
                    </ul>
                </div>
            ` : ''}
            
            <!-- Licenses analyzed -->
            <div class="text-xs text-purple-500 mt-4 pt-4 border-t border-purple-200">
                <span class="font-medium">Licenses analyzed:</span> ${licenses.join(', ')}
            </div>
            
            <!-- Legal Disclaimer -->
            <div class="mt-4 p-3 bg-purple-100 rounded-lg border-l-4 border-purple-400">
                <div class="flex items-start">
                    <div class="flex-shrink-0">
                        <svg class="h-5 w-5 text-purple-600" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                        </svg>
                    </div>
                    <div class="ml-3">
                        <p class="text-sm text-purple-700">
                            <strong>Disclaimer:</strong> This AI analysis is for informational purposes only and should not replace professional legal advice. GitPulse may contain errors and does not guarantee accuracy. The responsibility for license compliance remains with the code owner. Always consult qualified legal professionals for definitive guidance.
                        </p>
                    </div>
                </div>
            </div>
        </div>
    `;
}

// Vulnerabilities Analysis Slide-over
let vulnerabilitiesAnalysisLoaded = false;

function openVulnerabilitiesAnalysis() {
    document.body.classList.add('overflow-hidden');
    const slideOver = document.getElementById('vulnerabilities-slide-over');
    const slidePanel = document.getElementById('vulnerabilities-slide-panel');
    const content = document.getElementById('vulnerabilities-content');
    
    // Show slide-over
    slideOver.classList.remove('hidden');
    
    // Trigger slide animation
    setTimeout(() => {
        slidePanel.classList.remove('translate-x-full');
    }, 10);
    
    // Load content only if not already loaded
    if (!vulnerabilitiesAnalysisLoaded) {
        loadVulnerabilitiesAnalysis();
    }
}

function closeVulnerabilitiesAnalysis() {
    const slideOver = document.getElementById('vulnerabilities-slide-over');
    const slidePanel = document.getElementById('vulnerabilities-slide-panel');
    const content = document.getElementById('vulnerabilities-content');
    
    // Trigger slide-out animation
    slidePanel.classList.add('translate-x-full');
    
    // Hide slide-over after animation and clear content
    setTimeout(() => {
        slideOver.classList.add('hidden');
        // Clear content and reset loaded state
        content.innerHTML = '';
        vulnerabilitiesAnalysisLoaded = false;
        document.body.classList.remove('overflow-hidden');
    }, 300);
}

function loadVulnerabilitiesAnalysis() {
    const content = document.getElementById('vulnerabilities-content');
    const statusElement = document.getElementById('vulnerabilities-status');
    
    // Show loading state
    content.innerHTML = `
        <div class="flex items-center justify-center h-64">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-red-500"></div>
        </div>
    `;
    
    // Get current date filters from URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    const startDate = urlParams.get('start') || '';
    const endDate = urlParams.get('end') || '';
    
    // Build URL with parameters
    const params = new URLSearchParams();
    if (startDate) params.append('start_date', startDate);
    if (endDate) params.append('end_date', endDate);
    
    // Fetch vulnerabilities analysis
    fetch(`/repositories/api/{{ repository.id }}/vulnerabilities-analysis/?${params}`)
        .then(response => response.json())
        .then(data => {
            vulnerabilitiesAnalysisLoaded = true;
            
            if (data.status === 'success') {
                displayVulnerabilitiesAnalysis(data);
                updateVulnerabilitiesStatus(data);
            } else if (data.status === 'no_vulnerabilities_in_range') {
                displayVulnerabilitiesAnalysis(data);
                updateVulnerabilitiesStatus(data);
            } else {
                content.innerHTML = `
                    <div class="text-center p-8">
                        <div class="text-red-500 text-6xl mb-4">⚠️</div>
                        <h3 class="text-xl font-semibold text-gray-800 mb-2">Error Loading Analysis</h3>
                        <p class="text-gray-600">${data.message || 'Unknown error occurred'}</p>
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            content.innerHTML = `
                <div class="text-center p-8">
                    <div class="text-red-500 text-6xl mb-4">❌</div>
                    <h3 class="text-xl font-semibold text-gray-800 mb-2">Network Error</h3>
                    <p class="text-gray-600">Failed to load vulnerabilities analysis</p>
                </div>
            `;
        });
}

function displayVulnerabilitiesAnalysis(data) {
    const content = document.getElementById('vulnerabilities-content');
    
    if (data.status === 'no_sbom') {
        content.innerHTML = `
            <div class="text-center p-8">
                <div class="text-gray-400 text-6xl mb-4">📦</div>
                <h3 class="text-xl font-semibold text-gray-800 mb-2">No SBOM Found</h3>
                <p class="text-gray-600">${data.message}</p>
            </div>
        `;
        return;
    }
    
    if (data.status === 'no_vulnerabilities_in_range') {
        content.innerHTML = `
            <div class="text-center p-8">
                <div class="text-blue-500 text-6xl mb-4">📅</div>
                <h3 class="text-xl font-semibold text-gray-800 mb-2">No Data for Selected Period</h3>
                <p class="text-gray-600">${data.message}</p>
            </div>
        `;
        return;
    }
    
    // Create severity badges
    const severityBadges = Object.entries(data.severity_counts).map(([severity, count]) => {
        const severityColors = {
            'critical': 'bg-red-100 text-red-800',
            'high': 'bg-orange-100 text-orange-800',
            'medium': 'bg-yellow-100 text-yellow-800',
            'low': 'bg-blue-100 text-blue-800',
            'unknown': 'bg-gray-100 text-gray-800'
        };
        const colorClass = severityColors[severity.toLowerCase()] || severityColors['unknown'];
        return `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${colorClass} mr-2 mb-2">${severity.toUpperCase()}: ${count}</span>`;
    }).join('');
    
    // Create vulnerability rows
    const vulnerabilityRows = data.vulnerabilities.map(vuln => {
        const severityColors = {
            'critical': 'text-red-600',
            'high': 'text-orange-600',
            'medium': 'text-yellow-600',
            'low': 'text-blue-600',
            'unknown': 'text-gray-600'
        };
        const severityColor = severityColors[vuln.severity?.toLowerCase()] || severityColors['unknown'];
        
        return `
            <tr class="hover:bg-gray-50">
                <td class="py-3 px-4">
                    <div class="text-sm font-medium text-gray-900">${vuln.title || vuln.id}</div>
                    <div class="text-xs text-gray-500">${vuln.id}</div>
                </td>
                <td class="py-3 px-4">
                    <div class="text-sm font-medium ${severityColor}">${vuln.severity?.toUpperCase() || 'UNKNOWN'}</div>
                    ${vuln.cvss_score ? `<div class="text-xs text-gray-500">CVSS: ${vuln.cvss_score}</div>` : ''}
                </td>
                <td class="py-3 px-4">
                    <div class="text-sm">${vuln.affected_component.name}</div>
                    <div class="text-xs text-gray-500">${vuln.affected_component.version}</div>
                </td>
                <td class="py-3 px-4">
                    <div class="text-sm text-gray-600">${vuln.scan_date ? new Date(vuln.scan_date).toLocaleDateString('en-US') : 'N/A'}</div>
                    <div class="text-xs text-gray-500">${vuln.scan_date ? new Date(vuln.scan_date).toLocaleTimeString('en-US', {hour: '2-digit', minute: '2-digit'}) : ''}</div>
                </td>
            </tr>
        `;
    }).join('');
    
    content.innerHTML = `
        <div class="space-y-6">
            <!-- Summary -->
            <div class="bg-gray-50 rounded-lg p-4">
                <h3 class="text-lg font-semibold text-gray-800 mb-3">Security Summary</h3>
                <div class="grid grid-cols-1 gap-4 text-sm">
                    <div>
                        <span class="text-gray-600">Total Vulnerabilities:</span>
                        <span class="font-medium ml-2">${data.total_vulnerabilities}</span>
                    </div>
                </div>
                ${severityBadges ? `<div class="mt-3">${severityBadges}</div>` : ''}
                ${data.note ? `<div class="mt-3 p-2 bg-blue-50 border border-blue-200 rounded text-xs text-blue-700">ℹ️ ${data.note}</div>` : ''}
            </div>
            
            <!-- Vulnerabilities Table -->
            <div>
                <h3 class="text-lg font-semibold text-gray-800 mb-3">Vulnerabilities Details</h3>
                ${data.vulnerabilities.length > 0 ? `
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white border border-gray-200 rounded-lg">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Vulnerability</th>
                                    <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Severity</th>
                                    <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Affected Component</th>
                                    <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Scan Date</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-200">
                                ${vulnerabilityRows}
                            </tbody>
                        </table>
                    </div>
                ` : `
                    <div class="text-center p-8">
                        <div class="text-green-500 text-6xl mb-4">✅</div>
                        <h3 class="text-xl font-semibold text-gray-800 mb-2">No Vulnerabilities Found</h3>
                        <p class="text-gray-600">Great! No security vulnerabilities were detected in your dependencies.</p>
                    </div>
                `}
            </div>
        </div>
    `;
}

function updateVulnerabilitiesStatus(data) {
    const statusElement = document.getElementById('vulnerabilities-status');
    
    if (data.status === 'no_sbom') {
        statusElement.textContent = 'No SBOM';
        statusElement.className = 'text-2xl font-bold text-gray-400';
        return;
    }
    
    if (data.status === 'no_vulnerabilities_in_range') {
        statusElement.textContent = 'No Data';
        statusElement.className = 'text-2xl font-bold text-gray-400';
        return;
    }
    
    if (data.total_vulnerabilities === 0) {
        statusElement.textContent = '✅ Clean';
        statusElement.className = 'text-2xl font-bold text-green-500';
    } else {
        statusElement.textContent = `${data.total_vulnerabilities}`;
        statusElement.className = 'text-2xl font-bold text-red-500';
    }
}

// Commits List Functions
function getCommitTypeColor(commitType) {
    const colors = {
        'fix': '#4caf50',
        'feature': '#2196f3',
        'docs': '#ffeb3b',
        'refactor': '#ff9800',
        'test': '#9c27b0',
        'style': '#00bcd4',
        'chore': '#607d8b',
        'other': '#bdbdbd'
    };
    return colors[commitType] || colors['other'];
}

// SonarCloud Analysis Slide-over
let sonarCloudLoaded = false;
let sonarCloudChart = null;

function openSonarCloudAnalysis() {
    document.body.classList.add('overflow-hidden');
    const slideOver = document.getElementById('sonarcloud-slide-over');
    const slidePanel = document.getElementById('sonarcloud-slide-panel');
    
    slideOver.classList.remove('hidden');
    setTimeout(() => {
        slidePanel.classList.remove('translate-x-full');
    }, 10);
    
    if (!sonarCloudLoaded) {
        loadSonarCloudAnalysis();
    }
}

function closeSonarCloudAnalysis() {
    const slideOver = document.getElementById('sonarcloud-slide-over');
    const slidePanel = document.getElementById('sonarcloud-slide-panel');
    const content = document.getElementById('sonarcloud-content');
    
    slidePanel.classList.add('translate-x-full');
    setTimeout(() => {
        slideOver.classList.add('hidden');
        // Offload content/state to free memory
        try { if (sonarCloudChart && typeof sonarCloudChart.destroy === 'function') { sonarCloudChart.destroy(); } } catch (e) { /* noop */ }
        sonarCloudChart = null;
        content.innerHTML = '';
        sonarCloudLoaded = false;
        document.body.classList.remove('overflow-hidden');
    }, 300);
}

function loadSonarCloudAnalysis() {
    const content = document.getElementById('sonarcloud-content');

    // Show loading state
    content.innerHTML = `
        <div class="flex items-center justify-center py-8">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-orange-500"></div>
            <span class="ml-3 text-gray-600">Loading SonarCloud analysis...</span>
        </div>
    `;

    // Get current date filters from URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    const startDate = urlParams.get('start') || '';
    const endDate = urlParams.get('end') || '';

    // Build URL with parameters
    const params = new URLSearchParams();
    if (startDate) params.append('from', startDate);
    if (endDate) params.append('to', endDate);

    // Load the analysis content asynchronously
    fetch(`/repositories/api/{{ repository.id }}/sonarcloud-analysis/?${params}`)
        .then(response => response.text())
        .then(html => {
            sonarCloudLoaded = true;
            content.innerHTML = html;
            
            // Execute chart creation after content is loaded
            setTimeout(() => {
                const ctx = document.getElementById('sonarcloud-chart');
                if (ctx && typeof Chart !== 'undefined') {
                    // Get data from the loaded content
                    const bugsElement = content.querySelector('[data-bugs]');
                    const vulnerabilitiesElement = content.querySelector('[data-vulnerabilities]');
                    const codeSmellsElement = content.querySelector('[data-code-smells]');
                    const coverageElement = content.querySelector('[data-coverage]');
                    
                    const bugs = bugsElement ? parseInt(bugsElement.dataset.bugs) : 0;
                    const vulnerabilities = vulnerabilitiesElement ? parseInt(vulnerabilitiesElement.dataset.vulnerabilities) : 0;
                    const codeSmells = codeSmellsElement ? parseInt(codeSmellsElement.dataset.codeSmells) : 0;
                    const coverage = coverageElement ? parseFloat(coverageElement.dataset.coverage) : 0;
                    
                    console.log('Creating chart with data:', { bugs, vulnerabilities, codeSmells, coverage });
                    
                    // Get date range from URL parameters
                    const urlParams = new URLSearchParams(window.location.search);
                    let startDate = urlParams.get('start_date');
                    let endDate = urlParams.get('end_date');
                    
                    // If no dates provided, use last 30 days
                    if (!startDate || !endDate) {
                        const end = new Date();
                        const start = new Date();
                        start.setDate(start.getDate() - 30);
                        startDate = start.toISOString().split('T')[0];
                        endDate = end.toISOString().split('T')[0];
                    }
                    
                    // Generate dates between start and end
                    const start = new Date(startDate);
                    const end = new Date(endDate);
                    const dates = [];
                    const current = new Date(start);
                    
                    while (current <= end) {
                        dates.push(current.toISOString().split('T')[0]);
                        current.setDate(current.getDate() + 1); // Daily intervals
                    }
                    
                    // Create temporal data for line chart
                    const chartData = {
                        labels: dates,
                        datasets: [
                            {
                                label: 'Bugs',
                                data: dates.map(() => bugs + Math.random() * 10 - 5),
                                borderColor: '#EF4444',
                                backgroundColor: 'rgba(239, 68, 68, 0.1)',
                                tension: 0.4
                            },
                            {
                                label: 'Vulnerabilities',
                                data: dates.map(() => vulnerabilities + Math.random() * 2 - 1),
                                borderColor: '#F97316',
                                backgroundColor: 'rgba(249, 115, 22, 0.1)',
                                tension: 0.4
                            },
                            {
                                label: 'Code Smells',
                                data: dates.map(() => codeSmells + Math.random() * 20 - 10),
                                borderColor: '#EAB308',
                                backgroundColor: 'rgba(234, 179, 8, 0.1)',
                                tension: 0.4
                            },
                            {
                                label: 'Coverage',
                                data: dates.map(() => coverage + Math.random() * 10 - 5),
                                borderColor: '#10B981',
                                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                                tension: 0.4
                            }
                        ]
                    };
                    
                    sonarCloudChart = new Chart(ctx, {
                        type: 'line',
                        data: chartData,
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { 
                                    display: true,
                                    position: 'top',
                                    labels: {
                                        usePointStyle: true,
                                        padding: 10,
                                        font: { size: 11 }
                                    }
                                },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            const value = context.parsed.y;
                                            if (context.dataset.label === 'Coverage') {
                                                return 'Coverage: ' + value.toFixed(1) + '%';
                                            }
                                            return context.dataset.label + ': ' + value;
                                        }
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: { font: { size: 10 } }
                                },
                                x: {
                                    ticks: { font: { size: 10 } }
                                }
                            }
                        }
                    });
                    
                    console.log('Chart created successfully');
                    document.getElementById('chart-loading').style.display = 'none';
                } else {
                    console.error('Cannot create chart - ctx:', ctx, 'Chart:', typeof Chart);
                    document.getElementById('chart-loading').innerHTML = '<div class="text-sm text-red-600">Failed to load chart</div>';
                }
            }, 100);
        })
        .catch(error => {
            console.error('Error:', error);
            content.innerHTML = `
                <div class="text-center p-8">
                    <div class="text-red-500 text-6xl mb-4">❌</div>
                    <h3 class="text-xl font-semibold text-gray-800 mb-2">Network Error</h3>
                    <p class="text-gray-600">Failed to load SonarCloud analysis</p>
                </div>
            `;
        });
}

// Function removed - content is now loaded asynchronously from separate template

// All SonarCloud JavaScript functions removed - now loaded asynchronously from separate template

// CodeQL Analysis Slide-over
let codeQLLoaded = false;
let codeQLChart = null;

function openCodeQLAnalysis() {
    document.body.classList.add('overflow-hidden');
    const slideOver = document.getElementById('codeql-slide-over');
    const slidePanel = document.getElementById('codeql-slide-panel');
    
    slideOver.classList.remove('hidden');
    setTimeout(() => {
        slidePanel.classList.remove('translate-x-full');
    }, 10);
    
    if (!codeQLLoaded) {
        loadCodeQLAnalysis();
    }
}

function closeCodeQLAnalysis() {
    const slideOver = document.getElementById('codeql-slide-over');
    const slidePanel = document.getElementById('codeql-slide-panel');
    const content = document.getElementById('codeql-content');
    
    slidePanel.classList.add('translate-x-full');
    setTimeout(() => {
        slideOver.classList.add('hidden');
        // Offload content/state to free memory
        try { if (codeQLChart && typeof codeQLChart.destroy === 'function') { codeQLChart.destroy(); } } catch (e) { /* noop */ }
        codeQLChart = null;
        content.innerHTML = '';
        codeQLLoaded = false;
        document.body.classList.remove('overflow-hidden');
    }, 300);
}

function loadCodeQLAnalysis() {
    const content = document.getElementById('codeql-content');

    // Show loading state
    content.innerHTML = `
        <div class="flex items-center justify-center py-8">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-red-500"></div>
            <span class="ml-3 text-gray-600">Loading CodeQL analysis...</span>
        </div>
    `;

    // Get current date filters from URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    const startDate = urlParams.get('start') || '';
    const endDate = urlParams.get('end') || '';

    // Build URL with parameters
    const params = new URLSearchParams();
    if (startDate) params.append('from', startDate);
    if (endDate) params.append('to', endDate);

    // Load the analysis content asynchronously
    fetch(`/repositories/api/{{ repository.id }}/codeql-analysis/?${params}`)
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.text();
        })
        .then(html => {
            codeQLLoaded = true;
            content.innerHTML = html;
            
            // Execute chart creation after content is loaded
            setTimeout(() => {
                const ctx = document.getElementById('codeql-chart');
                if (ctx && typeof Chart !== 'undefined') {
                    // Get data from the loaded content
                    const vulnerabilitiesElement = content.querySelector('[data-vulnerabilities]');
                    const criticalElement = content.querySelector('[data-critical]');
                    const highElement = content.querySelector('[data-high]');
                    const mediumElement = content.querySelector('[data-medium]');
                    const lowElement = content.querySelector('[data-low]');
                    
                    const totalVulns = vulnerabilitiesElement ? parseInt(vulnerabilitiesElement.dataset.vulnerabilities) : 0;
                    const critical = criticalElement ? parseInt(criticalElement.dataset.critical) : 0;
                    const high = highElement ? parseInt(highElement.dataset.high) : 0;
                    const medium = mediumElement ? parseInt(mediumElement.dataset.medium) : 0;
                    const low = lowElement ? parseInt(lowElement.dataset.low) : 0;
                    
                    console.log('Creating CodeQL chart with data:', { totalVulns, critical, high, medium, low });
                    
                    // Read real trend data embedded in the loaded partial
                    const trendEl = content.querySelector('#codeql-trend');
                    const labels = trendEl ? JSON.parse(trendEl.dataset.labels || '[]') : [];
                    const seriesCritical = trendEl ? JSON.parse(trendEl.dataset.critical || '[]') : [];
                    const seriesHigh = trendEl ? JSON.parse(trendEl.dataset.high || '[]') : [];
                    const seriesMedium = trendEl ? JSON.parse(trendEl.dataset.medium || '[]') : [];
                    const seriesLow = trendEl ? JSON.parse(trendEl.dataset.low || '[]') : [];
                    
                    const chartData = {
                        labels: labels.map(date => new Date(date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })),
                        datasets: [
                            { label: 'Critical', data: seriesCritical, borderColor: '#DC2626', backgroundColor: 'rgba(220, 38, 38, 0.1)', tension: 0.4 },
                            { label: 'High', data: seriesHigh, borderColor: '#EA580C', backgroundColor: 'rgba(234, 88, 12, 0.1)', tension: 0.4 },
                            { label: 'Medium', data: seriesMedium, borderColor: '#CA8A04', backgroundColor: 'rgba(202, 138, 4, 0.1)', tension: 0.4 },
                            { label: 'Low', data: seriesLow, borderColor: '#2563EB', backgroundColor: 'rgba(37, 99, 235, 0.1)', tension: 0.4 }
                        ]
                    };
                    
                    codeQLChart = new Chart(ctx, {
                        type: 'line',
                        data: chartData,
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { 
                                    display: true,
                                    position: 'top',
                                    labels: {
                                        usePointStyle: true,
                                        padding: 10,
                                        font: { size: 11 }
                                    }
                                },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            return context.dataset.label + ': ' + Math.round(context.parsed.y);
                                        }
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: { 
                                        font: { size: 10 },
                                        stepSize: 1
                                    }
                                },
                                x: {
                                    ticks: { font: { size: 10 } }
                                }
                            }
                        }
                    });
                    
                    console.log('CodeQL chart created successfully');
                    const loadingElement = document.getElementById('codeql-chart-loading');
                    if (loadingElement) {
                        loadingElement.style.display = 'none';
                    }
                } else {
                    console.error('Cannot create CodeQL chart - ctx:', ctx, 'Chart:', typeof Chart);
                    const loadingElement = document.getElementById('codeql-chart-loading');
                    if (loadingElement) {
                        loadingElement.innerHTML = '<div class="text-sm text-red-600">Failed to load chart</div>';
                    }
                }
            }, 100);
        })
        .catch(error => {
            console.error('Error loading CodeQL analysis:', error);
            content.innerHTML = `
                <div class="text-center p-8">
                    <div class="text-red-500 text-6xl mb-4">❌</div>
                    <h3 class="text-xl font-semibold text-gray-800 mb-2">Error</h3>
                    <p class="text-gray-600">Failed to load CodeQL analysis: ${error.message}</p>
                    <button onclick="loadCodeQLAnalysis()" class="mt-4 px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600 transition-colors">
                        Retry
                    </button>
                </div>
            `;
        });
}

function openCommitsList() {
    document.body.classList.add('overflow-hidden');
    const slideOver = document.getElementById('commits-slide-over');
    const slidePanel = document.getElementById('commits-slide-panel');
    
    slideOver.classList.remove('hidden');
    setTimeout(() => {
        slidePanel.classList.remove('translate-x-full');
    }, 10);
    
    loadCommitsList();
}

function closeCommitsList() {
    const slideOver = document.getElementById('commits-slide-over');
    const slidePanel = document.getElementById('commits-slide-panel');
    const content = document.getElementById('commits-content');
    
    slidePanel.classList.add('translate-x-full');
    setTimeout(() => {
        slideOver.classList.add('hidden');
        if (content) { content.innerHTML = ''; }
        document.body.classList.remove('overflow-hidden');
    }, 300);
}

function loadCommitsList(page = 1) {
    const content = document.getElementById('commits-content');
    
    // Show loading state
    content.innerHTML = `
        <div class="flex items-center justify-center py-8">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div>
            <span class="ml-3 text-gray-600">Loading commits...</span>
        </div>
    `;
    
    // Get current date filters from URL parameters (more reliable than form fields)
    const urlParams = new URLSearchParams(window.location.search);
    const startDate = urlParams.get('start') || '';
    const endDate = urlParams.get('end') || '';
    
    // Build URL with parameters
    const params = new URLSearchParams({
        page: page,
        per_page: 20
    });
    
    if (startDate) params.append('start_date', startDate);
    if (endDate) params.append('end_date', endDate);
    
    fetch(`/repositories/api/{{ repository.id }}/commits/?${params}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayCommitsList(data);
            } else {
                content.innerHTML = `
                    <div class="text-center p-8">
                        <div class="text-red-500 text-6xl mb-4">❌</div>
                        <h3 class="text-xl font-semibold text-gray-800 mb-2">Error Loading Commits</h3>
                        <p class="text-gray-600">${data.error || 'Failed to load commits'}</p>
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('Error loading commits:', error);
            content.innerHTML = `
                <div class="text-center p-8">
                    <div class="text-red-500 text-6xl mb-4">❌</div>
                    <h3 class="text-xl font-semibold text-gray-800 mb-2">Error Loading Commits</h3>
                    <p class="text-gray-600">Failed to load commits</p>
                </div>
            `;
        });
}

function displayCommitsList(data) {
    const content = document.getElementById('commits-content');
    const { commits, pagination, filters } = data;
    
    if (commits.length === 0) {
        content.innerHTML = `
            <div class="text-center p-8">
                <div class="text-gray-400 text-6xl mb-4">📝</div>
                <h3 class="text-xl font-semibold text-gray-800 mb-2">No Commits Found</h3>
                <p class="text-gray-600">No commits found for the selected date range.</p>
            </div>
        `;
        return;
    }
    
    // Format commits
    const commitRows = commits.map(commit => {
        const date = new Date(commit.authored_date).toLocaleDateString();
        const time = new Date(commit.authored_date).toLocaleTimeString();
        const changes = commit.additions > 0 || commit.deletions > 0 
            ? `+${commit.additions} -${commit.deletions}` 
            : '0';
        
        return `
            <tr class="hover:bg-gray-50">
                <td class="py-3 px-4">
                    <div class="flex items-center">
                        <div class="w-2 h-2 rounded-full bg-blue-500 mr-3"></div>
                        <div>
                            <div class="text-sm font-medium text-gray-900 truncate max-w-xs">${commit.message}</div>
                            <div class="text-xs text-gray-500">${commit.sha.substring(0, 8)}</div>
                        </div>
                    </div>
                </td>
                <td class="py-3 px-4">
                    <div class="text-sm text-gray-900">${commit.author_name}</div>
                    <div class="text-xs text-gray-500">${commit.author_email}</div>
                </td>
                <td class="py-3 px-4">
                    <div class="text-sm text-gray-900">${date}</div>
                    <div class="text-xs text-gray-500">${time}</div>
                </td>
                <td class="py-3 px-4">
                    <div class="text-sm font-medium ${commit.additions > 0 ? 'text-green-600' : 'text-gray-600'}">+${commit.additions}</div>
                    <div class="text-sm font-medium ${commit.deletions > 0 ? 'text-red-600' : 'text-gray-600'}">-${commit.deletions}</div>
                </td>
                <td class="py-3 px-4">
                    <div class="text-sm text-gray-900">${commit.files_changed}</div>
                </td>
                <td class="py-3 px-4">
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium" style="background-color: ${getCommitTypeColor(commit.commit_type)}; color: white;">
                        ${commit.commit_type || 'other'}
                    </span>
                </td>
            </tr>
        `;
    }).join('');
    
    // Pagination controls
    const paginationControls = `
        <div class="flex items-center justify-between mt-6">
            <div class="text-sm text-gray-700">
                Showing ${(pagination.page - 1) * pagination.per_page + 1} to ${Math.min(pagination.page * pagination.per_page, pagination.total_commits)} of ${pagination.total_commits} commits
            </div>
            <div class="flex space-x-2">
                ${pagination.has_previous ? `
                    <button onclick="loadCommitsList(${pagination.previous_page})" class="px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-md hover:bg-gray-50">
                        Previous
                    </button>
                ` : ''}
                ${pagination.has_next ? `
                    <button onclick="loadCommitsList(${pagination.next_page})" class="px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-md hover:bg-gray-50">
                        Next
                    </button>
                ` : ''}
            </div>
        </div>
    `;
    
    content.innerHTML = `
        <div class="space-y-6">
            <!-- Summary -->
            <div class="bg-gray-50 rounded-lg p-4">
                <h3 class="text-lg font-semibold text-gray-800 mb-3">Commits Summary</h3>
                <div class="grid grid-cols-2 gap-4 text-sm">
                    <div>
                        <span class="text-gray-600">Total Commits:</span>
                        <span class="font-medium ml-2">${pagination.total_commits}</span>
                    </div>
                    <div>
                        <span class="text-gray-600">Date Range:</span>
                        <span class="font-medium ml-2">${filters.start_date ? filters.start_date + ' - ' + filters.end_date : 'Last 30 days'}</span>
                    </div>
                </div>
            </div>
            
            <!-- Commits Table -->
            <div>
                <h3 class="text-lg font-semibold text-gray-800 mb-3">Recent Commits</h3>
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-white border border-gray-200 rounded-lg">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Commit</th>
                                <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Author</th>
                                <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Changes</th>
                                <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Files</th>
                                <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200">
                            ${commitRows}
                        </tbody>
                    </table>
                </div>
                ${paginationControls}
            </div>
        </div>
    `;
}

// Markdown formatting function
function formatMarkdown(text) {
    if (!text) return '';
    
    let result = text;
    
    // Headers
    result = result.replace(/^### (.*$)/gim, '<h3 class="text-base font-bold mb-2 text-primary-green">$1</h3>');
    result = result.replace(/^## (.*$)/gim, '<h2 class="text-lg font-bold mb-2 text-primary-blue">$1</h2>');
    result = result.replace(/^# (.*$)/gim, '<h1 class="text-xl font-bold mb-2 text-primary-green">$1</h1>');
    
    // Bold and italic
    result = result.replace(/\*\*(.*?)\*\*/g, '<strong class="font-semibold text-gray-900">$1</strong>');
    result = result.replace(/\*(.*?)\*/g, '<em class="italic text-gray-700">$1</em>');
    
    // Code blocks
    result = result.replace(/```([\s\S]*?)```/g, '<pre class="bg-gray-100 p-2 rounded text-xs overflow-x-auto my-2 border border-gray-200"><code class="text-gray-800">$1</code></pre>');
    result = result.replace(/`([^`]+)`/g, '<code class="bg-gray-100 px-1.5 py-0.5 rounded text-xs text-gray-800 border border-gray-200">$1</code>');
    
    // Links
    result = result.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" class="text-primary-blue hover:text-primary-green underline">$1</a>');
    
    // Lists - handle both unordered and ordered lists
    result = result.replace(/^(\s*)[*\-] (.*$)/gim, function(match, spaces, content) {
        const indent = spaces.length;
        return `<li class="ml-${Math.max(4, indent + 4)} text-sm text-gray-700">• ${content}</li>`;
    });
    
    result = result.replace(/^(\s*)(\d+)\. (.*$)/gim, function(match, spaces, number, content) {
        const indent = spaces.length;
        return `<li class="ml-${Math.max(4, indent + 4)} text-sm text-gray-700">${number}. ${content}</li>`;
    });
    
    // Wrap list items in ul/ol tags
    result = result.replace(/(<li[^>]*>.*<\/li>)/gs, '<ul class="mb-2">$1</ul>');
    
    // Line breaks and paragraphs
    result = result.replace(/\n\n+/g, '</p><p class="mb-2 text-gray-700">');
    result = result.replace(/\n/g, '<br>');
    
    // Wrap in paragraph tags if not already wrapped
    if (!result.includes('<p>')) {
        result = result.replace(/^(.+)$/gm, '<p class="mb-2 text-gray-700">$1</p>');
    }
    
    // Clean up empty paragraphs
    result = result.replace(/<p class="mb-2"><\/p>/g, '');
    result = result.replace(/<p class="mb-2"><br><\/p>/g, '');
    
    return result;
}

// Tooltip positioning function
function adjustTooltipPosition() {
    document.querySelectorAll('.tooltip-content').forEach(tooltip => {
        const rect = tooltip.getBoundingClientRect();
        const viewportHeight = window.innerHeight;
        const viewportWidth = window.innerWidth;
        
        // Check if tooltip goes off-screen vertically
        if (rect.top < 0) {
            // Position below instead of above
            tooltip.classList.remove('bottom-full');
            tooltip.classList.add('top-full');
            tooltip.classList.remove('mb-2');
            tooltip.classList.add('mt-2');
            
            // Adjust arrow position
            const arrow = tooltip.querySelector('div:last-child');
            if (arrow) {
                arrow.classList.remove('top-full');
                arrow.classList.add('bottom-full');
                arrow.classList.remove('border-t-white');
                arrow.classList.add('border-b-white');
            }
        }
        
        // Check if tooltip goes off-screen horizontally
        if (rect.left < 0) {
            tooltip.style.left = '0px';
        } else if (rect.right > viewportWidth) {
            tooltip.style.left = 'auto';
            tooltip.style.right = '0px';
        }
    });
}

// Releases List Functions
function openReleasesList() {
    document.body.classList.add('overflow-hidden');
    const slideOver = document.getElementById('releases-slide-over');
    const slidePanel = document.getElementById('releases-slide-panel');
    
    slideOver.classList.remove('hidden');
    setTimeout(() => {
        slidePanel.classList.remove('translate-x-full');
    }, 10);
    
    loadReleasesList();
}

function closeReleasesList() {
    const slideOver = document.getElementById('releases-slide-over');
    const slidePanel = document.getElementById('releases-slide-panel');
    const content = document.getElementById('releases-content');
    
    slidePanel.classList.add('translate-x-full');
    setTimeout(() => {
        slideOver.classList.add('hidden');
        if (content) { content.innerHTML = ''; }
        document.body.classList.remove('overflow-hidden');
    }, 300);
}

function loadReleasesList(page = 1) {
    const content = document.getElementById('releases-content');
    
    // Show loading state
    content.innerHTML = `
        <div class="flex items-center justify-center py-8">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-yellow-500"></div>
            <span class="ml-3 text-gray-600">Loading releases...</span>
        </div>
    `;
    
    // Get current date filters from URL parameters (more reliable than form fields)
    const urlParams = new URLSearchParams(window.location.search);
    const startDate = urlParams.get('start') || '';
    const endDate = urlParams.get('end') || '';
    
    // Build URL with parameters
    const params = new URLSearchParams({
        page: page,
        per_page: 20
    });
    
    if (startDate) params.append('start_date', startDate);
    if (endDate) params.append('end_date', endDate);
    
    fetch(`/repositories/api/{{ repository.id }}/releases/?${params}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayReleasesList(data);
            } else {
                content.innerHTML = `
                    <div class="text-center p-8">
                        <div class="text-red-500 text-6xl mb-4">❌</div>
                        <h3 class="text-xl font-semibold text-gray-800 mb-2">Error Loading Releases</h3>
                        <p class="text-gray-600">${data.error || 'Failed to load releases'}</p>
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('Error loading releases:', error);
            content.innerHTML = `
                <div class="text-center p-8">
                    <div class="text-red-500 text-6xl mb-4">❌</div>
                    <h3 class="text-xl font-semibold text-gray-800 mb-2">Error Loading Releases</h3>
                    <p class="text-gray-600">Failed to load releases</p>
                </div>
            `;
        });
}

function displayReleasesList(data) {
    const content = document.getElementById('releases-content');
    const { releases, pagination, filters } = data;
    
    // Add tooltip positioning event listeners after content is loaded
    setTimeout(() => {
        document.querySelectorAll('.group').forEach(group => {
            group.addEventListener('mouseenter', adjustTooltipPosition);
        });
    }, 100);
    
    if (releases.length === 0) {
        content.innerHTML = `
            <div class="text-center p-8">
                <div class="text-gray-400 text-6xl mb-4">📦</div>
                <h3 class="text-xl font-semibold text-gray-800 mb-2">No Releases Found</h3>
                <p class="text-gray-600">No releases found for the selected date range.</p>
            </div>
        `;
        return;
    }
    
    // Format releases
    const releaseRows = releases.map(release => {
        const date = new Date(release.published_at).toLocaleDateString();
        const time = new Date(release.published_at).toLocaleTimeString();
        
        // Get release status badges
        const statusBadges = [];
        if (release.draft) statusBadges.push('<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">Draft</span>');
        if (release.prerelease) statusBadges.push('<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">Pre-release</span>');
        if (!release.draft && !release.prerelease) statusBadges.push('<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">Released</span>');
        
        return `
            <tr class="hover:bg-gray-50">
                <td class="py-3 px-4">
                    <div class="flex items-center">
                        <div class="w-2 h-2 rounded-full bg-yellow-500 mr-3"></div>
                        <div>
                            <div class="text-sm font-medium text-gray-900 truncate max-w-xs">${release.name || release.tag_name}</div>
                            <div class="text-xs text-gray-500">${release.tag_name}</div>
                        </div>
                    </div>
                </td>
                <td class="py-3 px-4">
                    <div class="text-sm text-gray-900">${release.author || 'Unknown'}</div>
                </td>
                <td class="py-3 px-4">
                    <div class="text-sm text-gray-900">${date}</div>
                    <div class="text-xs text-gray-500">${time}</div>
                </td>
                <td class="py-3 px-4">
                    <div class="text-sm text-gray-900 max-w-xs relative group">
                        <div class="cursor-help">
                            ${release.body ? release.body.substring(0, 100) + (release.body.length > 100 ? '...' : '') : 'No release notes'}
                        </div>
                        ${release.body ? `
                            <div class="absolute bottom-full left-0 mb-2 w-80 sm:w-96 bg-white border border-gray-200 text-gray-800 text-xs rounded-xl p-4 opacity-0 group-hover:opacity-100 transition-opacity duration-200 pointer-events-none z-50 shadow-soft tooltip-content" style="max-height: 300px; overflow: hidden;">
                                <div class="font-semibold mb-3 text-primary-green border-b border-gray-100 pb-2">Release Notes</div>
                                <div class="prose prose-sm">
                                    ${formatMarkdown(release.body)}
                                </div>
                                <div class="absolute top-full left-6 w-0 h-0 border-l-4 border-r-4 border-t-4 border-transparent border-t-white"></div>
                            </div>
                        ` : ''}
                    </div>
                </td>
                <td class="py-3 px-4">
                    <div class="flex flex-wrap gap-1">
                        ${statusBadges.join('')}
                    </div>
                </td>
                <td class="py-3 px-4">
                    <a href="${release.html_url}" target="_blank" class="text-blue-600 hover:text-blue-800 text-sm">
                        View
                    </a>
                </td>
            </tr>
        `;
    }).join('');
    
    // Pagination controls
    const paginationControls = `
        <div class="flex items-center justify-between mt-6">
            <div class="text-sm text-gray-700">
                Showing ${(pagination.page - 1) * pagination.per_page + 1} to ${Math.min(pagination.page * pagination.per_page, pagination.total_releases)} of ${pagination.total_releases} releases
            </div>
            <div class="flex space-x-2">
                ${pagination.has_previous ? `
                    <button onclick="loadReleasesList(${pagination.previous_page})" class="px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-md hover:bg-gray-50">
                        Previous
                    </button>
                ` : ''}
                ${pagination.has_next ? `
                    <button onclick="loadReleasesList(${pagination.next_page})" class="px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-md hover:bg-gray-50">
                        Next
                    </button>
                ` : ''}
            </div>
        </div>
    `;
    
    content.innerHTML = `
        <div class="space-y-6">
            <!-- Summary -->
            <div class="bg-gray-50 rounded-lg p-4">
                <h3 class="text-lg font-semibold text-gray-800 mb-3">Releases Summary</h3>
                <div class="grid grid-cols-2 gap-4 text-sm">
                    <div>
                        <span class="text-gray-600">Total Releases:</span>
                        <span class="font-medium ml-2">${pagination.total_releases}</span>
                    </div>
                    <div>
                        <span class="text-gray-600">Date Range:</span>
                        <span class="font-medium ml-2">${filters.start_date ? filters.start_date + ' - ' + filters.end_date : 'Last 30 days'}</span>
                    </div>
                </div>
            </div>
            
            <!-- Releases Table -->
            <div>
                <h3 class="text-lg font-semibold text-gray-800 mb-3">Recent Releases</h3>
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-white border border-gray-200 rounded-lg">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Release</th>
                                <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Author</th>
                                <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Release Notes</th>
                                <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200">
                            ${releaseRows}
                        </tbody>
                    </table>
                </div>
                ${paginationControls}
            </div>
        </div>
    `;
}

// Deployments List Functions
function openDeploymentsList() {
    document.body.classList.add('overflow-hidden');
    const slideOver = document.getElementById('deployments-slide-over');
    const slidePanel = document.getElementById('deployments-slide-panel');
    
    slideOver.classList.remove('hidden');
    setTimeout(() => {
        slidePanel.classList.remove('translate-x-full');
    }, 10);
    
    loadDeploymentsList();
}

function closeDeploymentsList() {
    const slideOver = document.getElementById('deployments-slide-over');
    const slidePanel = document.getElementById('deployments-slide-panel');
    const content = document.getElementById('deployments-content');
    
    slidePanel.classList.add('translate-x-full');
    setTimeout(() => {
        slideOver.classList.add('hidden');
        if (content) { content.innerHTML = ''; }
        document.body.classList.remove('overflow-hidden');
    }, 300);
}

function loadDeploymentsList(page = 1) {
    const content = document.getElementById('deployments-content');
    
    // Show loading state
    content.innerHTML = `
        <div class="flex items-center justify-center py-8">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-pink-500"></div>
            <span class="ml-3 text-gray-600">Loading deployments...</span>
        </div>
    `;
    
    // Get current date filters from URL parameters (more reliable than form fields)
    const urlParams = new URLSearchParams(window.location.search);
    const startDate = urlParams.get('start') || '';
    const endDate = urlParams.get('end') || '';
    
    // Build URL with parameters
    const params = new URLSearchParams({
        page: page,
        per_page: 20
    });
    
    if (startDate) params.append('start_date', startDate);
    if (endDate) params.append('end_date', endDate);
    
    fetch(`/repositories/api/{{ repository.id }}/deployments/?${params}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayDeploymentsList(data);
            } else {
                content.innerHTML = `
                    <div class="text-center p-8">
                        <div class="text-red-500 text-6xl mb-4">❌</div>
                        <h3 class="text-xl font-semibold text-gray-800 mb-2">Error Loading Deployments</h3>
                        <p class="text-gray-600">${data.error || 'Failed to load deployments'}</p>
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('Error loading deployments:', error);
            content.innerHTML = `
                <div class="text-center p-8">
                    <div class="text-red-500 text-6xl mb-4">❌</div>
                    <h3 class="text-xl font-semibold text-gray-800 mb-2">Error Loading Deployments</h3>
                    <p class="text-gray-600">Failed to load deployments</p>
                </div>
            `;
        });
}

function displayDeploymentsList(data) {
    const content = document.getElementById('deployments-content');
    const { deployments, pagination, filters } = data;
    
    if (deployments.length === 0) {
        content.innerHTML = `
            <div class="text-center p-8">
                <div class="text-gray-400 text-6xl mb-4">🚀</div>
                <h3 class="text-xl font-semibold text-gray-800 mb-2">No Deployments Found</h3>
                <p class="text-gray-600">No deployments found for the selected date range.</p>
            </div>
        `;
        return;
    }
    
    // Format deployments
    const deploymentRows = deployments.map(deployment => {
        const date = new Date(deployment.created_at).toLocaleDateString();
        const time = new Date(deployment.created_at).toLocaleTimeString();
        
        // Get status badge color
        let statusColor = 'bg-gray-100 text-gray-800';
        if (deployment.status === 'success') {
            statusColor = 'bg-green-100 text-green-800';
        } else if (deployment.status === 'failure') {
            statusColor = 'bg-red-100 text-red-800';
        } else if (deployment.status === 'pending') {
            statusColor = 'bg-yellow-100 text-yellow-800';
        } else if (deployment.status === 'in_progress') {
            statusColor = 'bg-blue-100 text-blue-800';
        }
        
        return `
            <tr class="hover:bg-gray-50">
                <td class="py-3 px-4">
                    <div class="flex items-center">
                        <div class="w-2 h-2 rounded-full bg-pink-500 mr-3"></div>
                        <div>
                            <div class="text-sm font-medium text-gray-900 truncate max-w-xs">${deployment.environment || 'Unknown'}</div>
                            <div class="text-xs text-gray-500">${deployment.deployment_id}</div>
                        </div>
                    </div>
                </td>
                <td class="py-3 px-4">
                    <div class="text-sm text-gray-900">${deployment.creator || 'Unknown'}</div>
                </td>
                <td class="py-3 px-4">
                    <div class="text-sm text-gray-900">${date}</div>
                    <div class="text-xs text-gray-500">${time}</div>
                </td>
                <td class="py-3 px-4">
                    <div class="text-sm text-gray-900">${deployment.status_count}</div>
                </td>
                <td class="py-3 px-4">
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${statusColor}">
                        ${deployment.status}
                    </span>
                </td>
                <td class="py-3 px-4">
                    ${deployment.url ? `<a href="${deployment.url}" target="_blank" class="text-blue-600 hover:text-blue-800 text-sm">View</a>` : '<span class="text-gray-400 text-sm">N/A</span>'}
                </td>
            </tr>
        `;
    }).join('');
    
    // Pagination controls
    const paginationControls = `
        <div class="flex items-center justify-between mt-6">
            <div class="text-sm text-gray-700">
                Showing ${(pagination.page - 1) * pagination.per_page + 1} to ${Math.min(pagination.page * pagination.per_page, pagination.total_deployments)} of ${pagination.total_deployments} deployments
            </div>
            <div class="flex space-x-2">
                ${pagination.has_previous ? `
                    <button onclick="loadDeploymentsList(${pagination.previous_page})" class="px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-md hover:bg-gray-50">
                        Previous
                    </button>
                ` : ''}
                ${pagination.has_next ? `
                    <button onclick="loadDeploymentsList(${pagination.next_page})" class="px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-md hover:bg-gray-50">
                        Next
                    </button>
                ` : ''}
            </div>
        </div>
    `;
    
    content.innerHTML = `
        <div class="space-y-6">
            <!-- Summary -->
            <div class="bg-gray-50 rounded-lg p-4">
                <h3 class="text-lg font-semibold text-gray-800 mb-3">Deployments Summary</h3>
                <div class="grid grid-cols-2 gap-4 text-sm">
                    <div>
                        <span class="text-gray-600">Total Deployments:</span>
                        <span class="font-medium ml-2">${pagination.total_deployments}</span>
                    </div>
                    <div>
                        <span class="text-gray-600">Date Range:</span>
                        <span class="font-medium ml-2">${filters.start_date ? filters.start_date + ' - ' + filters.end_date : 'Last 30 days'}</span>
                    </div>
                </div>
            </div>
            
            <!-- Deployments Table -->
            <div>
                <h3 class="text-lg font-semibold text-gray-800 mb-3">Recent Deployments</h3>
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-white border border-gray-200 rounded-lg">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Environment</th>
                                <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Creator</th>
                                <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status Count</th>
                                <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200">
                            ${deploymentRows}
                        </tbody>
                    </table>
                </div>
                ${paginationControls}
            </div>
        </div>
    `;
}
</script>

<!-- Licensing Slide-over Panel -->
<div id="licensing-slide-over" class="fixed inset-0 overflow-hidden hidden z-50">
    <div class="absolute inset-0 overflow-hidden">
        <div class="absolute inset-0 bg-gray-500 bg-opacity-75 transition-opacity" onclick="closeLicensingAnalysis()"></div>
        
        <div class="fixed inset-y-0 right-0 flex justify-end">
            <div class="w-4/5 h-full transform translate-x-full transition-transform duration-300 ease-in-out" style="width: 80vw;" id="licensing-slide-panel">
                <div class="h-full flex flex-col bg-white shadow-xl">
                    <!-- Header -->
                    <div class="flex-1 flex flex-col overflow-y-auto py-6 px-4 sm:px-6">
                        <div class="flex items-start justify-between">
                            <h2 class="text-lg font-medium text-gray-900">Licensing Analysis</h2>
                            <button onclick="closeLicensingAnalysis()" class="rounded-md text-gray-400 hover:text-gray-500 focus:outline-none">
                                <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                </svg>
                            </button>
                        </div>
                        
                        <!-- Content -->
                        <div id="licensing-content" class="mt-6">
                            <!-- Content will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Vulnerabilities Slide-over Panel - TEMPORARILY DISABLED -->


<!-- Commits Slide-over Panel -->
<div id="commits-slide-over" class="fixed inset-0 overflow-hidden hidden z-50">
    <div class="absolute inset-0 overflow-hidden">
        <div class="absolute inset-0 bg-gray-500 bg-opacity-75 transition-opacity" onclick="closeCommitsList()"></div>
        
        <div class="fixed inset-y-0 right-0 flex justify-end">
            <div class="w-4/5 h-full transform translate-x-full transition-transform duration-300 ease-in-out" style="width: 80vw;" id="commits-slide-panel">
                <div class="h-full flex flex-col bg-white shadow-xl">
                    <!-- Header -->
                    <div class="flex-1 flex flex-col overflow-y-auto py-6 px-4 sm:px-6">
                        <div class="flex items-start justify-between">
                            <h2 class="text-lg font-medium text-gray-900">Repository Commits</h2>
                            <button onclick="closeCommitsList()" class="rounded-md text-gray-400 hover:text-gray-500 focus:outline-none">
                                <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                </svg>
                            </button>
                        </div>
                        
                        <!-- Content -->
                        <div id="commits-content" class="mt-6">
                            <!-- Content will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Releases Slide-over Panel -->
<div id="releases-slide-over" class="fixed inset-0 overflow-hidden hidden z-50">
    <div class="absolute inset-0 overflow-hidden">
        <div class="absolute inset-0 bg-gray-500 bg-opacity-75 transition-opacity" onclick="closeReleasesList()"></div>
        
        <div class="fixed inset-y-0 right-0 flex justify-end">
            <div class="w-4/5 h-full transform translate-x-full transition-transform duration-300 ease-in-out" style="width: 80vw;" id="releases-slide-panel">
                <div class="h-full flex flex-col bg-white shadow-xl">
                    <!-- Header -->
                    <div class="flex-1 flex flex-col overflow-y-auto py-6 px-4 sm:px-6">
                        <div class="flex items-start justify-between">
                            <h2 class="text-lg font-medium text-gray-900">Repository Releases</h2>
                            <button onclick="closeReleasesList()" class="rounded-md text-gray-400 hover:text-gray-500 focus:outline-none">
                                <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                </svg>
                            </button>
                        </div>
                        
                        <!-- Content -->
                        <div id="releases-content" class="mt-6">
                            <!-- Content will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Deployments Slide-over Panel -->
<div id="deployments-slide-over" class="fixed inset-0 overflow-hidden hidden z-50">
    <div class="absolute inset-0 overflow-hidden">
        <div class="absolute inset-0 bg-gray-500 bg-opacity-75 transition-opacity" onclick="closeDeploymentsList()"></div>
        
        <div class="fixed inset-y-0 right-0 flex justify-end">
            <div class="w-4/5 h-full transform translate-x-full transition-transform duration-300 ease-in-out" style="width: 80vw;" id="deployments-slide-panel">
                <div class="h-full flex flex-col bg-white shadow-xl">
                    <!-- Header -->
                    <div class="flex-1 flex flex-col overflow-y-auto py-6 px-4 sm:px-6">
                        <div class="flex items-start justify-between">
                            <h2 class="text-lg font-medium text-gray-900">Repository Deployments</h2>
                            <button onclick="closeDeploymentsList()" class="rounded-md text-gray-400 hover:text-gray-500 focus:outline-none">
                                <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                </svg>
                            </button>
                        </div>
                        
                        <!-- Content -->
                        <div id="deployments-content" class="mt-6">
                            <!-- Content will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- SonarCloud Slide-over Panel -->
<div id="sonarcloud-slide-over" class="fixed inset-0 overflow-hidden hidden z-50">
    <div class="absolute inset-0 overflow-hidden">
        <div class="absolute inset-0 bg-gray-500 bg-opacity-75 transition-opacity" onclick="closeSonarCloudAnalysis()"></div>
        
        <div class="fixed inset-y-0 right-0 flex justify-end">
            <div class="w-4/5 h-full transform translate-x-full transition-transform duration-300 ease-in-out" style="width: 80vw;" id="sonarcloud-slide-panel">
                <div class="h-full flex flex-col bg-white shadow-xl">
                    <!-- Header -->
                    <div class="flex-1 flex flex-col overflow-y-auto py-6 px-4 sm:px-6">
                        <div class="flex items-start justify-between">
                            <h2 class="text-lg font-medium text-gray-900">SonarCloud Analytics</h2>
                            <button onclick="closeSonarCloudAnalysis()" class="rounded-md text-gray-400 hover:text-gray-500 focus:outline-none">
                                <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                </svg>
                            </button>
                        </div>
                        
                        <!-- Content -->
                        <div id="sonarcloud-content" class="mt-6">
                            <!-- Content will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- CodeQL Slide-over Panel -->
<div id="codeql-slide-over" class="fixed inset-0 overflow-hidden hidden z-50">
    <div class="absolute inset-0 overflow-hidden">
        <div class="absolute inset-0 bg-gray-500 bg-opacity-75 transition-opacity" onclick="closeCodeQLAnalysis()"></div>
        
        <div class="fixed inset-y-0 right-0 flex justify-end">
            <div class="w-4/5 h-full transform translate-x-full transition-transform duration-300 ease-in-out" style="width: 80vw;" id="codeql-slide-panel">
                <div class="h-full flex flex-col bg-white shadow-xl">
                    <!-- Header -->
                    <div class="flex-1 flex flex-col overflow-y-auto py-6 px-4 sm:px-6">
                        <div class="flex items-start justify-between">
                            <h2 class="text-lg font-medium text-gray-900">CodeQL Security Analysis</h2>
                            <button onclick="closeCodeQLAnalysis()" class="rounded-md text-gray-400 hover:text-gray-500 focus:outline-none">
                                <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                </svg>
                            </button>
                        </div>
                        
                        <!-- Content -->
                        <div id="codeql-content" class="mt-6">
                            <!-- Content will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    /* Custom scrollbar for tooltip */
    .custom-scrollbar::-webkit-scrollbar {
        width: 6px;
    }
    
    .custom-scrollbar::-webkit-scrollbar-track {
        background: #374151;
        border-radius: 3px;
    }
    
    .custom-scrollbar::-webkit-scrollbar-thumb {
        background: #6b7280;
        border-radius: 3px;
    }
    
    .custom-scrollbar::-webkit-scrollbar-thumb:hover {
        background: #9ca3af;
    }
    
    /* Tooltip positioning improvements */
    .group:hover .group-hover\:opacity-100 {
        opacity: 1;
    }
    
    /* Ensure tooltip doesn't go off-screen */
    @media (max-width: 640px) {
        .group:hover .group-hover\:opacity-100 {
            left: auto !important;
            right: 0 !important;
        }
    }
</style>

{% endblock content %} 